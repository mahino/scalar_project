<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Payload Scaler</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;500;600;700&display=swap');
        
        * { box-sizing: border-box; }
        
        :root {
            --bg-dark: #0a0a1a;
            --bg-card: #12122a;
            --bg-sidebar: #0e0e20;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #1e293b;
        }
        
        body {
            background: var(--bg-dark);
            min-height: 100vh;
            margin: 0;
            font-family: 'Space Grotesk', system-ui, sans-serif;
            display: flex;
            color: var(--text-primary);
        }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-header h4 {
            color: var(--text-primary);
            margin: 0;
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-header h4 i {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            padding: 10px;
            border-radius: 12px;
            font-size: 20px;
        }
        
        /* Main Navigation Tabs */
        .main-nav {
            padding: 20px;
        }
        
        .nav-section {
            margin-bottom: 8px;
        }
        
        .nav-btn {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            text-align: left;
        }
        
        .nav-btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
        }
        
        .nav-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }
        
        .nav-btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .nav-btn-secondary:hover {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }
        
        .nav-btn-secondary.active {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .nav-btn i {
            font-size: 18px;
        }
        
        /* API List in Sidebar */
        .api-list-section {
            flex: 1;
            padding: 20px;
            border-top: 1px solid var(--border-color);
            overflow-y: auto;
        }
        
        .api-list-section h6 {
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .api-item {
            padding: 12px 14px;
            background: rgba(255,255,255,0.02);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .api-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
        }
        
        .api-item.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
        }
        
        .api-item .api-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            word-break: break-all;
        }
        
        .api-item .api-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .api-item .api-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .api-item .api-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .api-item:hover .api-actions {
            opacity: 1;
        }
        
        .api-item .api-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .api-item .btn-use {
            background: var(--accent-green);
            color: white;
        }
        
        .api-item .btn-history {
            background: var(--accent-blue);
            color: white;
        }
        
        .api-item .btn-delete {
            background: var(--accent-red);
            color: white;
        }
        
        .no-apis {
            text-align: center;
            color: var(--text-secondary);
            padding: 30px 20px;
        }
        
        .no-apis i {
            font-size: 40px;
            opacity: 0.5;
            display: block;
            margin-bottom: 12px;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 300px;
            flex: 1;
            padding: 30px 40px;
            min-height: 100vh;
        }
        
        .content-header {
            margin-bottom: 30px;
        }
        
        .content-header h2 {
            color: var(--text-primary);
            font-weight: 700;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .content-header h2 .badge {
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .content-header p {
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Cards */
        .card-dark {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        
        .card-dark h5 {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-dark h5 i {
            color: var(--accent-blue);
        }
        
        /* Forms */
        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            margin-bottom: 8px;
        }
        
        .form-control, .form-select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 12px 16px;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(0, 0, 0, 0.4);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            color: var(--text-primary);
        }
        
        .form-control::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        
        textarea.form-control {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* Entity Tree */
        .entity-tree {
            font-family: 'JetBrains Mono', monospace;
        }
        
        .tree-node {
            margin-bottom: 8px;
        }
        
        .tree-node-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            gap: 10px;
        }
        
        .tree-node-header .entity-name {
            flex: 1;
        }
        
        .tree-node-header .exclude-btn {
            margin-left: auto;
            padding: 4px 10px;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .tree-node-header:hover .exclude-btn {
            opacity: 1;
        }
        
        .tree-node-header:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
        }
        
        .tree-node-header.expanded {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
            border-color: var(--accent-blue);
        }
        
        .tree-toggle {
            width: 24px;
            margin-right: 10px;
            transition: transform 0.2s;
            color: var(--text-secondary);
        }
        
        .tree-toggle.expanded {
            transform: rotate(90deg);
            color: var(--accent-blue);
        }
        
        .entity-name {
            font-weight: 600;
            flex-grow: 1;
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .entity-count-badge {
            background: var(--accent-green);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .tree-children {
            display: none;
            margin-left: 35px;
            margin-top: 8px;
            padding-left: 15px;
            border-left: 2px solid var(--border-color);
        }
        
        .tree-children.show {
            display: block;
        }
        
        .entity-details {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            margin-top: 10px;
            margin-left: 35px;
        }
        
        .entity-details .form-control {
            width: 100px;
        }
        
        /* Rules Section */
        .rule-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .rule-item.default-rule {
            border-left: 3px solid var(--text-secondary);
            opacity: 0.7;
        }
        
        .rule-item.existing-rule {
            border-left: 3px solid #0dcaf0;
            background: rgba(13, 202, 240, 0.05);
        }
        
        .rule-item.new-rule {
            border-left: 3px solid var(--accent-green);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .rules-summary {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .rules-summary-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .rules-summary-item.existing {
            background: rgba(13, 202, 240, 0.15);
            color: #0dcaf0;
        }
        
        .rules-summary-item.new {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-green);
        }
        
        .rules-summary-item.custom {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }
        
        .rules-summary-item.default {
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-secondary);
        }
        
        .rule-type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            margin-right: 8px;
        }
        
        .rule-delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--accent-red);
            cursor: pointer;
            opacity: 0.7;
        }
        
        .rule-delete-btn:hover {
            opacity: 1;
        }
        
        /* Collapsible Sections */
        .collapsible-section {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
        }
        
        .collapsible-header {
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.02);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.04);
        }
        
        .collapsible-header h6 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }
        
        .collapsible-content {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
        
        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
        }
        
        .btn-success {
            background: var(--accent-green);
            border: none;
            font-weight: 600;
        }
        
        .btn-outline-secondary {
            border-color: var(--border-color);
            color: var(--text-secondary);
        }
        
        .btn-outline-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }
        
        /* JSON Preview */
        .json-preview {
            background: #0d0d1a;
            color: #a5f3fc;
            padding: 20px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
        }
        
        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 80px 40px;
        }
        
        .welcome-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 20px 50px rgba(59, 130, 246, 0.3);
        }
        
        .welcome-icon i {
            font-size: 50px;
            color: white;
        }
        
        .welcome-screen h3 {
            color: var(--text-primary);
            margin-bottom: 16px;
            font-weight: 700;
        }
        
        .welcome-screen p {
            color: var(--text-secondary);
            max-width: 500px;
            margin: 0 auto 40px;
            line-height: 1.7;
        }
        
        .welcome-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
        }
        
        .welcome-actions .btn {
            padding: 16px 32px;
            font-size: 15px;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast-custom {
            background: var(--accent-green);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes shrink {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .toast-undo {
            position: relative;
            overflow: hidden;
            padding-right: 100px;
            min-width: 350px;
        }
        
        .undo-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .undo-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }
        
        .undo-timer {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(255, 255, 255, 0.5);
            width: 100%;
            z-index: 1;
            pointer-events: none;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-spinner {
            background: var(--bg-card);
            padding: 40px 60px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .loading-spinner p {
            margin-top: 16px;
            margin-bottom: 0;
            color: var(--text-secondary);
        }
        
        /* Step Indicator */
        .step-indicator {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .step.active {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        .step.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent-green);
        }
        
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: currentColor;
            color: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .step.active .step-number, .step.completed .step-number {
            background: currentColor;
        }
        
        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            color: var(--text-secondary);
            font-size: 13px;
        }
        
        .info-box i {
            color: var(--accent-blue);
            font-size: 18px;
            margin-top: 2px;
        }
        
        /* Excluded Entities */
        .excluded-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 14px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .excluded-path {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-red);
            font-size: 12px;
        }
        
        .restore-btn {
            background: var(--accent-green);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 11px;
            cursor: pointer;
        }
        
        /* Sections visibility */
        .section-hidden {
            display: none !important;
        }
        
        /* ============================================
           PERFORMANCE TESTER STYLES
           ============================================ */
        
        .perf-controls {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .perf-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .perf-control-group label {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .perf-grid-container {
            display: grid;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            min-height: 500px;
        }
        
        .perf-tabs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .perf-tab-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .perf-tab-card.connected {
            border-color: var(--accent-green);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
        }
        
        .perf-tab-card.disconnected {
            border-color: var(--accent-red);
            opacity: 0.6;
        }
        
        .perf-tab-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .perf-tab-id {
            font-weight: 600;
            color: var(--accent-blue);
        }
        
        .perf-tab-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .perf-tab-status.online {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }
        
        .perf-tab-status.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }
        
        .perf-tab-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            font-size: 11px;
        }
        
        .perf-tab-metric {
            text-align: center;
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        .perf-tab-metric-value {
            font-weight: 600;
            color: #fff;
        }
        
        .perf-tab-metric-label {
            color: var(--text-secondary);
            font-size: 10px;
        }
        
        .perf-grid-2 { grid-template-columns: repeat(2, 1fr); }
        .perf-grid-3 { grid-template-columns: repeat(3, 1fr); }
        .perf-grid-4 { grid-template-columns: repeat(4, 1fr); }
        .perf-grid-5 { grid-template-columns: repeat(4, 1fr); }
        .perf-grid-6 { grid-template-columns: repeat(3, 1fr); }
        .perf-grid-8 { grid-template-columns: repeat(4, 1fr); }
        .perf-grid-9 { grid-template-columns: repeat(3, 1fr); }
        .perf-grid-12 { grid-template-columns: repeat(4, 1fr); }
        .perf-grid-16 { grid-template-columns: repeat(4, 1fr); }
        
        .perf-user-window {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }
        
        .perf-user-window.healthy { border-color: var(--accent-green); }
        .perf-user-window.warning { border-color: var(--accent-orange); }
        .perf-user-window.critical { border-color: var(--accent-red); }
        
        .perf-user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
        }
        
        .perf-user-id {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .perf-user-id .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-green);
        }
        
        .perf-user-id .status-dot.warning { background: var(--accent-orange); }
        .perf-user-id .status-dot.critical { background: var(--accent-red); }
        
        .perf-user-stats {
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            gap: 10px;
        }
        
        .perf-user-iframe {
            flex: 1;
            width: 100%;
            border: none;
            background: white;
        }
        
        .perf-metrics-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
        }
        
        .perf-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .perf-metric-card {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }
        
        .perf-metric-card.good { border-color: var(--accent-green); background: rgba(16, 185, 129, 0.1); }
        .perf-metric-card.warning { border-color: var(--accent-orange); background: rgba(245, 158, 11, 0.1); }
        .perf-metric-card.bad { border-color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        
        .perf-metric-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .perf-metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        
        .perf-sync-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 20px;
            font-size: 12px;
            color: var(--accent-blue);
        }
        
        .perf-sync-indicator.syncing {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .perf-mode-toggle {
            display: flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .perf-mode-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .perf-mode-btn.active {
            background: var(--accent-blue);
            color: white;
        }
        
        .perf-mode-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .perf-event-log {
            max-height: 200px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
        }
        
        .perf-event-item {
            display: flex;
            gap: 10px;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .perf-event-time {
            color: var(--text-secondary);
            min-width: 80px;
        }
        
        .perf-event-type {
            color: var(--accent-blue);
            min-width: 60px;
        }
        
        .perf-event-detail {
            color: var(--text-primary);
        }
        
        .perf-url-input {
            flex: 1;
            min-width: 300px;
        }
        
        /* Main Parent Window */
        .perf-main-window-container {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 12px;
            border: 2px solid var(--accent-blue);
        }
        
        .perf-main-window {
            background: var(--bg-card);
            border: 2px solid var(--accent-blue);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }
        
        .perf-main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .perf-main-url {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            opacity: 0.9;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .perf-main-iframe-wrapper {
            position: relative;
            height: 450px;
            background: white;
        }
        
        .perf-main-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .perf-interaction-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            z-index: 10;
            /* Transparent but captures events */
        }
        
        .perf-interaction-overlay.disabled {
            display: none;
        }
        
        .perf-click-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            background: rgba(59, 130, 246, 0.3);
            pointer-events: none;
            animation: clickPulse 0.5s ease-out forwards;
            transform: translate(-50%, -50%);
        }
        
        @keyframes clickPulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        .perf-cursor-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            background: var(--accent-blue);
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            opacity: 0.7;
            transform: translate(-50%, -50%);
            transition: left 0.05s, top 0.05s;
        }
        
        /* Diff Modal Styles */
        .diff-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .diff-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .diff-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .diff-modal-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
        }
        
        .btn-close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .btn-close-modal:hover {
            color: var(--accent-red);
        }
        
        .diff-modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }
        
        .diff-info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent-blue);
        }
        
        .rules-merge-summary {
            display: flex;
            gap: 24px;
            margin-bottom: 20px;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            justify-content: center;
        }
        
        .merge-stat {
            text-align: center;
        }
        
        .merge-stat-value {
            display: block;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .merge-stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .diff-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .diff-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 16px;
        }
        
        .diff-section h6 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .diff-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: start;
        }
        
        .diff-old, .diff-new {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 12px;
            overflow: hidden;
        }
        
        .diff-old {
            border-left: 3px solid var(--accent-red);
        }
        
        .diff-new {
            border-left: 3px solid var(--accent-green);
        }
        
        .diff-label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .diff-old .diff-label { color: var(--accent-red); }
        .diff-new .diff-label { color: var(--accent-green); }
        
        .diff-old pre, .diff-new pre {
            margin: 0;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .diff-arrow {
            display: flex;
            align-items: center;
            color: var(--text-secondary);
            font-size: 20px;
        }
        
        .entity-changes {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .added-entities, .removed-entities {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .added-entities code, .removed-entities code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .no-changes {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
        }
        
        .no-changes i {
            font-size: 24px;
        }
        
        .diff-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* History Modal Styles */
        .history-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .history-item {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.2s;
        }
        
        .history-item:hover {
            border-color: var(--accent-blue);
        }
        
        .history-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .history-item-date {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .history-item-meta {
            color: var(--text-secondary);
            font-size: 12px;
            display: flex;
            gap: 12px;
        }
        
        .history-item-actions {
            display: flex;
            gap: 8px;
        }
        
        .history-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .history-empty i {
            font-size: 40px;
            opacity: 0.5;
            display: block;
            margin-bottom: 12px;
        }
        
        .entity-exists-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.4);
            border-radius: 8px;
            padding: 10px 14px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--accent-orange);
            font-size: 13px;
        }
        
        .entity-exists-warning i {
            font-size: 16px;
        }
        
        /* App Switcher Styles */
        .app-switcher {
            margin-bottom: 0;
        }
        
        .app-switcher-tabs {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px;
            border-radius: 12px;
        }
        
        .app-switcher-tab {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .app-switcher-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .app-switcher-tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        .app-switcher-tab i {
            font-size: 20px;
        }
        
        .config-panel {
            animation: fadeSlideIn 0.3s ease;
        }
        
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        .entity-select-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }
        
        .entity-select-card {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .entity-select-card:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .entity-select-card.selected {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--accent-blue);
        }
        
        .entity-select-card .entity-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .entity-select-card .entity-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* Blueprint Type Toggle */
        .blueprint-type-toggle {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px;
            border-radius: 10px;
            width: fit-content;
        }
        
        .bp-type-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        
        .bp-type-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .bp-type-btn.active {
            background: var(--accent-blue);
            color: white;
        }
        
        /* Hierarchy Container */
        .hierarchy-container {
            margin: 20px 0;
        }
        
        .hierarchy-main-entity {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(139, 92, 246, 0.1));
            border: 2px solid var(--accent-blue);
            border-radius: 16px;
            padding: 20px;
        }
        
        .hierarchy-entity-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .hierarchy-entity-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .hierarchy-entity-info {
            flex: 1;
        }
        
        .hierarchy-entity-name {
            display: block;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .hierarchy-entity-path {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .hierarchy-entity-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .hierarchy-entity-input input {
            width: 70px;
            text-align: center;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .hierarchy-entity-input input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: rgba(0, 0, 0, 0.2);
        }
        
        .hierarchy-entity-input.disabled-input {
            opacity: 0.7;
        }
        
        .hierarchy-entity-input.disabled-input::after {
            content: 'Single VM';
            font-size: 10px;
            color: var(--text-secondary);
            margin-left: 8px;
            padding: 2px 6px;
            background: rgba(139, 92, 246, 0.2);
            border-radius: 4px;
        }
        
        .count-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .count-btn:hover:not(:disabled) {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .count-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .linked-entities-info {
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            font-size: 12px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Sub-entities */
        .hierarchy-sub-entities {
            margin-top: 20px;
            position: relative;
            padding-left: 30px;
        }
        
        .sub-entity-connector {
            position: absolute;
            left: 25px;
            top: -15px;
            width: 2px;
            height: calc(100% + 15px);
            background: linear-gradient(to bottom, var(--accent-blue), var(--accent-purple));
            opacity: 0.3;
        }
        
        .sub-entity-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .sub-entity-header {
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sub-entity-header span {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sub-entity-header .header-name {
            flex: 1;
            padding-left: 40px;
        }
        
        .sub-entity-header .header-count {
            width: 70px;
            text-align: right;
        }
        
        .sub-entity-card {
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.15s ease;
        }
        
        .sub-entity-card:last-child {
            border-bottom: none;
        }
        
        .sub-entity-card:hover {
            background: rgba(59, 130, 246, 0.08);
        }
        
        .sub-entity-card.linked-entity {
            background: rgba(139, 92, 246, 0.05);
        }
        
        .sub-entity-card.linked-entity:hover {
            background: rgba(139, 92, 246, 0.1);
        }
        
        /* Nested Entity Configuration Styles */
        .nested-entities-config {
            background: rgba(59, 130, 246, 0.05);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 8px;
            padding: 16px;
        }
        
        .nested-level-section {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .nested-level-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: background 0.2s;
            user-select: none;
        }
        
        .nested-level-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nested-level-header i {
            transition: transform 0.2s;
        }
        
        .nested-level-header.collapsed i.bi-chevron-down {
            transform: rotate(-90deg);
        }
        
        .nested-level-content {
            padding: 12px 16px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .nested-level-content.hidden {
            display: none;
        }
        
        .nested-entity-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .nested-entity-group label {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .nested-entity-group input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 6px 10px;
            color: var(--text-primary);
            font-size: 13px;
        }
        
        .nested-entity-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(0, 0, 0, 0.4);
        }
        
        .sub-entity-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: white;
            flex-shrink: 0;
        }
        
        .sub-entity-details {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .sub-entity-name {
            font-weight: 500;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .sub-entity-count {
            flex-shrink: 0;
            width: 70px;
            text-align: right;
        }
        
        .sub-entity-count input {
            width: 55px;
            padding: 6px 8px;
            text-align: center;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            appearance: textfield;
            -moz-appearance: textfield;
        }
        
        .sub-entity-count input::-webkit-outer-spin-button,
        .sub-entity-count input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .sub-entity-count input:focus {
            border-color: var(--accent-blue);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .sub-entity-count input:hover {
            border-color: var(--accent-blue);
        }
        
        /* Entity Relationship Box */
        .entity-relationship-box {
            margin-top: 24px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .entity-relationship-box h6 {
            margin: 0 0 12px 0;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .relationship-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .rel-node {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        
        .rel-service { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .rel-substrate { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .rel-deployment { background: linear-gradient(135deg, #10b981, #047857); }
        .rel-profile { background: linear-gradient(135deg, #ec4899, #be185d); }
        
        .rel-arrow {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .relationship-notes {
            margin-top: 12px;
            text-align: center;
            color: var(--text-secondary);
        }
        
        /* Linked entity badge */
        .linked-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 4px;
            font-size: 10px;
            color: #a78bfa;
            font-weight: 500;
        }
        
        /* Calculated entity badge */
        .calculated-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            font-size: 12px;
            color: #60a5fa;
            font-weight: 600;
        }
        
        .calculated-badge span {
            font-size: 14px;
            font-weight: 700;
            color: #93c5fd;
        }
        
        .linked-entity {
            opacity: 0.85;
        }
        
        .linked-entity:hover {
            opacity: 1;
        }
        
        /* App Profile Options */
        .app-profile-options {
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 16px;
        }
        
        .app-profile-options h6 {
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .app-profile-options h6 i {
            color: #8b5cf6;
        }
        
        .profile-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .profile-option-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .profile-option-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
        }
        
        .profile-option-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .profile-option-header i {
            font-size: 16px;
        }
        
        .profile-option-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.3;
        }
        
        .profile-option-input {
            margin-top: auto;
        }
        
        .profile-option-input input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-darker);
            color: var(--text-primary);
            font-size: 13px;
            text-align: center;
        }
        
        .profile-option-input input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);
        }
        
        /* Enhanced Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
            width: 100%;
        }
        
        .searchable-dropdown-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }
        
        .searchable-dropdown-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .searchable-dropdown-input::placeholder {
            color: var(--text-secondary);
        }
        
        .searchable-dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 250px; /* ~10 items at 25px each */
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .searchable-dropdown-list.show {
            display: block;
        }
        
        .searchable-dropdown-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            font-size: 14px;
            transition: background-color 0.2s ease;
        }
        
        .searchable-dropdown-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .searchable-dropdown-item.selected {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-blue);
        }
        
        .searchable-dropdown-item:last-child {
            border-bottom: none;
        }
        
        .searchable-dropdown-no-results {
            padding: 12px;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        .searchable-dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }
        
        .searchable-dropdown.open .searchable-dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
        }
        
        /* Custom scrollbar for dropdown */
        .searchable-dropdown-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .searchable-dropdown-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .searchable-dropdown-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .searchable-dropdown-list::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Processing...</p>
        </div>
            </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-diagram-3"></i> Payload Scaler</h4>
                </div>
        
        <div class="main-nav">
            <div class="nav-section">
                <button class="nav-btn nav-btn-primary" onclick="showSection('generateRules')">
                    <i class="bi bi-plus-circle"></i>
                    <span>Generate New Payload Rules</span>
                </button>
            </div>
            <div class="nav-section">
                <button class="nav-btn nav-btn-secondary" id="createEntitiesBtn" onclick="showSection('createEntities')">
                    <i class="bi bi-layers"></i>
                    <span>Create Entities</span>
                </button>
            </div>
            <div class="nav-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button class="nav-btn nav-btn-secondary" id="perfTesterBtn" onclick="showSection('perfTester')" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2)); border-color: var(--accent-orange);">
                    <i class="bi bi-speedometer2" style="color: var(--accent-orange);"></i>
                    <span>Performance Tester</span>
                </button>
                <button class="nav-btn nav-btn-secondary" id="playwrightBtn" onclick="showSection('playwright')" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(6, 182, 212, 0.2)); border-color: var(--accent-purple); margin-top: 8px;">
                    <i class="bi bi-robot" style="color: var(--accent-purple);"></i>
                    <span>Browser Automation</span>
                </button>
            </div>
        </div>

        <div class="api-list-section">
            <h6>Saved Entities</h6>
            <div id="apiList">
                <div class="no-apis">
                    <i class="bi bi-inbox"></i>
                    <div>No saved entities yet</div>
                    <small>Create rules to get started</small>
                </div>
            </div>
        </div>
            </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Welcome Screen -->
        <div id="welcomeSection" class="section section-hidden">
            <div class="card-dark">
                <div class="welcome-screen">
                    <div class="welcome-icon">
                        <i class="bi bi-lightning-charge"></i>
                </div>
                    <h3>Welcome to API Payload Scaler</h3>
                    <p>Create reusable transformation rules for your API payloads, then generate scaled payloads with custom entity counts. Rules are saved separately from entity counts for maximum flexibility.</p>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" onclick="showSection('generateRules')">
                            <i class="bi bi-plus-circle me-2"></i> Generate New Rules
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showSection('createEntities')">
                            <i class="bi bi-layers me-2"></i> Create Entities
                </button>
                    </div>
                </div>
            </div>
            </div>

        <!-- Section 1: Generate New Payload Rules -->
        <div id="generateRulesSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-gear-wide-connected"></i>
                    Generate New Payload Rules
                    <span class="badge bg-primary">Section 1</span>
                </h2>
                <p>Define transformation rules for an API. Entity counts are temporary and won't be saved.</p>
            </div>
            
            <!-- App Type Switcher for Rules -->
            <div class="card-dark">
                <div class="app-switcher">
                    <div class="app-switcher-tabs">
                        <button class="app-switcher-tab active" data-type="blueprint" onclick="switchRulesAppType('blueprint')">
                            <i class="bi bi-diagram-3"></i>
                            <span>Blueprint</span>
                        </button>
                        <button class="app-switcher-tab" data-type="runbook" onclick="switchRulesAppType('runbook')">
                            <i class="bi bi-play-circle"></i>
                            <span>Runbook</span>
                        </button>
                    </div>
                </div>
                <!-- Hidden select for compatibility -->
                <select class="form-select" id="apiTypeSelect" style="display: none;">
                    <option value="blueprint">Blueprint</option>
                    <option value="app">App</option>
                    <option value="runbook">Runbook</option>
                </select>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <span class="step-number">1</span>
                    <span>Input Payload</span>
                </div>
                <div class="step" id="step2">
                    <span class="step-number">2</span>
                    <span>Configure Entities</span>
                </div>
                <div class="step" id="step3">
                    <span class="step-number">3</span>
                    <span>Preview & Save</span>
                </div>
            </div>
            
            <!-- Step 1: Input Payload -->
            <div id="rulesStep1">
                <!-- Blueprint Payload Input -->
                <div id="rulesBlueprintInput" class="card-dark">
                    <h5><i class="bi bi-diagram-3"></i> Blueprint Payload</h5>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        Paste a sample blueprint JSON payload to analyze its structure and create scaling rules.
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Sample Blueprint JSON</label>
                        <textarea class="form-control" id="rulesPayloadInput" rows="12" 
                                  placeholder='Paste your blueprint JSON payload here...
Example structure:
{
  "spec": {
    "name": "MyBlueprint",
    "resources": {
      "service_definition_list": [...],
      "substrate_definition_list": [...],
      "app_profile_list": [...]
    }
  }
}'></textarea>
                        </div>
                    
                    <button class="btn btn-primary btn-lg" onclick="analyzePayloadForRules()">
                        <i class="bi bi-search me-2"></i> Analyze Blueprint
                    </button>
                        </div>
                
                <!-- Runbook Payload Input -->
                <div id="rulesRunbookInput" class="card-dark section-hidden">
                    <h5><i class="bi bi-play-circle"></i> Runbook Payload</h5>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        Paste a sample runbook JSON payload to analyze its structure and create scaling rules.
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Sample Runbook JSON</label>
                        <textarea class="form-control" id="rulesRunbookPayloadInput" rows="12" 
                                  placeholder='Paste your runbook JSON payload here...
Example structure:
{
  "spec": {
    "name": "MyRunbook",
    "resources": {
      "runbook": {
        "task_definition_list": [...]
      },
      "endpoint_definition_list": [...],
      "credential_definition_list": [...]
    }
  }
}'></textarea>
                    </div>
                    
                    <button class="btn btn-success btn-lg" onclick="analyzeRunbookPayload()">
                        <i class="bi bi-search me-2"></i> Analyze Runbook
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Configure Entities -->
            <div id="rulesStep2" class="section-hidden">
                <div class="info-box">
                    <i class="bi bi-info-circle"></i>
                    <div>
                        <strong>Temporary Entity Counts:</strong> Set counts below for preview only. 
                        These values are NOT saved with the rules. When using these rules later, 
                        you'll specify counts at generation time.
                    </div>
                </div>
                
                <!-- Blueprint Entity Hierarchy (shown for blueprints) -->
                <div id="rulesBlueprintHierarchy" class="card-dark">
                    <h5><i class="bi bi-diagram-2"></i> Blueprint Entity Hierarchy</h5>
                    
                    <!-- Blueprint Type Toggle -->
                    <div class="blueprint-type-toggle mb-4">
                        <button class="bp-type-btn active" data-bptype="multi_vm" onclick="setRulesBlueprintType('multi_vm')">
                            <i class="bi bi-hdd-stack"></i> Multi VM
                        </button>
                        <button class="bp-type-btn" data-bptype="single_vm" onclick="setRulesBlueprintType('single_vm')">
                            <i class="bi bi-hdd"></i> Single VM
                        </button>
                    </div>
                    
                    <!-- Blueprint Entity Hierarchy -->
                    <div class="hierarchy-container">
                        <!-- App Profiles (Primary) -->
                        <div class="hierarchy-main-entity">
                            <div class="hierarchy-entity-header">
                                <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="hierarchy-entity-info">
                                    <span class="hierarchy-entity-name">App Profiles</span>
                                    <span class="hierarchy-entity-path">spec.resources.app_profile_list</span>
                                </div>
                                <div class="hierarchy-entity-input">
                                    <button class="count-btn" onclick="adjustRulesAppProfileCount(-1)">-</button>
                                    <input type="number" id="rulesAppProfileCountInput" value="1" min="1" max="10" 
                                           onchange="onRulesAppProfileCountChange(this.value)">
                                    <button class="count-btn" onclick="adjustRulesAppProfileCount(1)">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deployments per Profile -->
                        <div class="hierarchy-main-entity" style="margin-top: 16px;">
                            <div class="hierarchy-entity-header">
                                <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                    <i class="bi bi-rocket-takeoff"></i>
                                </div>
                                <div class="hierarchy-entity-info">
                                    <span class="hierarchy-entity-name">Services</span>
                                    <span class="hierarchy-entity-path">service_definition_list</span>
                                </div>
                                <div class="hierarchy-entity-input">
                                    <button class="count-btn" onclick="adjustRulesServiceCount(-1)">-</button>
                                    <input type="number" id="rulesServiceCountInput" value="1" min="1" max="50" 
                                           onchange="onRulesServiceCountChange(this.value)">
                                    <button class="count-btn" onclick="adjustRulesServiceCount(1)">+</button>
                                </div>
                            </div>
                            
                            <!-- Linked Info -->
                            <div class="linked-entities-info">
                                <i class="bi bi-link-45deg"></i>
                                <span>Auto-calculated: Substrates & Packages = App Profiles  Services</span>
                            </div>
                        </div>
                        
                        <!-- Sub-entities -->
                        <div id="rulesServiceSubEntities" class="hierarchy-sub-entities">
                            <div class="sub-entity-connector"></div>
                            
                            <div class="sub-entity-grid">
                                <div class="sub-entity-header">
                                    <span class="header-name">Entity Name</span>
                                    <span class="header-count">Count</span>
                                </div>
                                <!-- Credentials -->
                                <div class="sub-entity-card" data-entity="credential_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                        <i class="bi bi-key"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Credentials</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="1" max="10" id="rulesCredentialCount"
                                               onchange="updateRulesSubEntityCount('credential_definition_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Entity Relationship Diagram -->
                    <div class="entity-relationship-box">
                        <h6><i class="bi bi-diagram-3"></i> Entity Relationships</h6>
                        <div class="relationship-diagram">
                            <div class="rel-node rel-profile">App Profile</div>
                            <div class="rel-arrow"></div>
                            <div class="rel-node rel-deployment">Deployment</div>
                            <div class="rel-arrow"></div>
                            <div class="rel-node rel-substrate">Substrate/Package</div>
                        </div>
                        <div class="relationship-notes">
                            <small><i class="bi bi-info-circle"></i> Total Substrates/Packages = App Profiles  Deployments per Profile</small>
                        </div>
                    </div>
                    
                    <!-- App Profile Options -->
                    <div class="app-profile-options mt-4">
                        <h6><i class="bi bi-sliders"></i> App Profile Options <span class="badge bg-secondary">Optional</span></h6>
                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                            Configure optional features for each app profile. Set to 0 to exclude from generated payload.
                        </p>
                        
                        <div class="profile-options-grid">
                            <!-- Profile Actions -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-lightning-charge" style="color: #f59e0b;"></i>
                                    <span>Profile Actions</span>
                                </div>
                                <div class="profile-option-desc">Custom actions (scale in/out, restart, etc.)</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="20" id="rulesProfileActionCount"
                                           onchange="updateRulesProfileOption('action_list', this.value)">
                    </div>
                </div>
                
                            <!-- Snapshot Configs -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-camera" style="color: #8b5cf6;"></i>
                                    <span>Snapshot Configs</span>
                    </div>
                                <div class="profile-option-desc">Snapshot configuration policies</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesSnapshotConfigCount"
                                           onchange="updateRulesProfileOption('snapshot_config_list', this.value)">
                    </div>
                </div>
                
                            <!-- Restore Configs -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-arrow-counterclockwise" style="color: #10b981;"></i>
                                    <span>Restore Configs</span>
                                </div>
                                <div class="profile-option-desc">Restore configuration policies</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesRestoreConfigCount"
                                           onchange="updateRulesProfileOption('restore_config_list', this.value)">
                                </div>
                            </div>
                            
                            <!-- Patch List -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-bandaid" style="color: #ec4899;"></i>
                                    <span>Patch Configs</span>
                                </div>
                                <div class="profile-option-desc">Configuration patch definitions</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesPatchListCount"
                                           onchange="updateRulesProfileOption('patch_list', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Runbook Entity Hierarchy (shown for runbooks) -->
                <div id="rulesRunbookHierarchy" class="card-dark section-hidden">
                    <h5><i class="bi bi-play-circle"></i> Runbook Entity Hierarchy</h5>
                    
                    <!-- Task Execution Toggle -->
                    <div class="blueprint-type-toggle mb-4">
                        <button class="bp-type-btn active" data-exectype="parallel" onclick="setRulesTaskExecution('parallel')">
                            <i class="bi bi-arrows-expand"></i> Parallel
                    </button>
                        <button class="bp-type-btn" data-exectype="series" onclick="setRulesTaskExecution('series')">
                            <i class="bi bi-arrow-down"></i> Series
                        </button>
                </div>
                    
                    <div class="hierarchy-container">
                        <div class="sub-entity-grid">
                            <div class="sub-entity-header">
                                <span class="header-name">Entity Name</span>
                                <span class="header-count">Count</span>
                    </div>
                            <!-- Tasks -->
                            <div class="sub-entity-card" data-entity="task_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                    <i class="bi bi-list-task"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Tasks</span>
                                </div>
                                <div class="sub-entity-count">
                                    <input type="number" value="1" min="1" max="50" id="rulesTaskCount"
                                           onchange="updateRulesRunbookEntityCount('task_definition_list', this.value)">
                                </div>
                            </div>
                            <!-- Endpoints -->
                            <div class="sub-entity-card" data-entity="endpoint_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                    <i class="bi bi-broadcast-pin"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Endpoints</span>
                                </div>
                                <div class="sub-entity-count">
                                    <input type="number" value="1" min="0" max="20" id="rulesEndpointCount"
                                           onchange="updateRulesRunbookEntityCount('endpoint_definition_list', this.value)">
                                </div>
                            </div>
                            <!-- Credentials -->
                            <div class="sub-entity-card" data-entity="credential_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                    <i class="bi bi-key"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Credentials</span>
                                </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="10" id="rulesRunbookCredentialCount"
                                           onchange="updateRulesRunbookEntityCount('credential_definition_list', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transformation Rules (always visible) -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-sliders text-warning"></i> Transformation Rules 
                            <span class="badge bg-warning text-dark" id="rulesRulesBadge">0</span>
                        </h5>
                        <button class="btn btn-sm btn-warning" onclick="showAddRuleForm('rules')">
                            <i class="bi bi-plus me-1"></i> Add Rule
                        </button>
                    </div>
                        <div id="rulesAddRuleForm" style="display: none;"></div>
                        <div id="rulesRulesList"></div>
                    </div>
                
                <!-- Hidden containers for legacy compatibility -->
                <div style="display: none;">
                    <div id="rulesEntitiesBadge">0</div>
                    <div id="rulesEntitiesTree"></div>
                    <div id="rulesExcludedSection"><div id="rulesExcludedBadge">0</div><div id="rulesExcludedList"></div></div>
            </div>

                <!-- Actions -->
                <div class="card-dark">
                    <div class="d-flex gap-3">
                        <button class="btn btn-primary" onclick="previewRulesPayload()">
                            <i class="bi bi-eye me-2"></i> Preview Payload
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToRulesStep(1)">
                            <i class="bi bi-arrow-left me-2"></i> Back
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Preview & Save -->
            <div id="rulesStep3" class="section-hidden">
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-code-square"></i> Payload Preview</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="copyPreviewPayload()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadPreviewPayload()">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div class="json-preview" id="rulesPreviewPayload"></div>
                </div>
                
                <div class="card-dark">
                    <div class="info-box" style="margin-bottom: 20px;">
                        <i class="bi bi-check-circle"></i>
                        <div>
                            <strong>Ready to save!</strong> Only the transformation rules will be saved. 
                            Entity counts are temporary and will need to be specified each time you generate a payload.
                        </div>
                    </div>
                    
                    <!-- Auto-save to Blueprint Entity -->
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Auto-save to Blueprint:</strong> Rules will be automatically saved to the "blueprint" entity configuration for immediate use in payload generation.
                        </div>
                    </div>
                    
                    <!-- Task Execution option for Runbooks -->
                    <div id="rulesTaskExecutionContainer" style="display:none; margin-bottom: 20px;">
                        <label class="form-label"><i class="bi bi-diagram-3"></i> Task Execution Mode</label>
                        <select class="form-select" id="rulesTaskExecutionSelect" style="max-width: 300px;">
                            <option value="parallel">Parallel (all tasks run simultaneously)</option>
                            <option value="series">Series (tasks run sequentially)</option>
                        </select>
                        <small class="text-muted">Choose how tasks will be executed in this runbook</small>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn btn-success btn-lg" onclick="acceptAndSaveRules()">
                            <i class="bi bi-check-lg me-2"></i> Accept & Save Rules
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToRulesStep(2)">
                            <i class="bi bi-arrow-left me-2"></i> Back to Edit
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Create Entities (default) -->
        <div id="createEntitiesSection" class="section">
            <div class="content-header">
                <h2>
                    <i class="bi bi-layers"></i>
                    Create Entities
                    <span class="badge bg-success">Section 2</span>
                </h2>
                <p>Use saved rules to generate payloads with custom entity counts.</p>
            </div>
            
            <!-- App Type Switcher -->
                <div class="card-dark">
                <div class="app-switcher">
                    <div class="app-switcher-tabs">
                        <button class="app-switcher-tab active" data-type="blueprint" onclick="switchAppType('blueprint')">
                            <i class="bi bi-diagram-3"></i>
                            <span>Blueprint</span>
                        </button>
                        <button class="app-switcher-tab" data-type="runbook" onclick="switchAppType('runbook')">
                            <i class="bi bi-play-circle"></i>
                            <span>Runbook</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Blueprint Configuration Panel -->
            <div id="blueprintConfigPanel" class="config-panel">
                <!-- Blueprint Rules & Entities Info -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-diagram-3"></i> Blueprint Configuration</h5>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                Ready to generate payloads with the blueprint configuration.
                            </p>
                        </div>
                        <button class="btn btn-outline-info btn-sm" onclick="showBlueprintRulesModal()">
                            <i class="bi bi-list-ul"></i> View Rules & Entities
                        </button>
                    </div>
                    
                    <!-- Auto-select blueprint -->
                    <div class="alert alert-success" style="margin: 0;">
                        <i class="bi bi-check-circle"></i>
                        <strong>Blueprint configuration loaded:</strong> 23 scalable entities ready for payload generation.
                    </div>
                </div>
                
                <!-- Blueprint Hierarchy Builder -->
                <div id="blueprintHierarchyBuilder" class="section-hidden">
                    <div class="card-dark">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-diagram-2"></i> Blueprint Entity Hierarchy</h5>
                            <span id="selectedBlueprintName" class="badge bg-primary"></span>
                        </div>
                        
                        <!-- Blueprint Type Toggle -->
                        <div class="blueprint-type-toggle mb-4">
                            <button class="bp-type-btn active" data-bptype="multi_vm" onclick="setBlueprintType('multi_vm')">
                                <i class="bi bi-hdd-stack"></i> Multi VM
                            </button>
                            <button class="bp-type-btn" data-bptype="single_vm" onclick="setBlueprintType('single_vm')">
                                <i class="bi bi-hdd"></i> Single VM
                            </button>
                        </div>
                        
                        <!-- Blueprint Name Input -->
                        <div class="mb-4">
                            <label class="form-label" for="blueprintNameInput">
                                <i class="bi bi-tag"></i> Blueprint Name <span class="badge bg-secondary">Optional</span>
                            </label>
                            <input type="text" class="form-control" id="blueprintNameInput" 
                                   placeholder="Leave empty for default: st_bp_gen_timestamp"
                                   style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <div class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 6px;">
                                Custom name for the generated blueprint. If empty, defaults to "st_bp_gen_YYYYMMDD_HHMMSS"
                            </div>
                        </div>
                        
                        <!-- Blueprint Entity Hierarchy -->
                        <div class="hierarchy-container">
                            <!-- App Profiles (Primary) -->
                            <div class="hierarchy-main-entity">
                                <div class="hierarchy-entity-header">
                                    <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <div class="hierarchy-entity-info">
                                        <span class="hierarchy-entity-name">App Profiles</span>
                                        <span class="hierarchy-entity-path">app_profile_list</span>
                                    </div>
                                    <div class="hierarchy-entity-input">
                                        <button class="count-btn" onclick="adjustAppProfileCount(-1)">-</button>
                                        <input type="number" id="appProfileCountInput" value="1" min="1" max="10" 
                                               onchange="onAppProfileCountChange(this.value)">
                                        <button class="count-btn" onclick="adjustAppProfileCount(1)">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deployments per Profile -->
                            <div class="hierarchy-main-entity" style="margin-top: 16px;">
                                <div class="hierarchy-entity-header">
                                    <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                        <i class="bi bi-rocket-takeoff"></i>
                                    </div>
                                    <div class="hierarchy-entity-info">
                                        <span class="hierarchy-entity-name">Services</span>
                                        <span class="hierarchy-entity-path">service_definition_list</span>
                                    </div>
                                    <div class="hierarchy-entity-input">
                                        <button class="count-btn" onclick="adjustServiceCount(-1)">-</button>
                                        <input type="number" id="serviceCountInput" value="1" min="1" max="50" 
                                               onchange="onServiceCountChange(this.value)">
                                        <button class="count-btn" onclick="adjustServiceCount(1)">+</button>
                                    </div>
                                </div>
                                
                                <!-- Linked Info -->
                                <div class="linked-entities-info">
                                    <i class="bi bi-link-45deg"></i>
                                    <span>Auto-calculated: Substrates & Packages = App Profiles  Services</span>
                                </div>
                            </div>
                            
                            <!-- Sub-entities -->
                            <div id="serviceSubEntities" class="hierarchy-sub-entities">
                                <div class="sub-entity-connector"></div>
                                
                                <div class="sub-entity-grid">
                                    <div class="sub-entity-header">
                                        <span class="header-name">Entity Name</span>
                                        <span class="header-count">Count</span>
                                    </div>
                                    <!-- Credentials -->
                                    <div class="sub-entity-card" data-entity="credential_definition_list">
                                        <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                            <i class="bi bi-key"></i>
                                        </div>
                                        <div class="sub-entity-details">
                                            <span class="sub-entity-name">Credentials</span>
                                        </div>
                                        <div class="sub-entity-count">
                                            <input type="number" value="1" min="1" max="10" data-entity="credential_definition_list"
                                                   onchange="updateSubEntityCount('credential_definition_list', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Entity Relationship Diagram -->
                        <div class="entity-relationship-box">
                            <h6><i class="bi bi-diagram-3"></i> Entity Relationships</h6>
                            <div class="relationship-diagram">
                                <div class="rel-node rel-profile">App Profile</div>
                                <div class="rel-arrow"></div>
                                <div class="rel-node rel-deployment">Service</div>
                                <div class="rel-arrow"></div>
                                <div class="rel-node rel-substrate">Substrate/Package</div>
                            </div>
                            <div class="relationship-notes">
                                <small><i class="bi bi-info-circle"></i> Total Substrates/Packages = App Profiles  Services</small>
                            </div>
                        </div>
                        
                        <!-- Nested Entity Configuration -->
                        <div class="nested-entities-config mt-4">
                            <h6><i class="bi bi-diagram-3"></i> Nested Entity Configuration <span class="badge bg-info">Multi-Level</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure tasks, variables, and actions at each level where they exist.
                            </p>
                            
                            <!-- Service Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('service')">
                                    <i class="bi bi-chevron-down" id="serviceChevron"></i>
                                    <span><i class="bi bi-server"></i> Service Level</span>
                                </div>
                                <div id="serviceNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Actions per Service</label>
                                        <input type="number" value="0" min="0" max="20" id="serviceActionCount"
                                               placeholder="Actions">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Service Action Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="serviceActionTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Service Action Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="serviceActionVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Substrate Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('substrate')">
                                    <i class="bi bi-chevron-down" id="substrateChevron"></i>
                                    <span><i class="bi bi-hdd-network"></i> Substrate Level</span>
                                </div>
                                <div id="substrateNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Actions per Substrate</label>
                                        <input type="number" value="0" min="0" max="20" id="substrateActionCount"
                                               placeholder="Actions">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Substrate Action Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="substrateActionTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Substrate Action Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="substrateActionVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Package Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('package')">
                                    <i class="bi bi-chevron-down" id="packageChevron"></i>
                                    <span><i class="bi bi-box"></i> Package Level</span>
                                </div>
                                <div id="packageNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Tasks per Install Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="packageInstallTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Install Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="packageInstallVariableCount"
                                               placeholder="Variables">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Uninstall Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="packageUninstallTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Uninstall Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="packageUninstallVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Substrate Options -->
                        <div class="substrate-options mt-4">
                            <h6><i class="bi bi-sliders"></i> Substrate Options <span class="badge bg-secondary">Optional</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure optional features for substrates.
                            </p>
                            
                            <div class="profile-options-grid">
                                <!-- Guest Customization Toggle -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-gear" style="color: #3b82f6;"></i>
                                        <span>Guest Customization</span>
                                    </div>
                                    <div class="profile-option-desc">Include guest customization in VM resources</div>
                                    <div class="profile-option-input">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="guestCustomizationToggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- App Profile Options -->
                        <div class="app-profile-options mt-4">
                            <h6><i class="bi bi-sliders"></i> App Profile Options <span class="badge bg-secondary">Optional</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure optional features for each app profile. Set to 0 to exclude from generated payload.
                            </p>
                            
                            <div class="profile-options-grid">
                                <!-- Profile Actions -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-lightning-charge" style="color: #f59e0b;"></i>
                                        <span>Profile Actions</span>
                                    </div>
                                    <div class="profile-option-desc">Custom actions (scale in/out, restart, etc.)</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="20" id="profileActionCount"
                                               onchange="updateProfileOption('action_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Snapshot Configs -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-camera" style="color: #8b5cf6;"></i>
                                        <span>Snapshot Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Snapshot configuration policies</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="snapshotConfigCount"
                                               onchange="updateProfileOption('snapshot_config_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Restore Configs -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-arrow-counterclockwise" style="color: #10b981;"></i>
                                        <span>Restore Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Restore configuration policies</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="restoreConfigCount"
                                               onchange="updateProfileOption('restore_config_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Patch List -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-bandaid" style="color: #ec4899;"></i>
                                        <span>Patch Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Configuration patch definitions</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="patchListCount"
                                               onchange="updateProfileOption('patch_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live UUID Configuration -->
                    <div class="card-dark">
                        <h5><i class="bi bi-cloud-arrow-down"></i> Live UUID Configuration</h5>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                            Connect to a live Prism Central to fetch real UUIDs for projects, images, and other resources.
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-globe"></i> PC URL</label>
                                <input type="text" class="form-control" id="pcUrlInput" 
                                       placeholder="https://iam.nconprem-10-53-58-35.ccpnx.com/ or https://10.56.78.90:9440/"
                                       style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-person"></i> Username</label>
                                <input type="text" class="form-control" id="pcUsernameInput" 
                                       value="admin" placeholder="admin">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-key"></i> Password</label>
                                <input type="password" class="form-control" id="pcPasswordInput" 
                                       value="Nutanix.123" placeholder="Nutanix.123">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="testPCConnection()" id="testConnectionBtn">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-primary" onclick="fetchProjects()" id="fetchProjectsBtn" disabled>
                                        <i class="bi bi-folder"></i> Fetch Projects
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Status -->
                        <div id="connectionStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-success" id="connectionSuccess" style="display: none;">
                                <i class="bi bi-check-circle"></i> Connection successful! You can now fetch live data.
                            </div>
                            <div class="alert alert-danger" id="connectionError" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> <span id="connectionErrorText">Connection failed</span>
                            </div>
                        </div>
                        
                        <!-- Projects List -->
                        <div id="projectsSection" class="mt-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-search"></i> Search Projects</label>
                                    <input type="text" class="form-control" id="projectSearchInput" 
                                           placeholder="Search project names..." onkeyup="debouncedSearchProjects()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-folder2"></i> Select Project</label>
                                    <div id="projectSelectContainer"></div>
                                </div>
                            </div>
                            
                            <!-- Project Resources - NEW SIMPLIFIED VERSION -->
                            <div id="simpleProjectResourcesSection" class="mt-4" style="display: none; border: 2px solid #28a745; padding: 15px; border-radius: 8px;">
                                <h6 style="color: #28a745;"><i class="bi bi-collection"></i> Project Resources (Live Data)</h6>
                                <div class="alert alert-info">
                                    <small>Resources loaded from project: <span id="selectedProjectName">None</span></small>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <select class="form-select" id="simpleAccountSelect">
                                            <option value="">Select account...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="accountCount">0</span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <select class="form-select" id="simpleClusterSelect">
                                            <option value="">Select cluster...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="clusterCount">0</span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="simpleEnvironmentSelect">
                                            <option value="">Select environment...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="environmentCount">0</span></small>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <select class="form-select" id="simpleNetworkSelect">
                                            <option value="">Select network...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="networkCount">0</span></small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <select class="form-select" id="simpleSubnetSelect">
                                            <option value="">Select subnet...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="subnetCount">0</span></small>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-success" onclick="fetchImages()" id="simpleFetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <select class="form-select" id="simpleImageSelect">
                                        <option value="">Select image...</option>
                                    </select>
                                    <small class="text-muted">Count: <span id="imageCount">0</span></small>
                                </div>
                            </div>
                            
                            <!-- Original Project Resources (Hidden for debugging) -->
                            <div id="projectResourcesSection" class="mt-4" style="display: none;">
                                <h6><i class="bi bi-collection"></i> Project Resources</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <div id="accountSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <div id="clusterSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <div id="environmentSelectContainer"></div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <div id="networkSelectContainer"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <div id="subnetSelectContainer"></div>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchImages()" id="fetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <div id="imageSelectContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="card-dark">
                        <button class="btn btn-primary btn-lg" onclick="generateBlueprintPayload()">
                            <i class="bi bi-gear me-2"></i> Generate Blueprint Payload
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="backToBlueprintSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change Entity
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Runbook Configuration Panel -->
            <div id="runbookConfigPanel" class="config-panel section-hidden">
                <!-- Runbook Rules & Entities Info -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-play-circle"></i> Runbook Configuration</h5>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                Ready to generate payloads with the runbook configuration.
                            </p>
                        </div>
                        <button class="btn btn-outline-info btn-sm" onclick="showRunbookRulesModal()">
                            <i class="bi bi-list-ul"></i> View Rules & Entities
                        </button>
                    </div>
                    
                    <!-- Auto-select runbook -->
                    <div class="alert alert-success" style="margin: 0;">
                        <i class="bi bi-check-circle"></i>
                        <strong>Runbook configuration loaded:</strong> Available for payload generation.
                    </div>
                </div>
                
                <!-- Runbook Hierarchy Builder -->
                <div id="runbookHierarchyBuilder" class="section-hidden">
                    <div class="card-dark">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-play-circle"></i> Runbook Entity Hierarchy</h5>
                            <span id="selectedRunbookName" class="badge bg-success"></span>
            </div>
            
                        <!-- Task Execution Toggle -->
                        <div class="blueprint-type-toggle mb-4">
                            <button class="bp-type-btn active" data-exectype="parallel" onclick="setTaskExecution('parallel')">
                                <i class="bi bi-arrows-expand"></i> Parallel
                            </button>
                            <button class="bp-type-btn" data-exectype="series" onclick="setTaskExecution('series')">
                                <i class="bi bi-arrow-down"></i> Series
                            </button>
                        </div>
                        
                        <!-- Runbook Entities -->
                        <div class="hierarchy-container">
                            <div class="sub-entity-grid">
                                <div class="sub-entity-header">
                                    <span class="header-name">Entity Name</span>
                                    <span class="header-count">Count</span>
                                </div>
                                <!-- Tasks -->
                                <div class="sub-entity-card" data-entity="task_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                        <i class="bi bi-list-task"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Tasks</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="1" max="50" data-entity="task_definition_list"
                                               onchange="updateRunbookEntityCount('task_definition_list', this.value)">
                                    </div>
                                </div>
                                <!-- Endpoints -->
                                <div class="sub-entity-card" data-entity="endpoint_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                        <i class="bi bi-broadcast-pin"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Endpoints</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="20" data-entity="endpoint_definition_list"
                                               onchange="updateRunbookEntityCount('endpoint_definition_list', this.value)">
                                    </div>
                                </div>
                                <!-- Credentials -->
                                <div class="sub-entity-card" data-entity="credential_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                        <i class="bi bi-key"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Credentials</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="10" data-entity="credential_definition_list"
                                               onchange="updateRunbookEntityCount('credential_definition_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live UUID Configuration for Runbook -->
                    <div class="card-dark">
                        <h5><i class="bi bi-cloud-arrow-down"></i> Live UUID Configuration</h5>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                            Connect to a live Prism Central to fetch real UUIDs for projects, images, and other resources.
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-globe"></i> PC URL</label>
                                <input type="text" class="form-control" id="runbookPcUrlInput" 
                                       placeholder="https://iam.nconprem-10-53-58-35.ccpnx.com/ or https://10.56.78.90:9440/"
                                       style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-person"></i> Username</label>
                                <input type="text" class="form-control" id="runbookPcUsernameInput" 
                                       value="admin" placeholder="admin">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-key"></i> Password</label>
                                <input type="password" class="form-control" id="runbookPcPasswordInput" 
                                       value="Nutanix.123" placeholder="Nutanix.123">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="testRunbookPCConnection()" id="runbookTestConnectionBtn">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-primary" onclick="fetchRunbookProjects()" id="runbookFetchProjectsBtn" disabled>
                                        <i class="bi bi-folder"></i> Fetch Projects
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Status -->
                        <div id="runbookConnectionStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-success" id="runbookConnectionSuccess" style="display: none;">
                                <i class="bi bi-check-circle"></i> Connection successful! You can now fetch live data.
                            </div>
                            <div class="alert alert-danger" id="runbookConnectionError" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> <span id="runbookConnectionErrorText">Connection failed</span>
                            </div>
                        </div>
                        
                        <!-- Projects List -->
                        <div id="runbookProjectsSection" class="mt-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-search"></i> Search Projects</label>
                                    <input type="text" class="form-control" id="runbookProjectSearchInput" 
                                           placeholder="Search project names..." onkeyup="debouncedSearchRunbookProjects()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-folder2"></i> Select Project</label>
                                    <div id="runbookProjectSelectContainer"></div>
                                </div>
                            </div>
                            
                            <!-- Project Resources -->
                            <div id="runbookProjectResourcesSection" class="mt-4" style="display: none;">
                                <h6><i class="bi bi-collection"></i> Project Resources</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <div id="runbookAccountSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <div id="runbookClusterSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="runbookEnvironmentSelect">
                                            <option value="">Select environment...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <select class="form-select" id="runbookNetworkSelect">
                                            <option value="">Select network...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <select class="form-select" id="runbookSubnetSelect">
                                            <option value="">Select subnet...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchRunbookImages()" id="runbookFetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <div id="runbookImageSelectContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="card-dark">
                        <button class="btn btn-success btn-lg" onclick="generateRunbookPayload()">
                            <i class="bi bi-gear me-2"></i> Generate Runbook Payload
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="backToRunbookSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change Entity
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Legacy Entity Configuration (hidden, kept for compatibility) -->
            <div id="entityApiSelection" style="display: none;">
                <div id="entityApiList"></div>
            </div>
            <div id="entityConfiguration" class="section-hidden">
                <div class="card-dark" style="padding: 16px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                API: <strong id="selectedApiName" style="color: var(--text-primary);"></strong>
                            </p>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="backToApiSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change API
                        </button>
                    </div>
                    <!-- Blueprint Type selector for blueprints -->
                    <div id="entityBlueprintTypeContainer" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center gap-3">
                            <label class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                <i class="bi bi-cpu"></i> Blueprint Type:
                            </label>
                            <select class="form-select" id="entityBlueprintTypeSelect" style="width: auto; min-width: 200px;" onchange="updateEntityBlueprintType()">
                                <option value="multi_vm">Multi VM (scalable services)</option>
                                <option value="single_vm">Single VM (1 service, simplified)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Task Execution selector for runbooks -->
                    <div id="entityTaskExecutionContainer" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center gap-3">
                            <label class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                <i class="bi bi-diagram-3"></i> Task Execution:
                            </label>
                            <select class="form-select" id="entityTaskExecutionSelect" style="width: auto; min-width: 200px;" onchange="updateEntityTaskExecution()">
                                <option value="parallel">Parallel (all tasks simultaneously)</option>
                                <option value="series">Series (tasks sequentially)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Scalable Entities - collapsed by default -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('entityEntitiesContent')">
                        <h6><i class="bi bi-diagram-2 text-primary"></i> Scalable Entities 
                            <span class="badge bg-primary" id="entityEntitiesBadge">0</span>
                        </h6>
                        <i class="bi bi-chevron-right" id="entityEntitiesIcon"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="entityEntitiesContent">
                        <div class="entity-tree" id="entityEntitiesTree"></div>
                    </div>
                </div>
                
                <!-- Excluded Entities - collapsed by default -->
                <div class="collapsible-section" id="entityExcludedSection" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible('entityExcludedContent')">
                        <h6><i class="bi bi-eye-slash text-danger"></i> Excluded Entities 
                            <span class="badge bg-danger" id="entityExcludedBadge">0</span>
                        </h6>
                        <i class="bi bi-chevron-right" id="entityExcludedIcon"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="entityExcludedContent">
                        <div id="entityExcludedList"></div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card-dark">
                    <button class="btn btn-primary btn-lg" onclick="generateEntityPayload()">
                        <i class="bi bi-gear me-2"></i> Generate Payload
                    </button>
                </div>
            </div>
            
            <!-- Generated Payload -->
            <div id="entityResult" class="section-hidden">
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-code-square"></i> Generated Payload</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="copyEntityPayload()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadEntityPayload()">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div class="json-preview" id="entityGeneratedPayload"></div>
                </div>
            </div>
        </div>
        
        <!-- Section 3: Performance Tester -->
        <div id="perfTesterSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-speedometer2" style="color: var(--accent-orange);"></i>
                    Performance Tester
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));">BroadcastChannel</span>
                </h2>
                <p>Simulate concurrent users with real browser tabs. Uses BroadcastChannel API to sync interactions across tabs.</p>
            </div>
            
            <!-- URL & Tab Controls -->
            <div class="card-dark">
                <div class="perf-controls">
                    <div class="perf-control-group" style="flex: 2;">
                        <label><i class="bi bi-globe"></i> Target URL:</label>
                        <input type="text" class="form-control" id="perfTargetUrl" 
                               placeholder="https://your-site.com" value="">
                    </div>
                    
                    <div class="perf-control-group">
                        <label><i class="bi bi-people"></i> Tabs:</label>
                        <select class="form-select" id="perfTabCount" style="width: auto;">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    
                    <div class="perf-sync-indicator" id="perfSyncIndicator">
                        <i class="bi bi-broadcast"></i>
                        <span id="perfSyncStatus">Ready</span>
                        <span class="badge bg-secondary ms-2" id="perfConnectedCount">0 connected</span>
                    </div>
                </div>
                
                <div class="d-flex gap-3 flex-wrap mt-3">
                    <button class="btn btn-primary" onclick="openChildTabs()">
                        <i class="bi bi-window-plus me-2"></i> Open Child Tabs
                    </button>
                    <button class="btn btn-success" id="perfStartBtn" onclick="startBroadcastTest()">
                        <i class="bi bi-play-fill me-2"></i> Start Recording
                    </button>
                    <button class="btn btn-danger" id="perfStopBtn" onclick="stopBroadcastTest()" disabled>
                        <i class="bi bi-stop-fill me-2"></i> Stop
                    </button>
                    <button class="btn btn-outline-warning" onclick="broadcastNavigate()">
                        <i class="bi bi-arrow-right-circle me-2"></i> Navigate All Tabs
                    </button>
                    <button class="btn btn-outline-secondary" onclick="closeChildTabs()">
                        <i class="bi bi-x-circle me-2"></i> Close Child Tabs
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPerfResults()">
                        <i class="bi bi-download me-2"></i> Export Results
                    </button>
                </div>
                
                <div class="mt-3 p-3" style="background: rgba(255,165,0,0.1); border-radius: 8px; border: 1px solid rgba(255,165,0,0.3);">
                    <small class="text-warning">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>How it works:</strong> Click "Open Child Tabs" to spawn browser tabs. 
                        Each tab loads a child script that listens for BroadcastChannel messages. 
                        Click "Start Recording" then interact with any tab - actions sync to all tabs.
                    </small>
                </div>
            </div>
            
            <!-- Live Metrics Dashboard -->
            <div class="card-dark">
                <h5><i class="bi bi-graph-up"></i> Live Metrics Dashboard</h5>
                <div class="perf-metrics-grid" id="perfMetricsGrid">
                    <div class="perf-metric-card good" id="metricConnectedTabs">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Connected Tabs</div>
                    </div>
                    <div class="perf-metric-card" id="metricAvgLatency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Sync Latency</div>
                    </div>
                    <div class="perf-metric-card" id="metricP95Latency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">P95 Latency</div>
                    </div>
                    <div class="perf-metric-card" id="metricPageLoad">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Page Load</div>
                    </div>
                    <div class="perf-metric-card" id="metricFCP">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg FCP</div>
                    </div>
                    <div class="perf-metric-card" id="metricLCP">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg LCP</div>
                    </div>
                    <div class="perf-metric-card" id="metricMessagesSent">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Messages Sent</div>
                    </div>
                    <div class="perf-metric-card" id="metricErrors">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Errors</div>
                    </div>
                </div>
            </div>
            
            <!-- Connected Tabs Status -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-window-stack"></i> Connected Tabs</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="pingAllTabs()">
                        <i class="bi bi-arrow-repeat"></i> Ping All
                    </button>
                </div>
                <div class="perf-tabs-grid" id="perfTabsGrid">
                    <div class="text-secondary text-center py-4">
                        <i class="bi bi-window-plus" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No child tabs connected. Click "Open Child Tabs" to start.</p>
                    </div>
                </div>
            </div>
            
            <!-- Event Log -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Event Log</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearPerfEventLog()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="perf-event-log" id="perfEventLog">
                    <div class="perf-event-item">
                        <span class="perf-event-time">--:--:--</span>
                        <span class="perf-event-type">INIT</span>
                        <span class="perf-event-detail">BroadcastChannel tester ready. Open child tabs and start recording.</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Mirror Mode Browser Automation -->
        <div id="playwrightSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-layers" style="color: var(--accent-purple);"></i>
                    Mirror Mode
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));">Playwright</span>
                </h2>
                <p>Opens a main browser window where you interact, and child browsers that mirror your actions in real-time.</p>
            </div>
            
            <!-- How it Works -->
            <div class="card-dark" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <h5><i class="bi bi-lightbulb"></i> How Mirror Mode Works</h5>
                <div class="row g-4 mt-2">
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;"></div>
                        <h6>1. Main Browser</h6>
                        <p class="small text-secondary mb-0">A visible Chrome window opens with your target site. This is where YOU interact.</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;"></div>
                        <h6>2. Actions Captured</h6>
                        <p class="small text-secondary mb-0">Every click, type, and scroll you make is captured and sent to child browsers.</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;"></div>
                        <h6>3. Mirrored</h6>
                        <p class="small text-secondary mb-0">Child browsers (headless) replicate your actions simultaneously.</p>
                    </div>
                </div>
            </div>
            
            <!-- Configuration -->
            <div class="card-dark">
                <h5><i class="bi bi-gear"></i> Configuration</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-globe"></i> Target URL</label>
                        <input type="text" class="form-control" id="mirrorTargetUrl" 
                               placeholder="https://your-site.com" value="">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-people"></i> Child Browsers</label>
                        <select class="form-select" id="mirrorChildCount">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="mirrorHeadlessChildren" checked>
                            <label class="form-check-label" for="mirrorHeadlessChildren">Headless Children</label>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="mirrorIgnoreSSL" checked>
                            <label class="form-check-label" for="mirrorIgnoreSSL">Ignore SSL Errors</label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-3 flex-wrap mt-4">
                    <button class="btn btn-success btn-lg" id="mirrorStartBtn" onclick="startMirrorMode()">
                        <i class="bi bi-play-fill me-2"></i> Start Mirror Mode
                    </button>
                    <button class="btn btn-danger btn-lg" id="mirrorStopBtn" onclick="stopMirrorMode()" disabled>
                        <i class="bi bi-stop-fill me-2"></i> Stop
                    </button>
                </div>
                
                <div id="mirrorStatusBar" class="mt-3 p-3" style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3); display: none;">
                    <div class="d-flex align-items-center gap-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span id="mirrorStatusText">Initializing...</span>
                    </div>
                </div>
            </div>
            
            <!-- Live Metrics -->
            <div class="card-dark" id="mirrorMetricsCard">
                <h5><i class="bi bi-graph-up"></i> Live Metrics</h5>
                <div class="perf-metrics-grid">
                    <div class="perf-metric-card good" id="mirrorMetricChildren">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Child Browsers</div>
                    </div>
                    <div class="perf-metric-card" id="mirrorMetricActions">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Actions Mirrored</div>
                    </div>
                    <div class="perf-metric-card" id="mirrorMetricLatency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Mirror Latency</div>
                    </div>
                    <div class="perf-metric-card warn" id="mirrorMetricErrors">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Errors</div>
                    </div>
                </div>
            </div>
            
            <!-- Live Event Log -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-terminal"></i> Live Log</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearMirrorLog()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="perf-event-log" id="mirrorEventLog" style="max-height: 400px;">
                    <div class="perf-event-item">
                        <span class="perf-event-time">--:--:--</span>
                        <span class="perf-event-type">INIT</span>
                        <span class="perf-event-detail">Mirror mode ready. Enter URL and click Start to launch browsers.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================================================
        // SEARCHABLE DROPDOWN CLASS
        // ============================================================================
        
        class SearchableDropdown {
            constructor(containerId, options = {}) {
                this.container = document.getElementById(containerId);
                this.options = {
                    placeholder: options.placeholder || 'Select an option...',
                    searchPlaceholder: options.searchPlaceholder || 'Search...',
                    noResultsText: options.noResultsText || 'No results found',
                    maxHeight: options.maxHeight || '250px',
                    ...options
                };
                this.data = [];
                this.filteredData = [];
                this.selectedValue = '';
                this.selectedText = '';
                this.isOpen = false;
                this.onSelect = options.onSelect || (() => {});
                
                this.init();
            }
            
            init() {
                this.container.innerHTML = `
                    <div class="searchable-dropdown">
                        <input type="text" 
                               class="searchable-dropdown-input" 
                               placeholder="${this.options.placeholder}"
                               readonly>
                        <i class="bi bi-chevron-down searchable-dropdown-arrow"></i>
                        <div class="searchable-dropdown-list" style="max-height: ${this.options.maxHeight}">
                        </div>
                    </div>
                `;
                
                this.input = this.container.querySelector('.searchable-dropdown-input');
                this.dropdown = this.container.querySelector('.searchable-dropdown');
                this.list = this.container.querySelector('.searchable-dropdown-list');
                
                this.bindEvents();
            }
            
            bindEvents() {
                // Toggle dropdown on input click
                this.input.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggle();
                });
                
                // Handle input for search
                this.input.addEventListener('input', (e) => {
                    if (this.isOpen) {
                        this.filter(e.target.value);
                    }
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!this.container.contains(e.target)) {
                        this.close();
                    }
                });
                
                // Handle keyboard navigation
                this.input.addEventListener('keydown', (e) => {
                    if (!this.isOpen) return;
                    
                    const items = this.list.querySelectorAll('.searchable-dropdown-item:not(.searchable-dropdown-no-results)');
                    const currentSelected = this.list.querySelector('.searchable-dropdown-item.selected');
                    let currentIndex = Array.from(items).indexOf(currentSelected);
                    
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            currentIndex = Math.min(currentIndex + 1, items.length - 1);
                            this.highlightItem(items[currentIndex]);
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            currentIndex = Math.max(currentIndex - 1, 0);
                            this.highlightItem(items[currentIndex]);
                            break;
                        case 'Enter':
                            e.preventDefault();
                            if (currentSelected && !currentSelected.classList.contains('searchable-dropdown-no-results')) {
                                this.selectItem(currentSelected);
                            }
                            break;
                        case 'Escape':
                            this.close();
                            break;
                    }
                });
            }
            
            setData(data) {
                this.data = data;
                this.filteredData = [...data];
                this.renderList();
            }
            
            filter(searchTerm) {
                const term = searchTerm.toLowerCase();
                this.filteredData = this.data.filter(item => 
                    item.text.toLowerCase().includes(term) ||
                    (item.subtext && item.subtext.toLowerCase().includes(term))
                );
                this.renderList();
            }
            
            renderList() {
                if (this.filteredData.length === 0) {
                    this.list.innerHTML = `<div class="searchable-dropdown-no-results">${this.options.noResultsText}</div>`;
                    return;
                }
                
                this.list.innerHTML = this.filteredData.map(item => `
                    <div class="searchable-dropdown-item" data-value="${item.value}">
                        <div>${item.text}</div>
                        ${item.subtext ? `<small style="color: var(--text-secondary)">${item.subtext}</small>` : ''}
                    </div>
                `).join('');
                
                // Bind click events to items
                this.list.querySelectorAll('.searchable-dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectItem(item);
                    });
                });
            }
            
            highlightItem(item) {
                this.list.querySelectorAll('.searchable-dropdown-item').forEach(i => i.classList.remove('selected'));
                if (item) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                }
            }
            
            selectItem(item) {
                const value = item.dataset.value;
                const text = item.querySelector('div').textContent;
                
                this.selectedValue = value;
                this.selectedText = text;
                this.input.value = text;
                this.input.setAttribute('readonly', 'true');
                
                this.close();
                this.onSelect(value, text, this.data.find(d => d.value === value));
            }
            
            open() {
                this.isOpen = true;
                this.dropdown.classList.add('open');
                this.list.classList.add('show');
                this.input.removeAttribute('readonly');
                this.input.setAttribute('placeholder', this.options.searchPlaceholder);
                this.input.focus();
                this.renderList();
            }
            
            close() {
                this.isOpen = false;
                this.dropdown.classList.remove('open');
                this.list.classList.remove('show');
                this.input.setAttribute('readonly', 'true');
                this.input.setAttribute('placeholder', this.options.placeholder);
                
                // Restore selected text if no selection was made
                if (this.selectedText) {
                    this.input.value = this.selectedText;
                }
            }
            
            toggle() {
                if (this.isOpen) {
                    this.close();
                } else {
                    this.open();
                }
            }
            
            getValue() {
                return this.selectedValue;
            }
            
            getText() {
                return this.selectedText;
            }
            
            getSelectedData() {
                return this.data.find(d => d.value === this.selectedValue);
            }
            
            reset() {
                this.selectedValue = '';
                this.selectedText = '';
                this.input.value = '';
                this.close();
            }
            
            setValue(value) {
                const item = this.data.find(d => d.value === value);
                if (item) {
                    this.selectedValue = value;
                    this.selectedText = item.text;
                    this.input.value = item.text;
                }
            }
        }
        
        // ============================================================================
        // STATE
        // ============================================================================
        
        // Initialize all dropdowns when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dropdowns...');
            
            // Send log to backend
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: DOM loaded, initializing dropdowns`,
                    data: { 
                        has_project_container: !!document.getElementById('projectSelectContainer'),
                        has_image_container: !!document.getElementById('imageSelectContainer'),
                        has_account_container: !!document.getElementById('accountSelectContainer')
                    }
                })
            }).catch(e => console.error('Failed to send log:', e));
            
            // Initialize project dropdowns if containers exist
            if (document.getElementById('projectSelectContainer')) {
                initializeProjectDropdowns();
                console.log('Project dropdowns initialized');
            }
            
            // Initialize image dropdowns if containers exist
            if (document.getElementById('imageSelectContainer')) {
                initializeImageDropdowns();
                console.log('Image dropdowns initialized');
            }
            
            // Initialize resource dropdowns if containers exist
            if (document.getElementById('accountSelectContainer')) {
                initializeResourceDropdowns();
                console.log('Resource dropdowns initialized');
            }
        });
        
        let currentSection = 'welcome';
        let allApis = [];
        
        // Section 1 state
        let rulesOriginalPayload = null;
        let rulesEntities = [];
        let rulesTempCounts = {};  // Temporary counts for preview only
        let rulesCustomRules = [];
        let rulesDefaultRules = [];
        let rulesPreviewData = null;
        // App Profile optional features for rules section (0 = exclude from payload)
        let rulesProfileOptions = {
            action_list: 0,
            snapshot_config_list: 0,
            restore_config_list: 0,
            patch_list: 0
        };
        
        // Section 2 state
        let entitySelectedApi = null;
        let entityEntities = [];
        let entityCounts = {};
        let entityGeneratedData = null;
        
        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAllApis();
            loadDefaultRules('blueprint');
            
            // Initialize calculated counts display
            updateCalculatedCounts();
            updateRulesCalculatedCounts();
        });
        
        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast-custom';
            toast.style.background = type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)';
            toast.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : 'x-circle'}"></i>${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }
        
        function toggleNestedSection(level) {
            const content = document.getElementById(`${level}NestedConfig`);
            const chevron = document.getElementById(`${level}Chevron`);
            const header = chevron?.parentElement;
            
            if (content && chevron) {
                content.classList.toggle('hidden');
                header?.classList.toggle('collapsed');
            }
        }
        
        function toggleCollapsible(contentId) {
            const content = document.getElementById(contentId);
            const iconId = contentId.replace('Content', 'Icon');
            const icon = document.getElementById(iconId);
            
            content.classList.toggle('collapsed');
            if (icon) {
                icon.className = content.classList.contains('collapsed') ? 'bi bi-chevron-right' : 'bi bi-chevron-down';
            }
        }
        
        // ============================================================================
        // SECTION NAVIGATION
        // ============================================================================
        
        function showSection(section) {
            currentSection = section;
            
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.classList.add('section-hidden'));
            
            // Show selected section
            document.getElementById(`${section}Section`).classList.remove('section-hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn-secondary').forEach(btn => btn.classList.remove('active'));
            if (section === 'createEntities') {
                document.getElementById('createEntitiesBtn').classList.add('active');
            } else if (section === 'perfTester') {
                document.getElementById('perfTesterBtn').classList.add('active');
            } else if (section === 'playwright') {
                document.getElementById('playwrightBtn').classList.add('active');
            }
            
            // Reset section state if needed
            if (section === 'generateRules') {
                resetRulesSection();
            } else if (section === 'createEntities') {
                loadEntityApiList();
                // Also load the new app switcher entity lists
                if (typeof loadBlueprintEntityList === 'function') {
                    if (currentAppType === 'blueprint') {
                        loadBlueprintEntityList();
                    } else {
                        loadRunbookEntityList();
                    }
                }
            } else if (section === 'perfTester') {
                initPerfTester();
            }
        }
        
        function resetRulesSection() {
            // Reset to step 1
            goToRulesStep(1);
            document.getElementById('rulesPayloadInput').value = '';
            if (document.getElementById('rulesRunbookPayloadInput')) {
                document.getElementById('rulesRunbookPayloadInput').value = '';
            }
            rulesOriginalPayload = null;
            rulesEntities = [];
            rulesTempCounts = {};
            rulesCustomRules = [];
            rulesEntityName = '';
            rulesExistingEntity = null;
            rulesCurrentAppType = 'blueprint';
            rulesBlueprintType = 'multi_vm';
            rulesTaskExecMode = 'parallel';
            
            // Reset app switcher to blueprint
            switchRulesAppType('blueprint');
            
            // Reset hierarchy counts - NEW HIERARCHY
            const appProfileInput = document.getElementById('rulesAppProfileCountInput');
            const deploymentInput = document.getElementById('rulesDeploymentCountInput');
            const serviceInput = document.getElementById('rulesServiceCountInput');
            
            if (appProfileInput) {
                appProfileInput.value = 1;
                appProfileInput.disabled = false;
            }
            if (deploymentInput) {
                deploymentInput.value = 1;
                deploymentInput.disabled = false;
            }
            if (serviceInput) {
                serviceInput.value = 1;
                serviceInput.disabled = false;
            }
            
            // Re-enable all +/- buttons
            document.querySelectorAll('#rulesBlueprintHierarchy .hierarchy-entity-input').forEach(container => {
                container.querySelectorAll('.count-btn').forEach(btn => btn.disabled = false);
                container.classList.remove('disabled-input');
            });
            
            // Reset calculated counts display
            updateRulesCalculatedCounts();
        }
        
        // ============================================================================
        // API LIST MANAGEMENT
        // ============================================================================
        
        async function loadAllApis() {
            try {
                const response = await fetch('/api/rules');
                const data = await response.json();
                
                if (data.success) {
                    allApis = data.apis || [];
                    renderApiList();
                }
            } catch (e) {
                console.error('Failed to load APIs:', e);
            }
        }
        
        function renderApiList() {
            const container = document.getElementById('apiList');
            
            if (allApis.length === 0) {
                container.innerHTML = `
                    <div class="no-apis">
                        <i class="bi bi-inbox"></i>
                        <div>No saved entities yet</div>
                        <small>Create rules to get started</small>
                    </div>
                `;
                return;
            }

            container.innerHTML = allApis.map(api => `
                <div class="api-item" onclick="selectApiForEntities('${encodeURIComponent(api.api_url)}')">
                    <div class="api-name">${api.api_url}</div>
                    <div class="api-meta">
                        <span><i class="bi bi-tag"></i> ${api.api_type}</span>
                        <span><i class="bi bi-sliders"></i> ${api.rules_count} rules</span>
                    </div>
                    <div class="api-actions">
                        <button class="btn-use" onclick="event.stopPropagation(); selectApiForEntities('${encodeURIComponent(api.api_url)}')">
                            <i class="bi bi-play"></i> Use
                        </button>
                        <button class="btn-history" onclick="event.stopPropagation(); showHistoryModal('${api.api_url}')" title="View History">
                            <i class="bi bi-clock-history"></i>
                        </button>
                        <button class="btn-delete" onclick="event.stopPropagation(); deleteApi('${encodeURIComponent(api.api_url)}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Store recently deleted API for undo functionality
        let recentlyDeletedApi = null;
        let undoTimeout = null;
        
        async function deleteApi(encodedUrl) {
            const apiUrl = decodeURIComponent(encodedUrl);
            if (!confirm(`Delete rules for "${apiUrl}"?`)) return;
            
            try {
                // First, fetch the full rule data INCLUDING template before deleting (for undo)
                const getRulesResponse = await fetch(`/api/rules/${encodedUrl}?include_template=true`);
                let ruleDataForUndo = null;
                if (getRulesResponse.ok) {
                    const fullData = await getRulesResponse.json();
                    ruleDataForUndo = {
                        api_url: apiUrl,
                        api_type: fullData.api_type,
                        rules: fullData.rules,
                        scalable_entities: fullData.scalable_entities,
                        task_execution: fullData.task_execution || 'parallel',
                        payload_template: fullData.payload_template || null  // Include template for full restore
                    };
                }
                
                const response = await fetch(`/api/rules/${encodedUrl}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    // Store for undo
                    recentlyDeletedApi = ruleDataForUndo;
                    
                    // Clear any existing undo timeout
                    if (undoTimeout) {
                        clearTimeout(undoTimeout);
                    }
                    
                    // Show toast with undo button
                    showUndoToast(`Rules deleted for "${apiUrl}"`, 5000);
                    
                    loadAllApis();
                } else {
                    showToast(data.error || 'Failed to delete', 'error');
                }
            } catch (e) {
                showToast('Failed to delete', 'error');
            }
        }
        
        function showUndoToast(message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toastId = 'undoToast_' + Date.now();
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = 'toast-custom toast-undo';
            toast.style.background = 'var(--accent-orange)';
            toast.innerHTML = `
                <i class="bi bi-trash"></i>
                <span style="flex: 1;">${message}</span>
                <button class="undo-btn" onclick="event.stopPropagation(); undoDelete('${toastId}')">
                    <i class="bi bi-arrow-counterclockwise"></i> Undo
                </button>
                <div class="undo-timer" style="animation: shrink ${duration}ms linear forwards;"></div>
            `;
            container.appendChild(toast);
            
            // Auto-remove after duration
            undoTimeout = setTimeout(() => {
                toast.remove();
                recentlyDeletedApi = null;  // Clear undo data
            }, duration);
        }
        
        async function undoDelete(toastId) {
            if (!recentlyDeletedApi) {
                showToast('Nothing to undo', 'error');
                return;
            }
            
            // Clear the timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
                undoTimeout = null;
            }
            
            // Remove the undo toast
            const toast = document.getElementById(toastId);
            if (toast) toast.remove();
            
            try {
                // Restore the deleted API rules (including template if available)
                const response = await fetch('/api/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: recentlyDeletedApi.api_url,
                        api_type: recentlyDeletedApi.api_type,
                        rules: recentlyDeletedApi.rules,
                        scalable_entities: recentlyDeletedApi.scalable_entities,
                        task_execution: recentlyDeletedApi.task_execution,
                        payload_template: recentlyDeletedApi.payload_template  // Restore template too
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Rules restored!');
                    loadAllApis();
                } else {
                    showToast('Failed to restore: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (e) {
                showToast('Failed to restore', 'error');
            }
            
            recentlyDeletedApi = null;
        }
        
        async function loadDefaultRules(apiType) {
            try {
                const response = await fetch(`/api/default-rules/${apiType}`);
                if (response.ok) {
                    const data = await response.json();
                    rulesDefaultRules = data.default_rules || [];
                }
            } catch (e) {
                console.error('Failed to load default rules:', e);
            }
        }
        
        // ============================================================================
        // SECTION 1: GENERATE NEW PAYLOAD RULES
        // ============================================================================
        
        function goToRulesStep(step) {
            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) stepEl.classList.add('completed');
                if (i === step) stepEl.classList.add('active');
            }
            
            // Show/hide step content
            document.getElementById('rulesStep1').classList.toggle('section-hidden', step !== 1);
            document.getElementById('rulesStep2').classList.toggle('section-hidden', step !== 2);
            document.getElementById('rulesStep3').classList.toggle('section-hidden', step !== 3);
            
            // Show/hide appropriate hierarchy in step 2
            if (step === 2) {
                const apiType = document.getElementById('apiTypeSelect').value;
                document.getElementById('rulesBlueprintHierarchy').classList.toggle('section-hidden', apiType === 'runbook');
                document.getElementById('rulesRunbookHierarchy').classList.toggle('section-hidden', apiType !== 'runbook');
                
                // Sync hierarchy counts with rulesTempCounts
                syncRulesHierarchyCounts();
            }
            
            // Show/hide task execution dropdown for runbooks in step 3
            if (step === 3) {
                const apiType = document.getElementById('apiTypeSelect').value;
                const taskExecContainer = document.getElementById('rulesTaskExecutionContainer');
                taskExecContainer.style.display = apiType === 'runbook' ? 'block' : 'none';
                
                // Update entity name input
                const entityNameInput = document.getElementById('entityNameInput');
                entityNameInput.value = rulesEntityName;
                
                // Show warning if entity exists
                const warning = document.getElementById('entityExistsWarning');
                warning.style.display = rulesExistingEntity ? 'flex' : 'none';
            }
        }
        
        // Sync hierarchy input counts with the actual rulesTempCounts
        function syncRulesHierarchyCounts() {
            const apiType = document.getElementById('apiTypeSelect').value;
            
            if (apiType === 'blueprint' || apiType === 'app') {
                const serviceCount = rulesTempCounts['spec.resources.service_definition_list'] || 1;
                document.getElementById('rulesServiceCountInput').value = serviceCount;
                
                const credCount = rulesTempCounts['spec.resources.credential_definition_list'] || 1;
                if (document.getElementById('rulesCredentialCount')) {
                    document.getElementById('rulesCredentialCount').value = credCount;
                }
                
                const profileCount = rulesTempCounts['spec.resources.app_profile_list'] || 1;
                if (document.getElementById('rulesAppProfileCount')) {
                    document.getElementById('rulesAppProfileCount').value = profileCount;
                }
            } else if (apiType === 'runbook') {
                const taskCount = rulesTempCounts['spec.resources.runbook.task_definition_list'] || 1;
                if (document.getElementById('rulesTaskCount')) {
                    document.getElementById('rulesTaskCount').value = taskCount;
                }
                
                const endpointCount = rulesTempCounts['spec.resources.endpoint_definition_list'] || 1;
                if (document.getElementById('rulesEndpointCount')) {
                    document.getElementById('rulesEndpointCount').value = endpointCount;
                }
                
                const credCount = rulesTempCounts['spec.resources.credential_definition_list'] || 1;
                if (document.getElementById('rulesRunbookCredentialCount')) {
                    document.getElementById('rulesRunbookCredentialCount').value = credCount;
                }
            }
        }
        
        // Blueprint type for rules
        let rulesBlueprintType = 'multi_vm';
        let rulesTaskExecMode = 'parallel';
        
        function setRulesBlueprintType(type) {
            rulesBlueprintType = type;
            document.querySelectorAll('#rulesBlueprintHierarchy .bp-type-btn[data-bptype]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.bptype === type);
            });
            
            const appProfileInput = document.getElementById('rulesAppProfileCountInput');
            const deploymentInput = document.getElementById('rulesDeploymentCountInput');
            const serviceInput = document.getElementById('rulesServiceCountInput');
            
            const appProfileContainer = appProfileInput?.closest('.hierarchy-entity-input');
            const deploymentContainer = deploymentInput?.closest('.hierarchy-entity-input');
            
            // If single_vm, set all to 1 and disable
            if (type === 'single_vm') {
                // Set all counts to 1
                // NOTE: substrate_definition_list and package_definition_list are calculated by backend
                rulesTempCounts['spec.resources.app_profile_list'] = 1;
                rulesTempCounts['spec.resources.app_profile_list.deployment_create_list'] = 1;
                rulesTempCounts['spec.resources.service_definition_list'] = 1;
                
                // Update inputs
                if (appProfileInput) {
                    appProfileInput.value = 1;
                    appProfileInput.disabled = true;
                }
                if (deploymentInput) {
                    deploymentInput.value = 1;
                    deploymentInput.disabled = true;
                }
                if (serviceInput) {
                    serviceInput.value = 1;
                    serviceInput.disabled = true;
                }
                
                // Disable +/- buttons
                if (appProfileContainer) {
                    appProfileContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = true);
                    appProfileContainer.classList.add('disabled-input');
                }
                if (deploymentContainer) {
                    deploymentContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = true);
                    deploymentContainer.classList.add('disabled-input');
                }
                
                // Update calculated counts display
                updateRulesCalculatedCounts();
            } else {
                // Enable all inputs
                if (appProfileInput) appProfileInput.disabled = false;
                if (deploymentInput) deploymentInput.disabled = false;
                if (serviceInput) serviceInput.disabled = false;
                
                // Enable +/- buttons
                if (appProfileContainer) {
                    appProfileContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = false);
                    appProfileContainer.classList.remove('disabled-input');
                }
                if (deploymentContainer) {
                    deploymentContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = false);
                    deploymentContainer.classList.remove('disabled-input');
                }
            }
        }
        
        function setRulesTaskExecution(type) {
            rulesTaskExecMode = type;
            document.querySelectorAll('#rulesRunbookHierarchy .bp-type-btn[data-exectype]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.exectype === type);
            });
        }
        
        // ===== RULES SECTION: App Profile & Deployment Count Functions =====
        function adjustRulesAppProfileCount(delta) {
            const input = document.getElementById('rulesAppProfileCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(10, value + delta));
            input.value = value;
            onRulesAppProfileCountChange(value);
        }
        
        function onRulesAppProfileCountChange(value) {
            const count = parseInt(value) || 1;
            rulesTempCounts['spec.resources.app_profile_list'] = count;
            updateRulesCalculatedCounts();
        }
        
        function adjustRulesDeploymentCount(delta) {
            const input = document.getElementById('rulesDeploymentCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(50, value + delta));
            input.value = value;
            onRulesDeploymentCountChange(value);
        }
        
        function onRulesDeploymentCountChange(value) {
            const count = parseInt(value) || 1;
            rulesTempCounts['spec.resources.app_profile_list.deployment_create_list'] = count;
            updateRulesCalculatedCounts();
        }
        
        function updateRulesCalculatedCounts() {
            const appProfiles = parseInt(document.getElementById('rulesAppProfileCountInput')?.value) || 1;
            const deploymentsPerProfile = parseInt(document.getElementById('rulesDeploymentCountInput')?.value) || 1;
            const totalDeployments = appProfiles * deploymentsPerProfile;
            
            // Update UI badges to show calculated values (for display only)
            // NOTE: Do NOT store these in rulesTempCounts - let backend calculate them
            const substrateCalc = document.querySelector('#rulesSubstrateCalc span');
            const packageCalc = document.querySelector('#rulesPackageCalc span');
            if (substrateCalc) substrateCalc.textContent = totalDeployments;
            if (packageCalc) packageCalc.textContent = totalDeployments;
        }
        
        // Legacy function for backward compatibility
        function adjustRulesServiceCount(delta) {
            const input = document.getElementById('rulesServiceCountInput');
            if (!input) return;
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(100, value + delta));
            input.value = value;
            updateRulesSubEntityCount('service_definition_list', value);
        }
        
        function onRulesServiceCountChange(value) {
            updateRulesSubEntityCount('service_definition_list', parseInt(value) || 1);
        }
        
        function updateRulesSubEntityCount(entity, value) {
            const count = parseInt(value) || 0;
            rulesTempCounts[`spec.resources.${entity}`] = count;
        }
        
        function updateRulesRunbookEntityCount(entity, value) {
            const count = parseInt(value) || 0;
            if (entity === 'task_definition_list') {
                rulesTempCounts[`spec.resources.runbook.${entity}`] = count;
            } else {
                rulesTempCounts[`spec.resources.${entity}`] = count;
            }
        }
        
        function toggleEntityNameEdit() {
            const input = document.getElementById('entityNameInput');
            const btn = document.getElementById('editEntityNameBtn');
            
            if (input.readOnly) {
                input.readOnly = false;
                input.focus();
                btn.innerHTML = '<i class="bi bi-check"></i> Done';
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
            } else {
                input.readOnly = true;
                rulesEntityName = input.value.trim() || rulesEntityName;
                btn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                
                // Re-check if this entity exists
                checkExistingEntity(rulesEntityName).then(() => {
                    const warning = document.getElementById('entityExistsWarning');
                    warning.style.display = rulesExistingEntity ? 'flex' : 'none';
                });
            }
        }
        
        // Store generated entity name for current analysis
        let rulesEntityName = '';
        let rulesExistingEntity = null;  // Stores existing entity data if found
        
        function generateEntityName(payload, apiType) {
            // Try to extract a meaningful name from the payload
            try {
                const parsed = typeof payload === 'string' ? JSON.parse(payload) : payload;
                
                // Common name fields to check
                const nameFields = [
                    parsed?.spec?.name,
                    parsed?.metadata?.name,
                    parsed?.name,
                    parsed?.spec?.resources?.name,
                    parsed?.spec?.resources?.app_name,
                    parsed?.spec?.description?.name
                ];
                
                const name = nameFields.find(n => n && typeof n === 'string');
                if (name) {
                    // Clean up the name and combine with type
                    const cleanName = name.replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 30);
                    return `${apiType}_${cleanName}`;
                }
            } catch (e) {
                // Ignore parsing errors
            }
            
            // Fallback to type + timestamp
            return `${apiType}_${Date.now().toString(36)}`;
        }
        
        // Current app type for rules section
        let rulesCurrentAppType = 'blueprint';
        
        function switchRulesAppType(type) {
            rulesCurrentAppType = type;
            
            // Update tab buttons
            document.querySelectorAll('#generateRulesSection .app-switcher-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // Update hidden select for compatibility
            document.getElementById('apiTypeSelect').value = type;
            
            // Show/hide payload inputs
            document.getElementById('rulesBlueprintInput').classList.toggle('section-hidden', type !== 'blueprint');
            document.getElementById('rulesRunbookInput').classList.toggle('section-hidden', type !== 'runbook');
        }
        
        async function analyzeRunbookPayload() {
            const payload = document.getElementById('rulesRunbookPayloadInput').value.trim();
            
            if (!payload) {
                showToast('Please enter a JSON payload', 'error');
                return;
            }
            
            // Copy to main input and set type, then call analyze
            document.getElementById('rulesPayloadInput').value = payload;
            document.getElementById('apiTypeSelect').value = 'runbook';
            await analyzePayloadForRules();
        }
        
        // ============================================================================
        // DEBUG FUNCTIONS
        // ============================================================================
        
        // Manual test function for project selection
        window.testProjectSelection = async function() {
            try {
                console.log('Testing project selection...');
                
                // First test connection
                const connResponse = await fetch('/api/live-uuid/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pc_url: 'https://iam.nconprem-10-53-58-35.ccpnx.com/',
                        username: 'admin',
                        password: 'Nutanix.123'
                    })
                });
                
                const connResult = await connResponse.json();
                console.log('Connection test:', connResult);
                
                if (connResult.success) {
                    // Fetch projects
                    const projResponse = await fetch('/api/live-uuid/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            pc_url: 'https://iam.nconprem-10-53-58-35.ccpnx.com/',
                            username: 'admin',
                            password: 'Nutanix.123'
                        })
                    });
                    
                    const projResult = await projResponse.json();
                    console.log('Projects result:', projResult);
                    
                    if (projResult.success && projResult.projects.length > 0) {
                        // Populate project dropdown
                        populateProjectSelect(projResult.projects);
                        
                        // Test selecting the first project
                        const firstProject = projResult.projects[0];
                        console.log('Testing selection of first project:', firstProject);
                        onProjectSelected(firstProject);
                        
                        return firstProject;
                    }
                }
            } catch (error) {
                console.error('Test error:', error);
            }
        };
        
        // ============================================================================
        // LIVE UUID FUNCTIONS
        // ============================================================================
        
        let currentProjects = [];
        let selectedProject = null;
        let searchTimeout = null;
        
        async function fetchAccountDetails(accounts) {
            /**
             * Fetch account details for given account UUIDs using GET API calls.
             * Returns account details including pc_uuid which should be used as the actual account UUID.
             */
            try {
                console.log('fetchAccountDetails called with accounts:', accounts);
                
                if (!accounts || accounts.length === 0) {
                    console.log('No accounts to fetch details for');
                    return [];
                }
                
                const pcUrl = document.getElementById('pcUrlInput').value;
                const username = document.getElementById('pcUsernameInput').value;
                const password = document.getElementById('pcPasswordInput').value;
                
                console.log('PC credentials check:', {pcUrl: !!pcUrl, username: !!username, password: !!password});
                
                if (!pcUrl || !username || !password) {
                    throw new Error('PC credentials are required');
                }
                
                const accountUuids = accounts.map(account => account.uuid);
                console.log(`Fetching details for ${accountUuids.length} accounts:`, accountUuids);
                
                const response = await fetch('/api/live-uuid/account-details', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        account_uuids: accountUuids
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Successfully fetched account details:', result.accounts);
                    return result.accounts;
                } else {
                    throw new Error(result.error || 'Failed to fetch account details');
                }
            } catch (error) {
                console.error('Error fetching account details:', error);
                // Return fallback account data
                return accounts.map(account => ({
                    uuid: account.uuid,
                    name: account.name,
                    pc_uuid: account.pc_uuid,
                    status: 'Fetch Error'
                }));
            }
        }

        async function fetchClusterNames(clusters) {
            /**
             * Fetch cluster names for given cluster UUIDs using GET API calls.
             */
            try {
                console.log('fetchClusterNames called with clusters:', clusters);
                
                const pcUrl = document.getElementById('pcUrlInput').value;
                const username = document.getElementById('pcUsernameInput').value;
                const password = document.getElementById('pcPasswordInput').value;
                
                console.log('PC credentials check:', {pcUrl: !!pcUrl, username: !!username, password: !!password});
                
                if (!pcUrl || !username || !password) {
                    throw new Error('PC credentials are required');
                }
                
                const clusterUuids = clusters.map(cluster => cluster.uuid);
                console.log(`Fetching names for ${clusterUuids.length} clusters:`, clusterUuids);
                
                const response = await fetch('/api/live-uuid/cluster-names', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        cluster_uuids: clusterUuids
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('Successfully fetched cluster names:', result.clusters);
                    return result.clusters;
                } else {
                    throw new Error(result.error || 'Failed to fetch cluster names');
                }
            } catch (error) {
                console.error('Error in fetchClusterNames:', error);
                throw error;
            }
        }
        
        async function fetchEntityNames(entities, entityType) {
            /**
             * Generic function to fetch entity names using GET API calls.
             * Currently supports clusters, environments, networks, subnets.
             */
            try {
                const pcUrl = document.getElementById('pcUrl').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!pcUrl || !username || !password) {
                    throw new Error('PC credentials are required');
                }
                
                const entityUuids = entities.map(entity => entity.uuid);
                console.log(`Fetching names for ${entityUuids.length} ${entityType}s:`, entityUuids);
                
                // For now, only clusters are supported via API
                if (entityType === 'cluster') {
                    return await fetchClusterNames(entities);
                } else {
                    // For other entity types, return with fallback names
                    return entities.map(entity => ({
                        uuid: entity.uuid,
                        name: entity.name || `${entityType}-${entity.uuid.substring(0, 8)}`,
                        status: 'UNKNOWN'
                    }));
                }
            } catch (error) {
                console.error(`Error fetching ${entityType} names:`, error);
                // Return fallback data
                return entities.map(entity => ({
                    uuid: entity.uuid,
                    name: entity.name || `${entityType}-${entity.uuid.substring(0, 8)}`,
                    status: 'ERROR'
                }));
            }
        }
        
        async function testPCConnection() {
            const pcUrl = document.getElementById('pcUrlInput').value.trim();
            const username = document.getElementById('pcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('pcPasswordInput').value.trim() || 'Nutanix.123';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            const testBtn = document.getElementById('testConnectionBtn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Testing...';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('connectionStatus').style.display = 'block';
                
                if (result.success) {
                    document.getElementById('connectionSuccess').style.display = 'block';
                    document.getElementById('connectionError').style.display = 'none';
                    document.getElementById('fetchProjectsBtn').disabled = false;
                    showToast('Connection successful!', 'success');
                } else {
                    document.getElementById('connectionSuccess').style.display = 'none';
                    document.getElementById('connectionError').style.display = 'block';
                    document.getElementById('connectionErrorText').textContent = result.message || result.error;
                    document.getElementById('fetchProjectsBtn').disabled = true;
                    showToast('Connection failed: ' + (result.message || result.error), 'error');
                }
            } catch (error) {
                document.getElementById('connectionStatus').style.display = 'block';
                document.getElementById('connectionSuccess').style.display = 'none';
                document.getElementById('connectionError').style.display = 'block';
                document.getElementById('connectionErrorText').textContent = error.message;
                document.getElementById('fetchProjectsBtn').disabled = true;
                showToast('Connection error: ' + error.message, 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }
        
        async function fetchProjects() {
            const pcUrl = document.getElementById('pcUrlInput').value.trim();
            const username = document.getElementById('pcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('pcPasswordInput').value.trim() || 'Nutanix.123';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('fetchProjectsBtn');
            const originalText = fetchBtn.innerHTML;
            fetchBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Fetching...';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentProjects = result.projects;
                    populateProjectSelect(result.projects);
                    document.getElementById('projectsSection').style.display = 'block';
                    showToast(`Fetched ${result.projects.length} projects`, 'success');
                } else {
                    showToast('Failed to fetch projects: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error fetching projects: ' + error.message, 'error');
            } finally {
                fetchBtn.innerHTML = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        function populateProjectSelect(projects) {
            console.log('populateProjectSelect called with projects:', projects);
            
            // Send log to backend
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: populateProjectSelect called with ${projects.length} projects`,
                    data: { project_count: projects.length, project_names: projects.map(p => p.name) }
                })
            }).catch(e => console.error('Failed to send log:', e));
            
            if (!projectDropdown) {
                console.log('Initializing project dropdowns...');
                initializeProjectDropdowns();
            }
            
            const projectData = projects.map(project => ({
                value: project.uuid,
                text: project.name,
                subtext: project.uuid,
                data: project
            }));
            
            console.log('Project dropdown data:', projectData);
            projectDropdown.setData(projectData);
        }
        
        function debouncedSearchProjects() {
            // Clear existing timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Set new timeout to delay the search
            searchTimeout = setTimeout(searchProjects, 500); // 500ms delay
        }
        
        async function searchProjects() {
            const searchTerm = document.getElementById('projectSearchInput').value.trim();
            const searchInput = document.getElementById('projectSearchInput');
            
            // If search term is empty, fetch all projects
            if (!searchTerm) {
                await fetchProjects();
                return;
            }
            
            // Show loading state
            searchInput.style.opacity = '0.7';
            searchInput.disabled = true;
            
            // Make API call with search filter
            try {
                const pcUrl = document.getElementById('pcUrl').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (!pcUrl || !username || !password) {
                    showToast('Please fill in PC credentials first', 'error');
                    return;
                }
                
                console.log(`Searching projects with term: "${searchTerm}"`);
                
                const response = await fetch('/api/live-uuid/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        search_term: searchTerm  // This will trigger the backend filter
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentProjects = result.projects;
                    populateProjectSelect(result.projects);
                    console.log(`Found ${result.projects.length} projects matching "${searchTerm}"`);
                    showToast(`Found ${result.projects.length} projects matching "${searchTerm}"`, 'success');
                } else {
                    console.error('Search failed:', result.error);
                    showToast(`Search failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error searching projects:', error);
                showToast('Error searching projects', 'error');
            } finally {
                // Restore input state
                searchInput.style.opacity = '1';
                searchInput.disabled = false;
            }
        }
        
        // GET SELECTED LIVE UUIDS FROM UI
        function getSelectedLiveUUIDs() {
            console.log('=== COLLECTING LIVE UUIDS FROM UI ===');
            
            // Try to get from simple dropdowns first, then fall back to complex dropdowns
            const result = {
                project: { uuid: '', name: '' },
                account: { uuid: '', name: '' , pc_uuid: ''},
                cluster: { uuid: '', name: '' },
                environment: { uuid: '', name: '' },
                network: { uuid: '', name: '' },
                subnet: { uuid: '', name: '' },
                image: { uuid: '', name: '' }
            };
            
            // Project (from global variable)
            if (selectedProject) {
                result.project.uuid = selectedProject.uuid;
                result.project.name = selectedProject.name;
                console.log('Project from selectedProject:', result.project);
            }
            
            // Account - Send both original account_uuid and pc_uuid
            console.log('Account from selectedProject:', selectedProject);
            const simpleAccountSelect = document.getElementById('simpleAccountSelect');
            console.log('simpleAccountSelect:', simpleAccountSelect);
            if (simpleAccountSelect && simpleAccountSelect.value) {
                // Get the selected option to access its accuuid attribute
                const selectedOption = simpleAccountSelect.selectedOptions[0];
                const pcUuid = selectedOption?.getAttribute('accuuid');
                
                result.account.uuid = simpleAccountSelect.value; // Original account UUID
                result.account.pc_uuid = pcUuid; // PC UUID from selected option
                result.account.name = selectedOption?.textContent || simpleAccountSelect.value;
                result.account.original_uuid = simpleAccountSelect.value; // Original account UUID for images API
                
                console.log('Account from simple dropdown:', result.account);
                console.log('Selected option:', selectedOption);
                console.log('PC UUID from selected option:', pcUuid);
                console.log('Account UUID (original):', result.account.uuid);
                console.log('Account PC UUID (for payload):', result.account.pc_uuid);
                console.log('Account Original UUID (for images):', result.account.original_uuid);
            } else if (accountDropdown && accountDropdown.getValue()) {
                // For complex dropdown, we need to get the pc_uuid differently
                const selectedValue = accountDropdown.getValue();
                const accountSelect = document.getElementById('accountSelect');
                const selectedOption = accountSelect?.querySelector(`option[value="${selectedValue}"]`);
                const pcUuid = selectedOption?.getAttribute('accuuid');
                
                result.account.uuid = selectedValue;
                result.account.pc_uuid = pcUuid;
                result.account.name = accountDropdown.getText() || selectedValue;
                
                console.log('Account from complex dropdown:', result.account);
                console.log('Complex dropdown selected option:', selectedOption);
                console.log('Complex dropdown PC UUID:', pcUuid);
            }
            
            // Cluster - THIS IS THE KEY PART
            const simpleClusterSelect = document.getElementById('simpleClusterSelect');
            if (simpleClusterSelect && simpleClusterSelect.value) {
                result.cluster.uuid = simpleClusterSelect.value;
                result.cluster.name = simpleClusterSelect.selectedOptions[0]?.textContent || simpleClusterSelect.value;
                console.log('Cluster from simple dropdown:', result.cluster);
                console.log('Cluster dropdown value:', simpleClusterSelect.value);
                console.log('Cluster dropdown text:', simpleClusterSelect.selectedOptions[0]?.textContent);
            } else if (clusterDropdown && clusterDropdown.getValue()) {
                result.cluster.uuid = clusterDropdown.getValue();
                result.cluster.name = clusterDropdown.getText() || clusterDropdown.getValue();
                console.log('Cluster from complex dropdown:', result.cluster);
            }
            
            // Environment
            const simpleEnvironmentSelect = document.getElementById('simpleEnvironmentSelect');
            if (simpleEnvironmentSelect && simpleEnvironmentSelect.value) {
                result.environment.uuid = simpleEnvironmentSelect.value;
                result.environment.name = simpleEnvironmentSelect.selectedOptions[0]?.textContent || simpleEnvironmentSelect.value;
            } else if (environmentDropdown && environmentDropdown.getValue()) {
                result.environment.uuid = environmentDropdown.getValue();
                result.environment.name = environmentDropdown.getText() || environmentDropdown.getValue();
            }
            
            // Network
            const simpleNetworkSelect = document.getElementById('simpleNetworkSelect');
            if (simpleNetworkSelect && simpleNetworkSelect.value) {
                result.network.uuid = simpleNetworkSelect.value;
                result.network.name = simpleNetworkSelect.selectedOptions[0]?.textContent || simpleNetworkSelect.value;
            } else if (networkDropdown && networkDropdown.getValue()) {
                result.network.uuid = networkDropdown.getValue();
                result.network.name = networkDropdown.getText() || networkDropdown.getValue();
            }
            
            // Subnet
            const simpleSubnetSelect = document.getElementById('simpleSubnetSelect');
            if (simpleSubnetSelect && simpleSubnetSelect.value) {
                result.subnet.uuid = simpleSubnetSelect.value;
                result.subnet.name = simpleSubnetSelect.selectedOptions[0]?.textContent || simpleSubnetSelect.value;
            } else if (subnetDropdown && subnetDropdown.getValue()) {
                result.subnet.uuid = subnetDropdown.getValue();
                result.subnet.name = subnetDropdown.getText() || subnetDropdown.getValue();
            }
            
            // Image
            const simpleImageSelect = document.getElementById('simpleImageSelect');
            if (simpleImageSelect && simpleImageSelect.value) {
                result.image.uuid = simpleImageSelect.value;
                result.image.name = simpleImageSelect.selectedOptions[0]?.textContent || simpleImageSelect.value;
            } else if (imageDropdown && imageDropdown.getValue()) {
                result.image.uuid = imageDropdown.getValue();
                result.image.name = imageDropdown.getText() || imageDropdown.getValue();
            }
            
            console.log('Final collected live UUIDs:', result);
            return result;
        }
        
        // NEW SIMPLIFIED PROJECT SELECTION FUNCTION
        function populateSimpleProjectResources(project) {
            console.log('=== SIMPLE PROJECT RESOURCES POPULATION ===');
            console.log('Project:', project.name);
            console.log('Resources:', project.resources);
            console.log('Resources.cluster_details:', project.resources?.cluster_details);
            console.log('Resources.cluster_reference_list:', project.resources?.cluster_reference_list);
            
            // Show the simple resources section
            const simpleSection = document.getElementById('simpleProjectResourcesSection');
            if (simpleSection) {
                simpleSection.style.display = 'block';
                console.log('Simple project resources section shown');
                
                // Send log to backend
                fetch('/api/log-frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level: 'INFO',
                        message: `Frontend: SIMPLE resources section shown successfully`,
                        data: { project_name: project.name }
                    })
                }).catch(e => console.error('Failed to send log:', e));
            } else {
                console.error('Simple project resources section not found!');
                return;
            }
            
            // Update project name
            const projectNameSpan = document.getElementById('selectedProjectName');
            if (projectNameSpan) {
                projectNameSpan.textContent = project.name;
            }
            
            const resources = project.resources || {};
            
            // Populate accounts with details fetched from API
            const accountSelect = document.getElementById('simpleAccountSelect');
            const accountCount = document.getElementById('accountCount');
            const accounts = resources.account_reference_list || [];
            
            console.log('Account data for details fetching:', accounts);
            console.log('Account data length:', accounts.length);
            
            accountSelect.innerHTML = '<option value="">Select account...</option>';
            accountCount.textContent = accounts.length;
            
            if (accounts.length > 0) {
                console.log('Found accounts, starting details fetch process:', accounts);
                // Show loading state
                accountSelect.innerHTML = '<option value="">Loading account details...</option>';
                
                // Fetch account details using the new API
                console.log('Calling fetchAccountDetails...');
                fetchAccountDetails(accounts).then(accountDetails => {
                    console.log('fetchAccountDetails resolved with:', accountDetails);
                    accountSelect.innerHTML = '<option value="">Select account...</option>';
                    accountDetails.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.uuid; // Use original account_uuid as the value
                        option.textContent = account.name;
                        option.title = `Account UUID: ${account.uuid} | PC UUID: ${account.pc_uuid} | Status: ${account.status}`;
                        option.setAttribute('accuuid', account.pc_uuid);
                        console.log(`Account option created: ${account.name} | UUID: ${account.uuid} | PC UUID: ${account.pc_uuid}`);
                        accountSelect.appendChild(option);
                    });
                    console.log('Account select: mohan', accountSelect);
                }).catch(error => {
                    console.error('Error fetching account details:', error);
                    console.error('Full error details:', error);
                    // Fallback to original UUIDs if API fails
                    accountSelect.innerHTML = '<option value="">Select account...</option>';
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.uuid;
                        option.textContent = account.name || account.uuid;
                        accountSelect.appendChild(option);
                    });
                });
            } else {
                console.log('No accounts found in project resources');
            }
            
            // Add auto-fetch images when account is selected
            accountSelect.addEventListener('change', function() {
                if (this.value) {
                    console.log('Account selected, auto-fetching images...');
                    fetchImages();
                }
            });
            
            // Populate clusters with names fetched from API
            const clusterSelect = document.getElementById('simpleClusterSelect');
            const clusterCount = document.getElementById('clusterCount');
            const clusters = resources.cluster_details || resources.cluster_reference_list || [];
            
            console.log('Cluster data for name fetching:', clusters);
            console.log('Cluster data length:', clusters.length);
            console.log('Cluster data type:', typeof clusters);
            console.log('Is clusters an array?', Array.isArray(clusters));
            
            clusterSelect.innerHTML = '<option value="">Select cluster...</option>';
            clusterCount.textContent = clusters.length;
            
            if (clusters.length > 0) {
                console.log('Found clusters, starting name fetch process:', clusters);
                // Show loading state
                clusterSelect.innerHTML = '<option value="">Loading cluster names...</option>';
                
                // Fetch cluster names using the new API
                console.log('Calling fetchClusterNames...');
                fetchClusterNames(clusters).then(clusterNames => {
                    console.log('fetchClusterNames resolved with:', clusterNames);
                    clusterSelect.innerHTML = '<option value="">Select cluster...</option>';
                    clusterNames.forEach(cluster => {
                        const option = document.createElement('option');
                        option.value = cluster.uuid;
                        option.textContent = cluster.name;
                        option.title = `UUID: ${cluster.uuid} | Status: ${cluster.status}`;
                        clusterSelect.appendChild(option);
                    });
                }).catch(error => {
                    console.error('Error fetching cluster names:', error);
                    console.error('Full error details:', error);
                    // Fallback to UUIDs if API fails
                    clusterSelect.innerHTML = '<option value="">Select cluster...</option>';
                    clusters.forEach(cluster => {
                        const option = document.createElement('option');
                        option.value = cluster.uuid;
                        option.textContent = cluster.name || cluster.uuid;
                        clusterSelect.appendChild(option);
                    });
                });
            }
            
            // Populate environments
            const environmentSelect = document.getElementById('simpleEnvironmentSelect');
            const environmentCount = document.getElementById('environmentCount');
            const environments = resources.environment_reference_list || [];
            
            environmentSelect.innerHTML = '<option value="">Select environment...</option>';
            environments.forEach(env => {
                const option = document.createElement('option');
                option.value = env.uuid;
                option.textContent = env.name || env.uuid;
                environmentSelect.appendChild(option);
            });
            environmentCount.textContent = environments.length;
            
            // Populate networks
            const networkSelect = document.getElementById('simpleNetworkSelect');
            const networkCount = document.getElementById('networkCount');
            const networks = resources.external_network_list || [];
            
            networkSelect.innerHTML = '<option value="">Select network...</option>';
            networks.forEach(network => {
                const option = document.createElement('option');
                option.value = network.uuid;
                option.textContent = network.name || network.uuid;
                networkSelect.appendChild(option);
            });
            networkCount.textContent = networks.length;
            
            // Populate subnets
            const subnetSelect = document.getElementById('simpleSubnetSelect');
            const subnetCount = document.getElementById('subnetCount');
            const subnets = resources.subnet_reference_list || [];
            
            subnetSelect.innerHTML = '<option value="">Select subnet...</option>';
            subnets.forEach(subnet => {
                const option = document.createElement('option');
                option.value = subnet.uuid;
                option.textContent = subnet.name || subnet.uuid;
                subnetSelect.appendChild(option);
            });
            subnetCount.textContent = subnets.length;
            
            // Enable fetch images button
            const fetchBtn = document.getElementById('simpleFetchImagesBtn');
            if (fetchBtn) {
                fetchBtn.disabled = false;
            }
            
            console.log('=== SIMPLE RESOURCES POPULATED SUCCESSFULLY ===');
            console.log(`Accounts: ${accounts.length}, Clusters: ${clusters.length}, Environments: ${environments.length}, Networks: ${networks.length}, Subnets: ${subnets.length}`);
            
            // Send success log to backend
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: SIMPLE resources populated successfully`,
                    data: { 
                        project_name: project.name,
                        resource_counts: {
                            accounts: accounts.length,
                            clusters: clusters.length,
                            environments: environments.length,
                            networks: networks.length,
                            subnets: subnets.length
                        }
                    }
                })
            }).catch(e => console.error('Failed to send log:', e));
        }
        
        function onProjectSelected(project = null) {
            console.log('onProjectSelected called with:', project);
            
            // Send log to backend
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: onProjectSelected called`,
                    data: { 
                        project_name: project ? project.name : 'null',
                        project_uuid: project ? project.uuid : 'null',
                        has_resources: project ? !!project.resources : false,
                        resource_counts: project && project.resources ? {
                            accounts: (project.resources.account_reference_list || []).length,
                            clusters: (project.resources.cluster_reference_list || []).length,
                            environments: (project.resources.environment_reference_list || []).length,
                            networks: (project.resources.external_network_list || []).length,
                            subnets: (project.resources.subnet_reference_list || []).length
                        } : null
                    }
                })
            }).catch(e => console.error('Failed to send log:', e));
            
            if (project) {
                selectedProject = project;
                console.log('Selected project:', selectedProject.name);
                console.log('Selected project resources:', selectedProject.resources);
                
                // USE NEW SIMPLE APPROACH FIRST
                populateSimpleProjectResources(project);
                
                // Also try the original approach (for debugging)
                populateProjectResources(selectedProject.resources || {});
                
                // Check if the project resources section exists and show it
                const projectsSection = document.getElementById('projectsSection');
                const projectResourcesSection = document.getElementById('projectResourcesSection');
                const fetchImagesBtn = document.getElementById('fetchImagesBtn');
                
                // Check parent container first
                if (projectsSection) {
                    const projectsSectionStyle = window.getComputedStyle(projectsSection);
                    console.log('Projects section display style:', projectsSectionStyle.display);
                    
                    // Send detailed DOM debugging to backend
                    fetch('/api/log-frontend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            level: 'INFO',
                            message: `Frontend: DOM Debug - Projects section found`,
                            data: { 
                                display_style: projectsSectionStyle.display,
                                visibility: projectsSectionStyle.visibility,
                                opacity: projectsSectionStyle.opacity
                            }
                        })
                    }).catch(e => console.error('Failed to send log:', e));
                    
                    if (projectsSectionStyle.display === 'none') {
                        console.error('Projects section is hidden! This will prevent project resources from showing.');
                        projectsSection.style.display = 'block';
                        console.log('Forced projects section to be visible');
                        
                        fetch('/api/log-frontend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level: 'WARN',
                                message: `Frontend: Projects section was hidden, forced to be visible`,
                                data: {}
                            })
                        }).catch(e => console.error('Failed to send log:', e));
                    }
                } else {
                    console.error('Projects section element not found!');
                    fetch('/api/log-frontend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            level: 'ERROR',
                            message: `Frontend: Projects section element not found in DOM`,
                            data: {}
                        })
                    }).catch(e => console.error('Failed to send log:', e));
                }
                
                if (projectResourcesSection) {
                    projectResourcesSection.style.display = 'block';
                    console.log('Project resources section shown');
                    
                    const resourcesSectionStyle = window.getComputedStyle(projectResourcesSection);
                    fetch('/api/log-frontend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            level: 'INFO',
                            message: `Frontend: Project resources section shown`,
                            data: { 
                                display_style: resourcesSectionStyle.display,
                                visibility: resourcesSectionStyle.visibility,
                                opacity: resourcesSectionStyle.opacity
                            }
                        })
                    }).catch(e => console.error('Failed to send log:', e));
                } else {
                    console.error('Project resources section element not found!');
                    fetch('/api/log-frontend', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            level: 'ERROR',
                            message: `Frontend: Project resources section element not found in DOM`,
                            data: {}
                        })
                    }).catch(e => console.error('Failed to send log:', e));
                }
                
                if (fetchImagesBtn) {
                    fetchImagesBtn.disabled = false;
                    console.log('Fetch images button enabled');
                } else {
                    console.error('Fetch images button not found!');
                }
                
                // Check if resources have actual content
                const hasResources = selectedProject.resources && 
                    (
                        (selectedProject.resources.account_reference_list && selectedProject.resources.account_reference_list.length > 0) ||
                        (selectedProject.resources.cluster_reference_list && selectedProject.resources.cluster_reference_list.length > 0) ||
                        (selectedProject.resources.environment_reference_list && selectedProject.resources.environment_reference_list.length > 0) ||
                        (selectedProject.resources.external_network_list && selectedProject.resources.external_network_list.length > 0) ||
                        (selectedProject.resources.subnet_reference_list && selectedProject.resources.subnet_reference_list.length > 0)
                    );
                
                if (hasResources) {
                    console.log('Project resources populated for:', selectedProject.name);
                } else {
                    console.warn('Project has no resources or empty resource lists:', selectedProject.name);
                    showToast(`Project "${selectedProject.name}" has no resources configured`, 'warning');
                }
            } else {
                selectedProject = null;
                document.getElementById('projectResourcesSection').style.display = 'none';
                document.getElementById('simpleProjectResourcesSection').style.display = 'none';
                document.getElementById('fetchImagesBtn').disabled = true;
                document.getElementById('simpleFetchImagesBtn').disabled = true;
                console.log('Project selection cleared');
            }
        }
        
        // Initialize all resource dropdowns
        let accountDropdown = null;
        let clusterDropdown = null;
        let environmentDropdown = null;
        let networkDropdown = null;
        let subnetDropdown = null;
        
        // Runbook-specific dropdowns
        let runbookAccountDropdown = null;
        let runbookClusterDropdown = null;
        let runbookEnvironmentDropdown = null;
        let runbookNetworkDropdown = null;
        let runbookSubnetDropdown = null;
        
        function initializeResourceDropdowns() {
            console.log('Initializing resource dropdowns...');
            
            // Check if containers exist
            const containers = [
                'accountSelectContainer',
                'clusterSelectContainer', 
                'environmentSelectContainer',
                'networkSelectContainer',
                'subnetSelectContainer'
            ];
            
            let allContainersFound = true;
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found in DOM`);
                    allContainersFound = false;
                } else {
                    console.log(`Container ${containerId} found`);
                }
            });
            
            if (!allContainersFound) {
                console.error('Some dropdown containers are missing - this may prevent resource dropdowns from working');
                fetch('/api/log-frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level: 'ERROR',
                        message: `Frontend: Some dropdown containers are missing from DOM`,
                        data: { containers_checked: containers }
                    })
                }).catch(e => console.error('Failed to send log:', e));
            } else {
                fetch('/api/log-frontend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        level: 'INFO',
                        message: `Frontend: All dropdown containers found in DOM`,
                        data: { containers_found: containers }
                    })
                }).catch(e => console.error('Failed to send log:', e));
            }
            
            if (!accountDropdown) {
                const accountContainer = document.getElementById('accountSelectContainer');
                if (accountContainer) {
                accountDropdown = new SearchableDropdown('accountSelectContainer', {
                    placeholder: 'Select account...',
                    searchPlaceholder: 'Search accounts...',
                    noResultsText: 'No accounts found'
                });
                    console.log('Account dropdown initialized');
                } else {
                    console.error('Account container not found, cannot initialize dropdown');
                }
            }
            
            if (!clusterDropdown) {
                const clusterContainer = document.getElementById('clusterSelectContainer');
                if (clusterContainer) {
                clusterDropdown = new SearchableDropdown('clusterSelectContainer', {
                    placeholder: 'Select cluster...',
                    searchPlaceholder: 'Search clusters...',
                    noResultsText: 'No clusters found'
                });
                    console.log('Cluster dropdown initialized');
                } else {
                    console.error('Cluster container not found, cannot initialize dropdown');
                }
            }
            
            if (!environmentDropdown) {
                const environmentContainer = document.getElementById('environmentSelectContainer');
                if (environmentContainer) {
                environmentDropdown = new SearchableDropdown('environmentSelectContainer', {
                    placeholder: 'Select environment...',
                    searchPlaceholder: 'Search environments...',
                    noResultsText: 'No environments found'
                });
                    console.log('Environment dropdown initialized');
                } else {
                    console.error('Environment container not found, cannot initialize dropdown');
                }
            }
            
            if (!networkDropdown) {
                const networkContainer = document.getElementById('networkSelectContainer');
                if (networkContainer) {
                networkDropdown = new SearchableDropdown('networkSelectContainer', {
                    placeholder: 'Select network...',
                    searchPlaceholder: 'Search networks...',
                    noResultsText: 'No networks found'
                });
                    console.log('Network dropdown initialized');
                } else {
                    console.error('Network container not found, cannot initialize dropdown');
                }
            }
            
            if (!subnetDropdown) {
                const subnetContainer = document.getElementById('subnetSelectContainer');
                if (subnetContainer) {
                subnetDropdown = new SearchableDropdown('subnetSelectContainer', {
                    placeholder: 'Select subnet...',
                    searchPlaceholder: 'Search subnets...',
                    noResultsText: 'No subnets found'
                });
                    console.log('Subnet dropdown initialized');
                } else {
                    console.error('Subnet container not found, cannot initialize dropdown');
                }
            }
        }
        
        function initializeRunbookResourceDropdowns() {
            if (!runbookAccountDropdown) {
                runbookAccountDropdown = new SearchableDropdown('runbookAccountSelectContainer', {
                    placeholder: 'Select account...',
                    searchPlaceholder: 'Search accounts...',
                    noResultsText: 'No accounts found'
                });
            }
            
            if (!runbookClusterDropdown) {
                runbookClusterDropdown = new SearchableDropdown('runbookClusterSelectContainer', {
                    placeholder: 'Select cluster...',
                    searchPlaceholder: 'Search clusters...',
                    noResultsText: 'No clusters found'
                });
            }
        }
        
        function populateProjectResources(resources) {
            console.log('populateProjectResources called with:', resources);
            
            // Ensure resources is an object
            if (!resources || typeof resources !== 'object') {
                console.warn('Resources is not a valid object, using empty object');
                resources = {};
            }
            
            // Send detailed log to backend
            const resourceCounts = {
                accounts: (resources.account_reference_list || []).length,
                clusters: (resources.cluster_reference_list || []).length,
                environments: (resources.environment_reference_list || []).length,
                networks: (resources.external_network_list || []).length,
                subnets: (resources.subnet_reference_list || []).length
            };
            
            console.log('Resource counts:', resourceCounts);
            
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: populateProjectResources called`,
                    data: { 
                        resource_counts: resourceCounts,
                        account_details: resources.account_reference_list || [],
                        cluster_details: resources.cluster_reference_list || []
                    }
                })
            }).catch(e => console.error('Failed to send log:', e));
            
            initializeResourceDropdowns();
            
            // Populate account dropdown
            const accountData = (resources.account_reference_list || []).map(account => ({
                value: account.uuid,
                text: account.name || account.uuid,
                subtext: account.uuid,
                data: account
            }));
            console.log('Account data:', accountData);
            if (accountDropdown) {
            accountDropdown.setData(accountData);
            } else {
                console.error('Account dropdown not initialized');
            }
            
            // Populate cluster dropdown
            const clusterData = (resources.cluster_reference_list || []).map(cluster => ({
                value: cluster.uuid,
                text: cluster.name || cluster.uuid,
                subtext: cluster.uuid,
                data: cluster
            }));
            console.log('Cluster data:', clusterData);
            if (clusterDropdown) {
            clusterDropdown.setData(clusterData);
            } else {
                console.error('Cluster dropdown not initialized');
            }
            
            // Populate environment dropdown
            const environmentData = (resources.environment_reference_list || []).map(env => ({
                value: env.uuid,
                text: env.name || env.uuid,
                subtext: env.uuid,
                data: env
            }));
            console.log('Environment data:', environmentData);
            if (environmentDropdown) {
            environmentDropdown.setData(environmentData);
            } else {
                console.error('Environment dropdown not initialized');
            }
            
            // Populate network dropdown
            const networkData = (resources.external_network_list || []).map(network => ({
                value: network.uuid,
                text: network.name || network.uuid,
                subtext: network.uuid,
                data: network
            }));
            console.log('Network data:', networkData);
            if (networkDropdown) {
            networkDropdown.setData(networkData);
            } else {
                console.error('Network dropdown not initialized');
            }
            
            // Populate subnet dropdown
            const subnetData = (resources.subnet_reference_list || []).map(subnet => ({
                value: subnet.uuid,
                text: subnet.name || subnet.uuid,
                subtext: subnet.uuid,
                data: subnet
            }));
            console.log('Subnet data:', subnetData);
            if (subnetDropdown) {
            subnetDropdown.setData(subnetData);
            } else {
                console.error('Subnet dropdown not initialized');
            }
            
            // Log completion
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: Project resources populated successfully`,
                    data: { resource_counts: resourceCounts }
                })
            }).catch(e => console.error('Failed to send log:', e));
            
            // Set default environment if available
            if (resources.default_environment_reference && resources.default_environment_reference.uuid) {
                environmentSelect.value = resources.default_environment_reference.uuid;
            }
            
            // Populate network dropdown
            const networkSelect = document.getElementById('networkSelect');
            networkSelect.innerHTML = '<option value="">Select network...</option>';
            (resources.external_network_list || []).forEach(network => {
                const option = document.createElement('option');
                option.value = network.uuid;
                option.textContent = network.name || network.uuid;
                networkSelect.appendChild(option);
            });
            
            // Populate subnet dropdown
            const subnetSelect = document.getElementById('subnetSelect');
            subnetSelect.innerHTML = '<option value="">Select subnet...</option>';
            (resources.subnet_reference_list || []).forEach(subnet => {
                const option = document.createElement('option');
                option.value = subnet.uuid;
                option.textContent = subnet.name || subnet.uuid;
                subnetSelect.appendChild(option);
            });
        }
        
        async function fetchImages() {
            const pcUrl = document.getElementById('pcUrlInput').value.trim();
            const username = document.getElementById('pcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('pcPasswordInput').value.trim() || 'Nutanix.123';
            
            // Try to get account UUID from new simple dropdown first, then fall back to old dropdown
            let accountUuid = '';
            const simpleAccountSelect = document.getElementById('simpleAccountSelect');
            if (simpleAccountSelect && simpleAccountSelect.value) {
                accountUuid = simpleAccountSelect.value;
            } else if (accountDropdown) {
                accountUuid = accountDropdown.getValue();
            }
            
            const projectUuid = selectedProject ? selectedProject.uuid : '';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            if (!accountUuid) {
                showToast('Please select an account first', 'error');
                return;
            }
            
            // Try to get the simple fetch button first, then fall back to old one
            let fetchBtn = document.getElementById('simpleFetchImagesBtn');
            if (!fetchBtn) {
                fetchBtn = document.getElementById('fetchImagesBtn');
            }
            
            if (!fetchBtn) {
                console.error('No fetch images button found!');
                return;
            }
            
            const originalText = fetchBtn.innerHTML;
            fetchBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Fetching...';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        account_uuid: accountUuid,  // accountUuid is the original account UUID from account details
                        project_uuid: projectUuid
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    populateImageSelect(result.images);
                    showToast(`Fetched ${result.images.length} images`, 'success');
                } else {
                    showToast('Failed to fetch images: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error fetching images: ' + error.message, 'error');
            } finally {
                fetchBtn.innerHTML = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        // Initialize searchable dropdowns
        let imageDropdown = null;
        let runbookImageDropdown = null;
        let projectDropdown = null;
        let runbookProjectDropdown = null;
        
        function initializeImageDropdowns() {
            if (!imageDropdown) {
                imageDropdown = new SearchableDropdown('imageSelectContainer', {
                    placeholder: 'Select image...',
                    searchPlaceholder: 'Search images...',
                    noResultsText: 'No images found',
                    onSelect: (value, text, data) => {
                        console.log('Image selected:', data);
                    }
                });
            }
            
            if (!runbookImageDropdown) {
                runbookImageDropdown = new SearchableDropdown('runbookImageSelectContainer', {
                    placeholder: 'Select image...',
                    searchPlaceholder: 'Search images...',
                    noResultsText: 'No images found',
                    onSelect: (value, text, data) => {
                        console.log('Runbook image selected:', data);
                    }
                });
            }
        }
        
        function initializeProjectDropdowns() {
            if (!projectDropdown) {
                projectDropdown = new SearchableDropdown('projectSelectContainer', {
                    placeholder: 'Choose a project...',
                    searchPlaceholder: 'Search projects...',
                    noResultsText: 'No projects found',
                    onSelect: (value, text, itemData) => {
                        console.log('Project dropdown onSelect called:', { value, text, itemData });
                        
                        // Send log to backend
                        fetch('/api/log-frontend', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level: 'INFO',
                                message: `Frontend: Project dropdown onSelect triggered`,
                                data: { 
                                    value: value,
                                    text: text,
                                    has_item_data: !!itemData,
                                    has_project_data: !!(itemData && itemData.data)
                                }
                            })
                        }).catch(e => console.error('Failed to send log:', e));
                        
                        if (itemData && itemData.data) {
                            onProjectSelected(itemData.data);
                        } else {
                            console.error('Project data not found in dropdown selection');
                            
                            // Log error to backend
                            fetch('/api/log-frontend', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    level: 'ERROR',
                                    message: `Frontend: Project data not found in dropdown selection`,
                                    data: { value, text, itemData }
                                })
                            }).catch(e => console.error('Failed to send log:', e));
                        }
                    }
                });
            }
            
            if (!runbookProjectDropdown) {
                runbookProjectDropdown = new SearchableDropdown('runbookProjectSelectContainer', {
                    placeholder: 'Choose a project...',
                    searchPlaceholder: 'Search projects...',
                    noResultsText: 'No projects found',
                    onSelect: (value, text, itemData) => {
                        console.log('Runbook project dropdown onSelect called:', { value, text, itemData });
                        if (itemData && itemData.data) {
                            onRunbookProjectSelected(itemData.data);
                        } else {
                            console.error('Runbook project data not found in dropdown selection');
                        }
                    }
                });
            }
        }
        
        // NEW SIMPLE IMAGE POPULATION FUNCTION
        function populateSimpleImageSelect(images) {
            console.log('=== POPULATING SIMPLE IMAGE SELECT ===');
            console.log(`Received ${images.length} images`);
            
            const imageSelect = document.getElementById('simpleImageSelect');
            const imageCount = document.getElementById('imageCount');
            
            if (!imageSelect) {
                console.error('Simple image select element not found!');
                return;
            }
            
            // Clear existing options
            imageSelect.innerHTML = '<option value="">Select image...</option>';
            
            // Populate with images
            images.forEach((image, index) => {
                const option = document.createElement('option');
                option.value = image.uuid;
                option.textContent = image.name || `Unnamed Image ${index + 1}`;
                imageSelect.appendChild(option);
            });
            
            // Update count
            if (imageCount) {
                imageCount.textContent = images.length;
            }
            
            console.log(`Successfully populated ${images.length} images in simple dropdown`);
            
            // Send success log to backend
            fetch('/api/log-frontend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    level: 'INFO',
                    message: `Frontend: SIMPLE images populated successfully`,
                    data: { 
                        image_count: images.length,
                        first_few_images: images.slice(0, 5).map(img => ({
                            name: img.name,
                            uuid: img.uuid,
                            type: img.image_type
                        }))
                    }
                })
            }).catch(e => console.error('Failed to send log:', e));
        }
        
        function populateImageSelect(images) {
            // Use new simple approach first
            populateSimpleImageSelect(images);
            
            // Also populate old dropdown for backward compatibility
            if (!imageDropdown) {
                initializeImageDropdowns();
            }
            
            const dropdownData = images.map(image => ({
                value: image.uuid,
                text: image.name || 'Unnamed Image',
                subtext: `${image.image_type || 'DISK_IMAGE'}  ${formatFileSize(image.vmdisk_size)}`,
                data: image
            }));
            
            imageDropdown.setData(dropdownData);
        }
        
        function formatFileSize(bytes) {
            if (!bytes || bytes === '') return 'Unknown size';
            const size = parseInt(bytes);
            if (isNaN(size)) return 'Unknown size';
            
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let unitIndex = 0;
            let fileSize = size;
            
            while (fileSize >= 1024 && unitIndex < units.length - 1) {
                fileSize /= 1024;
                unitIndex++;
            }
            
            return `${fileSize.toFixed(1)} ${units[unitIndex]}`;
        }
        
        
        // ============================================================================
        // RUNBOOK LIVE UUID FUNCTIONS
        // ============================================================================
        
        let currentRunbookProjects = [];
        let selectedRunbookProject = null;
        
        async function testRunbookPCConnection() {
            const pcUrl = document.getElementById('runbookPcUrlInput').value.trim();
            const username = document.getElementById('runbookPcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('runbookPcPasswordInput').value.trim() || 'Nutanix.123';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            const testBtn = document.getElementById('runbookTestConnectionBtn');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Testing...';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('runbookConnectionStatus').style.display = 'block';
                
                if (result.success) {
                    document.getElementById('runbookConnectionSuccess').style.display = 'block';
                    document.getElementById('runbookConnectionError').style.display = 'none';
                    document.getElementById('runbookFetchProjectsBtn').disabled = false;
                    showToast('Connection successful!', 'success');
                } else {
                    document.getElementById('runbookConnectionSuccess').style.display = 'none';
                    document.getElementById('runbookConnectionError').style.display = 'block';
                    document.getElementById('runbookConnectionErrorText').textContent = result.message || result.error;
                    document.getElementById('runbookFetchProjectsBtn').disabled = true;
                    showToast('Connection failed: ' + (result.message || result.error), 'error');
                }
            } catch (error) {
                document.getElementById('runbookConnectionStatus').style.display = 'block';
                document.getElementById('runbookConnectionSuccess').style.display = 'none';
                document.getElementById('runbookConnectionError').style.display = 'block';
                document.getElementById('runbookConnectionErrorText').textContent = error.message;
                document.getElementById('runbookFetchProjectsBtn').disabled = true;
                showToast('Connection error: ' + error.message, 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }
        
        async function fetchRunbookProjects() {
            const pcUrl = document.getElementById('runbookPcUrlInput').value.trim();
            const username = document.getElementById('runbookPcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('runbookPcPasswordInput').value.trim() || 'Nutanix.123';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('runbookFetchProjectsBtn');
            const originalText = fetchBtn.innerHTML;
            fetchBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Fetching...';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentRunbookProjects = result.projects;
                    populateRunbookProjectSelect(result.projects);
                    document.getElementById('runbookProjectsSection').style.display = 'block';
                    showToast(`Fetched ${result.projects.length} projects`, 'success');
                } else {
                    showToast('Failed to fetch projects: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error fetching projects: ' + error.message, 'error');
            } finally {
                fetchBtn.innerHTML = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        function populateRunbookProjectSelect(projects) {
            if (!runbookProjectDropdown) {
                initializeProjectDropdowns();
            }
            
            const projectData = projects.map(project => ({
                value: project.uuid,
                text: project.name,
                subtext: project.uuid,
                data: project
            }));
            
            runbookProjectDropdown.setData(projectData);
        }
        
        function debouncedSearchRunbookProjects() {
            // Clear existing timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            // Set new timeout to delay the search
            searchTimeout = setTimeout(searchRunbookProjects, 500); // 500ms delay
        }
        
        async function searchRunbookProjects() {
            const searchTerm = document.getElementById('runbookProjectSearchInput').value.trim();
            const searchInput = document.getElementById('runbookProjectSearchInput');
            
            // If search term is empty, fetch all projects
            if (!searchTerm) {
                await fetchRunbookProjects();
                return;
            }
            
            // Show loading state
            searchInput.style.opacity = '0.7';
            searchInput.disabled = true;
            
            // Make API call with search filter
            try {
                const pcUrl = document.getElementById('runbookPcUrl').value;
                const username = document.getElementById('runbookUsername').value;
                const password = document.getElementById('runbookPassword').value;
                
                if (!pcUrl || !username || !password) {
                    showToast('Please fill in PC credentials first', 'error');
                    return;
                }
                
                console.log(`Searching runbook projects with term: "${searchTerm}"`);
                
                const response = await fetch('/api/live-uuid/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        search_term: searchTerm  // This will trigger the backend filter
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentRunbookProjects = result.projects;
                    populateRunbookProjectSelect(result.projects);
                    console.log(`Found ${result.projects.length} runbook projects matching "${searchTerm}"`);
                    showToast(`Found ${result.projects.length} projects matching "${searchTerm}"`, 'success');
                } else {
                    console.error('Runbook search failed:', result.error);
                    showToast(`Search failed: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('Error searching runbook projects:', error);
                showToast('Error searching runbook projects', 'error');
            } finally {
                // Restore input state
                searchInput.style.opacity = '1';
                searchInput.disabled = false;
            }
        }
        
        function onRunbookProjectSelected(project = null) {
            if (project) {
                selectedRunbookProject = project;
                populateRunbookProjectResources(selectedRunbookProject.resources);
                document.getElementById('runbookProjectResourcesSection').style.display = 'block';
                document.getElementById('runbookFetchImagesBtn').disabled = false;
                console.log('Runbook project selected:', selectedRunbookProject.name);
            } else {
                selectedRunbookProject = null;
                document.getElementById('runbookProjectResourcesSection').style.display = 'none';
                document.getElementById('runbookFetchImagesBtn').disabled = true;
            }
        }
        
        function populateRunbookProjectResources(resources) {
            initializeRunbookResourceDropdowns();
            
            // Populate account dropdown
            const accountData = (resources.account_reference_list || []).map(account => ({
                value: account.uuid,
                text: account.name || account.uuid,
                subtext: account.uuid,
                data: account
            }));
            runbookAccountDropdown.setData(accountData);
            
            // Populate cluster dropdown
            const clusterData = (resources.cluster_reference_list || []).map(cluster => ({
                value: cluster.uuid,
                text: cluster.name || cluster.uuid,
                subtext: cluster.uuid,
                data: cluster
            }));
            runbookClusterDropdown.setData(clusterData);
            
            // Populate environment dropdown
            const environmentSelect = document.getElementById('runbookEnvironmentSelect');
            environmentSelect.innerHTML = '<option value="">Select environment...</option>';
            (resources.environment_reference_list || []).forEach(env => {
                const option = document.createElement('option');
                option.value = env.uuid;
                option.textContent = env.name || env.uuid;
                environmentSelect.appendChild(option);
            });
            
            // Set default environment if available
            if (resources.default_environment_reference && resources.default_environment_reference.uuid) {
                environmentSelect.value = resources.default_environment_reference.uuid;
            }
            
            // Populate network dropdown
            const networkSelect = document.getElementById('runbookNetworkSelect');
            networkSelect.innerHTML = '<option value="">Select network...</option>';
            (resources.external_network_list || []).forEach(network => {
                const option = document.createElement('option');
                option.value = network.uuid;
                option.textContent = network.name || network.uuid;
                networkSelect.appendChild(option);
            });
            
            // Populate subnet dropdown
            const subnetSelect = document.getElementById('runbookSubnetSelect');
            subnetSelect.innerHTML = '<option value="">Select subnet...</option>';
            (resources.subnet_reference_list || []).forEach(subnet => {
                const option = document.createElement('option');
                option.value = subnet.uuid;
                option.textContent = subnet.name || subnet.uuid;
                subnetSelect.appendChild(option);
            });
        }
        
        async function fetchRunbookImages() {
            const pcUrl = document.getElementById('runbookPcUrlInput').value.trim();
            const username = document.getElementById('runbookPcUsernameInput').value.trim() || 'admin';
            const password = document.getElementById('runbookPcPasswordInput').value.trim() || 'Nutanix.123';
            const accountUuid = runbookAccountDropdown ? runbookAccountDropdown.getValue() : '';
            const projectUuid = selectedRunbookProject ? selectedRunbookProject.uuid : '';
            
            if (!pcUrl) {
                showToast('Please enter a PC URL', 'error');
                return;
            }
            
            if (!accountUuid) {
                showToast('Please select an account first', 'error');
                return;
            }
            
            const fetchBtn = document.getElementById('runbookFetchImagesBtn');
            const originalText = fetchBtn.innerHTML;
            fetchBtn.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Fetching...';
            fetchBtn.disabled = true;
            
            try {
                const response = await fetch('/api/live-uuid/images', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pc_url: pcUrl,
                        username: username,
                        password: password,
                        account_uuid: accountUuid,  // For runbooks, this should also be original account UUID
                        project_uuid: projectUuid
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    populateRunbookImageSelect(result.images);
                    showToast(`Fetched ${result.images.length} images`, 'success');
                } else {
                    showToast('Failed to fetch images: ' + result.error, 'error');
                }
            } catch (error) {
                showToast('Error fetching images: ' + error.message, 'error');
            } finally {
                fetchBtn.innerHTML = originalText;
                fetchBtn.disabled = false;
            }
        }
        
        function populateRunbookImageSelect(images) {
            if (!runbookImageDropdown) {
                initializeImageDropdowns();
            }
            
            const dropdownData = images.map(image => ({
                value: image.uuid,
                text: image.name || 'Unnamed Image',
                subtext: `${image.image_type || 'DISK_IMAGE'}  ${formatFileSize(image.vmdisk_size)}`,
                data: image
            }));
            
            runbookImageDropdown.setData(dropdownData);
        }
        
        // Helper function to get selected UUIDs for runbook use in payload generation
        function getSelectedRunbookLiveUUIDs() {
            return {
                project: {
                    uuid: selectedRunbookProject ? selectedRunbookProject.uuid : '',
                    name: selectedRunbookProject ? selectedRunbookProject.name : ''
                },
                account: {
                    uuid: runbookAccountDropdown ? runbookAccountDropdown.getValue() : '',
                    name: runbookAccountDropdown ? runbookAccountDropdown.getText() : ''
                },
                cluster: {
                    uuid: runbookClusterDropdown ? runbookClusterDropdown.getValue() : '',
                    name: runbookClusterDropdown ? runbookClusterDropdown.getText() : ''
                },
                environment: {
                    uuid: document.getElementById('runbookEnvironmentSelect').value,
                    name: document.getElementById('runbookEnvironmentSelect').selectedOptions[0]?.textContent || ''
                },
                network: {
                    uuid: document.getElementById('runbookNetworkSelect').value,
                    name: document.getElementById('runbookNetworkSelect').selectedOptions[0]?.textContent || ''
                },
                subnet: {
                    uuid: document.getElementById('runbookSubnetSelect').value,
                    name: document.getElementById('runbookSubnetSelect').selectedOptions[0]?.textContent || ''
                },
                image: {
                    uuid: runbookImageDropdown ? runbookImageDropdown.getValue() : '',
                    name: runbookImageDropdown ? runbookImageDropdown.getText() : ''
                }
            };
        }
        
        async function analyzePayloadForRules() {
            const payload = document.getElementById('rulesPayloadInput').value.trim();
            const apiType = document.getElementById('apiTypeSelect').value;
            
            if (!payload) {
                showToast('Please enter a JSON payload', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Always use "blueprint" as entity name for blueprint type
                if (apiType === 'blueprint') {
                    rulesEntityName = 'blueprint';
                } else {
                rulesEntityName = generateEntityName(payload, apiType);
                }
                rulesExistingEntity = null;
                
                const response = await fetch('/api/rules/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payload, api_url: rulesEntityName, api_type: apiType })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                rulesOriginalPayload = data.original_payload;
                rulesEntities = data.entities;
                
                // Update dropdown if API type was auto-detected from payload
                const detectedType = data.detected_api_type;
                if (detectedType && detectedType !== apiType) {
                    document.getElementById('apiTypeSelect').value = detectedType;
                    // Always use "blueprint" for blueprint type
                    if (detectedType === 'blueprint') {
                        rulesEntityName = 'blueprint';
                    } else {
                    rulesEntityName = generateEntityName(payload, detectedType);
                    }
                    showToast(`Auto-detected entity type: ${detectedType}`, 'info');
                }
                
                // Check if entity already exists
                await checkExistingEntity(rulesEntityName);
                
                // Initialize temp counts
                rulesTempCounts = {};
                rulesEntities.forEach(e => rulesTempCounts[e.path] = e.current_count);
                
                // Load default rules for detected type
                await loadDefaultRules(detectedType || apiType);
                
                // Render UI
                renderRulesEntities();
                renderRulesRulesList();
                
                // Go to step 2
                goToRulesStep(2);
                
                showLoading(false);
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        async function checkExistingEntity(entityName) {
            try {
                const response = await fetch(`/api/rules/${encodeURIComponent(entityName)}?include_template=true`);
                if (response.ok) {
                    rulesExistingEntity = await response.json();
                    
                    // Load existing rules and merge with any new ones
                    if (rulesExistingEntity.rules && rulesExistingEntity.rules.length > 0) {
                        // Mark existing rules
                        const existingRules = rulesExistingEntity.rules.map(r => ({
                            ...r,
                            isExisting: true
                        }));
                        
                        // Merge: existing rules + new custom rules (avoid duplicates)
                        const newRulesJson = rulesCustomRules.map(r => JSON.stringify(r));
                        const mergedRules = [...existingRules];
                        
                        rulesCustomRules.forEach(newRule => {
                            const newRuleJson = JSON.stringify({...newRule, isExisting: undefined});
                            const isDuplicate = existingRules.some(existing => {
                                const existingJson = JSON.stringify({...existing, isExisting: undefined});
                                return existingJson === newRuleJson;
                            });
                            if (!isDuplicate) {
                                mergedRules.push({...newRule, isNew: true});
                            }
                        });
                        
                        rulesCustomRules = mergedRules;
                        showToast(`Loaded ${existingRules.length} existing rules for "${entityName}"`, 'info');
                    }
                }
            } catch (e) {
                // Entity doesn't exist, that's fine
                rulesExistingEntity = null;
            }
        }
        
        function renderRulesEntities() {
            const activeEntities = rulesEntities.filter(e => rulesTempCounts[e.path] > 0);
            const tree = buildEntityTree(activeEntities);
            const container = document.getElementById('rulesEntitiesTree');
            
            let html = '';
            Object.values(tree.children).forEach(node => {
                html += renderTreeNode(node, 0, 'rules');
            });
            container.innerHTML = html || '<p style="color: var(--text-secondary)">No active entities</p>';
            
            // Update entity count badge
            document.getElementById('rulesEntitiesBadge').textContent = activeEntities.length;
            
            renderRulesExcluded();
        }
        
        function renderRulesExcluded() {
            const excluded = rulesEntities.filter(e => rulesTempCounts[e.path] === 0);
            const section = document.getElementById('rulesExcludedSection');
            const list = document.getElementById('rulesExcludedList');
            const badge = document.getElementById('rulesExcludedBadge');
            
            if (excluded.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            badge.textContent = excluded.length;
            
            list.innerHTML = excluded.map(e => `
                <div class="excluded-item">
                    <span class="excluded-path">${e.path}</span>
                    <button class="restore-btn" onclick="restoreRulesEntity('${e.path}')">
                        <i class="bi bi-plus-circle me-1"></i> Restore
                    </button>
                        </div>
            `).join('');
        }
        
        function updateRulesTempCount(path, value) {
            rulesTempCounts[path] = parseInt(value) || 0;
            if (rulesTempCounts[path] === 0) {
                // Just update the excluded list, don't re-render entire tree
                updateRulesEntityVisibility(path, false);
            }
            // Update the badge count display
            const nodeId = `rules_${path.replace(/\./g, '_')}`;
            const badge = document.querySelector(`#toggle_${nodeId}`)?.closest('.tree-node-header')?.querySelector('.entity-count-badge');
            if (badge) {
                badge.textContent = `${rulesTempCounts[path]} items`;
            }
        }
        
        function updateRulesEntityVisibility(path, visible) {
            const nodeId = `rules_${path.replace(/\./g, '_')}`;
            const node = document.getElementById(`toggle_${nodeId}`)?.closest('.tree-node');
            
            if (!visible && node) {
                // Hide the node
                node.style.display = 'none';
            } else if (visible && node) {
                node.style.display = 'block';
            }
            
            // Re-render excluded list only
            renderRulesExcluded();
        }
        
        function excludeRulesEntity(path) {
            rulesTempCounts[path] = 0;
            updateRulesEntityVisibility(path, false);
        }
        
        function restoreRulesEntity(path) {
            rulesTempCounts[path] = 1;
            // Show the node again
            const nodeId = `rules_${path.replace(/\./g, '_')}`;
            const node = document.getElementById(`toggle_${nodeId}`)?.closest('.tree-node');
            
            if (node) {
                node.style.display = 'block';
                renderRulesExcluded();
            } else {
                // Node doesn't exist, need to re-render
                renderRulesEntities();
            }
        }
        
        function renderRulesRulesList() {
            const container = document.getElementById('rulesRulesList');
            const allRules = [
                ...rulesDefaultRules.map(r => ({...r, isDefault: true})),
                ...rulesCustomRules
            ];
            
            // Count by type
            const defaultCount = rulesDefaultRules.length;
            const existingCount = rulesCustomRules.filter(r => r.isExisting).length;
            const newCount = rulesCustomRules.filter(r => r.isNew).length;
            const customCount = rulesCustomRules.filter(r => !r.isExisting && !r.isNew).length;
            
            document.getElementById('rulesRulesBadge').textContent = allRules.length;
            
            if (allRules.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary)">No rules defined</p>';
                return;
            }

            // Add summary header if there are existing rules
            let summaryHtml = '';
            if (existingCount > 0 || newCount > 0) {
                summaryHtml = `
                    <div class="rules-summary">
                        ${existingCount > 0 ? `<span class="rules-summary-item existing"><i class="bi bi-database"></i> ${existingCount} existing</span>` : ''}
                        ${newCount > 0 ? `<span class="rules-summary-item new"><i class="bi bi-plus-circle"></i> ${newCount} new</span>` : ''}
                        ${customCount > 0 ? `<span class="rules-summary-item custom"><i class="bi bi-pencil"></i> ${customCount} custom</span>` : ''}
                        ${defaultCount > 0 ? `<span class="rules-summary-item default"><i class="bi bi-shield"></i> ${defaultCount} default</span>` : ''}
                    </div>
                `;
            }

            container.innerHTML = summaryHtml + allRules.map((rule, idx) => {
                const isDefault = rule.isDefault;
                const isExisting = rule.isExisting;
                const isNew = rule.isNew;
                
                let badgeClass = 'bg-primary';
                let badgeText = 'CUSTOM';
                let itemClass = '';
                
                if (isDefault) {
                    badgeClass = 'bg-secondary';
                    badgeText = 'DEFAULT';
                    itemClass = 'default-rule';
                } else if (isExisting) {
                    badgeClass = 'bg-info';
                    badgeText = 'EXISTING';
                    itemClass = 'existing-rule';
                } else if (isNew) {
                    badgeClass = 'bg-success';
                    badgeText = 'NEW';
                    itemClass = 'new-rule';
                }
                
                const customIdx = idx - rulesDefaultRules.length;
                const canDelete = !isDefault; // Can delete existing, new, and custom rules
                
                return `
                    <div class="rule-item ${itemClass}">
                        ${canDelete ? `<button class="rule-delete-btn" onclick="deleteRulesRule(${customIdx})" title="Delete rule"><i class="bi bi-trash"></i></button>` : ''}
                        <span class="badge ${badgeClass} me-2">${badgeText}</span>
                        <span class="rule-type-badge" style="background:${getRuleColor(rule.type)}">${rule.type.toUpperCase().replace('_', ' ')}</span>
                        ${getRuleDescription(rule)}
                    </div>
                `;
            }).join('');
        }
        
        function deleteRulesRule(idx) {
            if (idx >= 0 && idx < rulesCustomRules.length) {
                const deletedRule = rulesCustomRules[idx];
                rulesCustomRules.splice(idx, 1);
                renderRulesRulesList();
                
                // Show toast with rule type info
                const ruleType = deletedRule.isExisting ? 'existing' : (deletedRule.isNew ? 'new' : 'custom');
                showToast(`Deleted ${ruleType} rule`, 'info');
            }
        }
        
        async function previewRulesPayload() {
            showLoading(true);
            
            try {
                const allRules = [...rulesDefaultRules, ...rulesCustomRules];
                const apiType = document.getElementById('apiTypeSelect').value;
                // Task execution is set when saving rules, use 'parallel' for preview in Section 1
                const taskExecution = document.getElementById('rulesTaskExecutionSelect')?.value || 'parallel';
                
                // Read profile options for blueprints
                const profileOptions = {
                    action_list: parseInt(document.getElementById('rulesProfileActionCount')?.value) || 0,
                    snapshot_config_list: parseInt(document.getElementById('rulesSnapshotConfigCount')?.value) || 0,
                    restore_config_list: parseInt(document.getElementById('rulesRestoreConfigCount')?.value) || 0,
                    patch_list: parseInt(document.getElementById('rulesPatchListCount')?.value) || 0
                };
                
                const response = await fetch('/api/rules/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        original_payload: rulesOriginalPayload,
                        entity_counts: rulesTempCounts,
                        rules: allRules,
                        api_type: apiType,
                        task_execution: taskExecution,
                        profile_options: profileOptions
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                rulesPreviewData = data.preview_payload;
                document.getElementById('rulesPreviewPayload').textContent = data.formatted_payload;
                
                goToRulesStep(3);
                showLoading(false);
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        async function acceptAndSaveRules() {
            const apiType = document.getElementById('apiTypeSelect').value;
            const taskExecution = document.getElementById('rulesTaskExecutionSelect')?.value || 'parallel';
            
            // If entity exists, show diff modal first
            if (rulesExistingEntity) {
                showEntityDiffModal();
                return;
            }
            
            await saveEntityRules();
        }
        
        async function saveEntityRules() {
            const apiType = document.getElementById('apiTypeSelect').value;
            const taskExecution = document.getElementById('rulesTaskExecutionSelect')?.value || 'parallel';
            
            showLoading(true);
            
            try {
                // Clean rules - remove isExisting, isNew flags before saving
                const cleanedRules = rulesCustomRules.map(rule => {
                    const { isExisting, isNew, ...cleanRule } = rule;
                    return cleanRule;
                });
                
                const response = await fetch('/api/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: rulesEntityName,
                        api_type: apiType,
                        rules: cleanedRules,  // Merged rules (existing + new), not defaults
                        payload_template: rulesOriginalPayload,
                        scalable_entities: rulesEntities.map(e => e.path),
                        task_execution: taskExecution,  // For runbooks: 'parallel' or 'series'
                        save_history: !!rulesExistingEntity  // Save history if updating existing entity
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                showLoading(false);
                
                const existingCount = rulesCustomRules.filter(r => r.isExisting).length;
                const newCount = rulesCustomRules.filter(r => r.isNew).length;
                
                if (rulesExistingEntity) {
                    showToast(`Entity "${rulesEntityName}" updated! (${existingCount} existing + ${newCount} new rules)`);
                } else {
                    showToast(`Entity "${rulesEntityName}" saved!`);
                }
                
                // Reload API list and go to welcome
                loadAllApis();
                showSection('welcome');
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        function showEntityDiffModal() {
            // Count rules by type
            const existingCount = rulesCustomRules.filter(r => r.isExisting).length;
            const newCount = rulesCustomRules.filter(r => r.isNew).length;
            const deletedCount = (rulesExistingEntity.rules || []).length - existingCount;
            
            // Create the diff modal content
            const oldData = rulesExistingEntity;
            const newData = {
                rules: rulesCustomRules,
                scalable_entities: rulesEntities.map(e => e.path),
                payload_template: rulesOriginalPayload
            };
            
            const diffHtml = generateDiffHtml(oldData, newData);
            
            const modal = document.createElement('div');
            modal.className = 'diff-modal-overlay';
            modal.id = 'diffModal';
            modal.innerHTML = `
                <div class="diff-modal">
                    <div class="diff-modal-header">
                        <h4><i class="bi bi-git me-2"></i>Entity Already Exists: ${rulesEntityName}</h4>
                        <button class="btn-close-modal" onclick="closeDiffModal()">&times;</button>
                    </div>
                    <div class="diff-modal-body">
                        <div class="diff-info-box" style="background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3);">
                            <i class="bi bi-check-circle" style="color: var(--accent-green);"></i>
                            <span>Rules have been merged! Existing rules are preserved. You can delete any rule from the rules list.</span>
                        </div>
                        <div class="rules-merge-summary">
                            <div class="merge-stat">
                                <span class="merge-stat-value" style="color: #0dcaf0;">${existingCount}</span>
                                <span class="merge-stat-label">Existing Rules Kept</span>
                            </div>
                            <div class="merge-stat">
                                <span class="merge-stat-value" style="color: var(--accent-green);">${newCount}</span>
                                <span class="merge-stat-label">New Rules Added</span>
                            </div>
                            <div class="merge-stat">
                                <span class="merge-stat-value">${existingCount + newCount}</span>
                                <span class="merge-stat-label">Total Rules</span>
                            </div>
                        </div>
                        <div class="diff-container">
                            ${diffHtml}
                        </div>
                    </div>
                    <div class="diff-modal-footer">
                        <button class="btn btn-outline-secondary" onclick="closeDiffModal()">
                            <i class="bi bi-x me-2"></i>Cancel
                        </button>
                        <button class="btn btn-outline-primary" onclick="closeDiffModal(); goToRulesStep(2);">
                            <i class="bi bi-pencil me-2"></i>Edit Rules
                        </button>
                        <button class="btn btn-primary" onclick="viewEntityHistory()">
                            <i class="bi bi-clock-history me-2"></i>View History
                        </button>
                        <button class="btn btn-success" onclick="confirmSaveWithHistory()">
                            <i class="bi bi-check me-2"></i>Save & Update
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function generateDiffHtml(oldData, newData) {
            let html = '';
            
            // Compare rules
            const oldRules = JSON.stringify(oldData.rules || [], null, 2);
            const newRules = JSON.stringify(newData.rules || [], null, 2);
            
            if (oldRules !== newRules) {
                html += `
                    <div class="diff-section">
                        <h6><i class="bi bi-sliders text-warning"></i> Rules Changed</h6>
                        <div class="diff-comparison">
                            <div class="diff-old">
                                <span class="diff-label">Previous (${(oldData.rules || []).length} rules)</span>
                                <pre>${escapeHtml(oldRules)}</pre>
                            </div>
                            <div class="diff-arrow"><i class="bi bi-arrow-right"></i></div>
                            <div class="diff-new">
                                <span class="diff-label">New (${(newData.rules || []).length} rules)</span>
                                <pre>${escapeHtml(newRules)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Compare scalable entities
            const oldEntities = (oldData.scalable_entities || []).sort();
            const newEntities = (newData.scalable_entities || []).sort();
            
            if (JSON.stringify(oldEntities) !== JSON.stringify(newEntities)) {
                const added = newEntities.filter(e => !oldEntities.includes(e));
                const removed = oldEntities.filter(e => !newEntities.includes(e));
                
                html += `
                    <div class="diff-section">
                        <h6><i class="bi bi-diagram-2 text-primary"></i> Scalable Entities Changed</h6>
                        <div class="entity-changes">
                            ${added.length > 0 ? `<div class="added-entities"><span class="badge bg-success">+${added.length} Added</span> ${added.map(e => `<code>${e}</code>`).join(', ')}</div>` : ''}
                            ${removed.length > 0 ? `<div class="removed-entities"><span class="badge bg-danger">-${removed.length} Removed</span> ${removed.map(e => `<code>${e}</code>`).join(', ')}</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            // If no changes detected
            if (!html) {
                html = `
                    <div class="diff-section">
                        <div class="no-changes">
                            <i class="bi bi-check-circle text-success"></i>
                            <span>No significant changes detected. Payload template will be updated.</span>
                        </div>
                    </div>
                `;
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function closeDiffModal() {
            const modal = document.getElementById('diffModal');
            if (modal) modal.remove();
        }
        
        async function confirmSaveWithHistory() {
            closeDiffModal();
            showLoading(true);
            
            try {
                // Save with history (backend will handle versioning)
                const apiType = document.getElementById('apiTypeSelect').value;
                const taskExecution = document.getElementById('rulesTaskExecutionSelect')?.value || 'parallel';
                
                // Clean rules - remove isExisting, isNew flags before saving
                const cleanedRules = rulesCustomRules.map(rule => {
                    const { isExisting, isNew, ...cleanRule } = rule;
                    return cleanRule;
                });
                
                const response = await fetch('/api/rules/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: rulesEntityName,
                        api_type: apiType,
                        rules: cleanedRules,  // Merged rules (existing + new)
                        payload_template: rulesOriginalPayload,
                        scalable_entities: rulesEntities.map(e => e.path),
                        task_execution: taskExecution,
                        save_history: true  // Flag to save previous version to history
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                showLoading(false);
                
                const existingCount = rulesCustomRules.filter(r => r.isExisting).length;
                const newCount = rulesCustomRules.filter(r => r.isNew).length;
                showToast(`Entity "${rulesEntityName}" updated! (${existingCount} existing + ${newCount} new rules). Previous version saved to history.`);
                
                loadAllApis();
                showSection('welcome');
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        async function viewEntityHistory() {
            closeDiffModal();
            showHistoryModal(rulesEntityName);
        }
        
        async function showHistoryModal(entityName) {
            showLoading(true);
            
            try {
                const response = await fetch(`/api/rules/${encodeURIComponent(entityName)}/history`);
                const data = await response.json();
                
                showLoading(false);
                
                const historyItems = data.history || [];
                
                let historyHtml = '';
                if (historyItems.length === 0) {
                    historyHtml = `
                        <div class="history-empty">
                            <i class="bi bi-clock"></i>
                            <div>No history available</div>
                            <small>Changes will be recorded when you update this entity</small>
                        </div>
                    `;
                } else {
                    historyHtml = `
                        <div class="history-list">
                            ${historyItems.map((item, idx) => `
                                <div class="history-item">
                                    <div class="history-item-info">
                                        <div class="history-item-date">
                                            <i class="bi bi-clock-history me-2"></i>
                                            ${new Date(item.timestamp).toLocaleString()}
                                        </div>
                                        <div class="history-item-meta">
                                            <span><i class="bi bi-sliders"></i> ${item.rules_count} rules</span>
                                            <span><i class="bi bi-diagram-2"></i> ${item.entities_count} entities</span>
                                            ${item.version ? `<span>v${item.version}</span>` : ''}
                                        </div>
                                    </div>
                                    <div class="history-item-actions">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="previewHistoryVersion('${entityName}', ${idx})">
                                            <i class="bi bi-eye"></i> Preview
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="restoreHistoryVersion('${entityName}', ${idx})">
                                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                const modal = document.createElement('div');
                modal.className = 'diff-modal-overlay';
                modal.id = 'historyModal';
                modal.innerHTML = `
                    <div class="history-modal">
                        <div class="diff-modal-header">
                            <h4><i class="bi bi-clock-history me-2"></i>History: ${entityName}</h4>
                            <button class="btn-close-modal" onclick="closeHistoryModal()">&times;</button>
                        </div>
                        <div class="diff-modal-body">
                            ${historyHtml}
                        </div>
                        <div class="diff-modal-footer">
                            <button class="btn btn-outline-secondary" onclick="closeHistoryModal()">
                                <i class="bi bi-x me-2"></i>Close
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (e) {
                showLoading(false);
                showToast('Failed to load history: ' + e.message, 'error');
            }
        }
        
        function closeHistoryModal() {
            const modal = document.getElementById('historyModal');
            if (modal) modal.remove();
        }
        
        async function previewHistoryVersion(entityName, versionIndex) {
            showLoading(true);
            
            try {
                const response = await fetch(`/api/rules/${encodeURIComponent(entityName)}/history/${versionIndex}`);
                const data = await response.json();
                
                showLoading(false);
                
                if (!response.ok) throw new Error(data.error);
                
                // Show preview in a simple modal
                const previewModal = document.createElement('div');
                previewModal.className = 'diff-modal-overlay';
                previewModal.id = 'previewModal';
                previewModal.innerHTML = `
                    <div class="diff-modal">
                        <div class="diff-modal-header">
                            <h4><i class="bi bi-eye me-2"></i>Version Preview</h4>
                            <button class="btn-close-modal" onclick="document.getElementById('previewModal').remove()">&times;</button>
                        </div>
                        <div class="diff-modal-body">
                            <pre style="font-size: 12px; font-family: 'JetBrains Mono', monospace; color: var(--text-primary); max-height: 400px; overflow: auto;">${JSON.stringify(data.version_data, null, 2)}</pre>
                        </div>
                        <div class="diff-modal-footer">
                            <button class="btn btn-outline-secondary" onclick="document.getElementById('previewModal').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(previewModal);
                
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        async function restoreHistoryVersion(entityName, versionIndex) {
            if (!confirm('Restore this version? Current version will be saved to history.')) return;
            
            showLoading(true);
            
            try {
                const response = await fetch(`/api/rules/${encodeURIComponent(entityName)}/restore/${versionIndex}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                showLoading(false);
                
                if (!response.ok) throw new Error(data.error);
                
                closeHistoryModal();
                showToast(`Version restored for "${entityName}"!`);
                loadAllApis();
                
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        function copyPreviewPayload() {
            navigator.clipboard.writeText(document.getElementById('rulesPreviewPayload').textContent)
                .then(() => showToast('Copied!'))
                .catch(() => showToast('Failed to copy', 'error'));
        }
        
        function downloadPreviewPayload() {
            if (!rulesPreviewData) return;
            const blob = new Blob([JSON.stringify(rulesPreviewData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'preview_payload.json';
            link.click();
        }
        
        // ============================================================================
        // SECTION 2: CREATE ENTITIES
        // ============================================================================
        
        // ============================================================================
        // APP SWITCHER & HIERARCHY BUILDER
        // ============================================================================
        
        let currentAppType = 'blueprint';
        let selectedBlueprintEntity = null;
        let selectedRunbookEntity = null;
        let blueprintType = 'multi_vm';
        let taskExecution = 'parallel';
        let blueprintEntityCounts = {
            app_profile_list: 1,
            deployment_create_list: 1,
            service_definition_list: 1,
            substrate_definition_list: 1,  // Calculated: app_profiles  deployments
            package_definition_list: 1,    // Calculated: app_profiles  deployments
            credential_definition_list: 1
        };
        // App Profile optional features (0 = exclude from payload)
        let blueprintProfileOptions = {
            action_list: 0,
            snapshot_config_list: 0,
            restore_config_list: 0,
            patch_list: 0
        };
        let runbookEntityCounts = {
            task_definition_list: 1,
            endpoint_definition_list: 1,
            credential_definition_list: 1
        };
        
        function switchAppType(type) {
            currentAppType = type;
            
            // Update tab buttons
            document.querySelectorAll('.app-switcher-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.type === type);
            });
            
            // Show/hide panels
            document.getElementById('blueprintConfigPanel').classList.toggle('section-hidden', type !== 'blueprint');
            document.getElementById('runbookConfigPanel').classList.toggle('section-hidden', type !== 'runbook');
            
            // Load appropriate entity list
            if (type === 'blueprint') {
                loadBlueprintEntityList();
            } else {
                loadRunbookEntityList();
            }
        }
        
        function loadBlueprintEntityList() {
            // Auto-select blueprint entity
            selectedBlueprintEntity = 'blueprint';
            document.getElementById('blueprintHierarchyBuilder').classList.remove('section-hidden');
            document.getElementById('selectedBlueprintName').textContent = 'blueprint';
            console.log('Auto-selected blueprint entity');
        }
        
        function loadRunbookEntityList() {
            // Auto-select runbook entity if available
            const runbooks = allApis.filter(api => api.api_type === 'runbook');
            if (runbooks.length > 0) {
                selectedRunbookEntity = runbooks[0].api_url;
                document.getElementById('runbookHierarchyBuilder').classList.remove('section-hidden');
                document.getElementById('selectedRunbookName').textContent = runbooks[0].api_url;
                console.log('Auto-selected runbook entity:', runbooks[0].api_url);
            }
        }
        
        // Modal functions for showing rules and entities
        function showBlueprintRulesModal() {
            fetch('/api/rules')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const blueprint = data.apis.find(api => api.api_url === 'blueprint');
                        if (blueprint) {
                            showRulesModal('Blueprint', blueprint);
                        } else {
                            showToast('Blueprint configuration not found', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading blueprint rules:', error);
                    showToast('Error loading blueprint rules', 'error');
                });
        }
        
        function showRunbookRulesModal() {
            fetch('/api/rules')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const runbooks = data.apis.filter(api => api.api_type === 'runbook');
                        if (runbooks.length > 0) {
                            showRulesModal('Runbook', runbooks[0]);
                        } else {
                            showToast('No runbook configurations found', 'error');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading runbook rules:', error);
                    showToast('Error loading runbook rules', 'error');
                });
        }
        
        function showRulesModal(type, config) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color);">
                        <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                            <h5 class="modal-title">
                                <i class="bi bi-${type === 'Blueprint' ? 'diagram-3' : 'play-circle'}"></i>
                                ${type} Configuration: ${config.api_url}
                            </h5>
                            <button type="button" class="btn-close" onclick="closeRulesModal()" style="filter: invert(1);"></button>
                    </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="bi bi-sliders"></i> Rules (${config.rules_count || 0})</h6>
                                    <div class="rules-list" style="max-height: 300px; overflow-y: auto;">
                                        ${config.rules_count > 0 ? 
                                            '<div class="alert alert-success"><i class="bi bi-check-circle"></i> Custom transformation rules configured</div>' :
                                            '<div class="alert alert-info"><i class="bi bi-info-circle"></i> Using default rules only</div>'
                                        }
                    </div>
                </div>
                                <div class="col-md-6">
                                    <h6><i class="bi bi-diagram-2"></i> Scalable Entities (${config.scalable_entities_count || 0})</h6>
                                    <div class="entities-list" style="max-height: 300px; overflow-y: auto;">
                                        ${(config.scalable_entities || []).map(entity => 
                                            `<div class="entity-item" style="padding: 8px; margin: 4px 0; background: var(--bg-sidebar); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 12px;">
                                                ${entity}
                                            </div>`
                                        ).join('') || '<div class="alert alert-warning">No scalable entities found</div>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                            <button type="button" class="btn btn-secondary" onclick="closeRulesModal()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeRulesModal() {
            const modal = document.querySelector('.modal.show');
            if (modal) {
                modal.remove();
            }
        }
        
        async function selectBlueprintEntity(encodedUrl) {
            const apiUrl = decodeURIComponent(encodedUrl);
            selectedBlueprintEntity = apiUrl;
            
            // Show hierarchy builder
            document.getElementById('blueprintHierarchyBuilder').classList.remove('section-hidden');
            document.getElementById('selectedBlueprintName').textContent = apiUrl;
            
            // Mark card as selected
            document.querySelectorAll('#blueprintEntityList .entity-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (event?.currentTarget) {
                event.currentTarget.classList.add('selected');
            }
            
            // Reset counts to defaults - NEW HIERARCHY
            blueprintEntityCounts = {
                app_profile_list: 1,
                deployment_create_list: 1,
                service_definition_list: 1,
                substrate_definition_list: 1,
                package_definition_list: 1,
                credential_definition_list: 1
            };
            
            // Reset profile options to defaults (0 = exclude)
            blueprintProfileOptions = {
                action_list: 0,
                snapshot_config_list: 0,
                restore_config_list: 0,
                patch_list: 0
            };
            
            // Reset UI inputs
            const appProfileInput = document.getElementById('appProfileCountInput');
            const deploymentInput = document.getElementById('deploymentCountInput');
            const serviceInput = document.getElementById('serviceCountInput');
            const credentialInput = document.querySelector('#blueprintHierarchyBuilder input[data-entity="credential_definition_list"]');
            
            if (appProfileInput) appProfileInput.value = 1;
            if (deploymentInput) deploymentInput.value = 1;
            if (serviceInput) serviceInput.value = 1;
            if (credentialInput) credentialInput.value = 1;
            
            // Reset profile option inputs
            const profileActionInput = document.getElementById('profileActionCount');
            const snapshotConfigInput = document.getElementById('snapshotConfigCount');
            const restoreConfigInput = document.getElementById('restoreConfigCount');
            const patchListInput = document.getElementById('patchListCount');
            
            if (profileActionInput) profileActionInput.value = 0;
            if (snapshotConfigInput) snapshotConfigInput.value = 0;
            if (restoreConfigInput) restoreConfigInput.value = 0;
            if (patchListInput) patchListInput.value = 0;
            
            // Reset blueprint type to multi_vm and enable all controls
            setBlueprintType('multi_vm');
            
            // Update calculated counts display
            updateCalculatedCounts();
        }
        
        async function selectRunbookEntity(encodedUrl) {
            const apiUrl = decodeURIComponent(encodedUrl);
            selectedRunbookEntity = apiUrl;
            
            // Show hierarchy builder
            document.getElementById('runbookHierarchyBuilder').classList.remove('section-hidden');
            document.getElementById('selectedRunbookName').textContent = apiUrl;
            
            // Mark card as selected
            document.querySelectorAll('#runbookEntityList .entity-select-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }
        
        function backToBlueprintSelection() {
            document.getElementById('blueprintHierarchyBuilder').classList.add('section-hidden');
            selectedBlueprintEntity = null;
            document.querySelectorAll('#blueprintEntityList .entity-select-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        function backToRunbookSelection() {
            document.getElementById('runbookHierarchyBuilder').classList.add('section-hidden');
            selectedRunbookEntity = null;
            document.querySelectorAll('#runbookEntityList .entity-select-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        function setBlueprintType(type) {
            blueprintType = type;
            document.querySelectorAll('#blueprintHierarchyBuilder .bp-type-btn[data-bptype]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.bptype === type);
            });
            
            const appProfileInput = document.getElementById('appProfileCountInput');
            const deploymentInput = document.getElementById('deploymentCountInput');
            const serviceInput = document.getElementById('serviceCountInput');
            
            const appProfileContainer = appProfileInput?.closest('.hierarchy-entity-input');
            const deploymentContainer = deploymentInput?.closest('.hierarchy-entity-input');
            const serviceContainer = serviceInput?.closest('.sub-entity-count');
            
            // If single_vm, set all to 1 and disable
            if (type === 'single_vm') {
                // Set all counts to 1
                blueprintEntityCounts.app_profile_list = 1;
                blueprintEntityCounts.deployment_create_list = 1;
                blueprintEntityCounts.service_definition_list = 1;
                
                // Update inputs
                if (appProfileInput) {
                    appProfileInput.value = 1;
                    appProfileInput.disabled = true;
                }
                if (deploymentInput) {
                    deploymentInput.value = 1;
                    deploymentInput.disabled = true;
                }
                if (serviceInput) {
                    serviceInput.value = 1;
                    serviceInput.disabled = true;
                }
                
                // Disable +/- buttons
                if (appProfileContainer) {
                    appProfileContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = true);
                    appProfileContainer.classList.add('disabled-input');
                }
                if (deploymentContainer) {
                    deploymentContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = true);
                    deploymentContainer.classList.add('disabled-input');
                }
                
                // Update calculated counts
                updateCalculatedCounts();
            } else {
                // Enable all inputs
                if (appProfileInput) appProfileInput.disabled = false;
                if (deploymentInput) deploymentInput.disabled = false;
                if (serviceInput) serviceInput.disabled = false;
                
                // Enable +/- buttons
                if (appProfileContainer) {
                    appProfileContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = false);
                    appProfileContainer.classList.remove('disabled-input');
                }
                if (deploymentContainer) {
                    deploymentContainer.querySelectorAll('.count-btn').forEach(btn => btn.disabled = false);
                    deploymentContainer.classList.remove('disabled-input');
                }
            }
        }
        
        function setTaskExecution(type) {
            taskExecution = type;
            document.querySelectorAll('.bp-type-btn[data-exectype]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.exectype === type);
            });
        }
        
        // ===== SECTION 2: App Profile & Deployment Count Functions =====
        function adjustAppProfileCount(delta) {
            const input = document.getElementById('appProfileCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(10, value + delta));
            input.value = value;
            onAppProfileCountChange(value);
        }
        
        function onAppProfileCountChange(value) {
            const count = parseInt(value) || 1;
            blueprintEntityCounts.app_profile_list = count;
            updateCalculatedCounts();
        }
        
        function adjustDeploymentCount(delta) {
            const input = document.getElementById('deploymentCountInput');
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(50, value + delta));
            input.value = value;
            onDeploymentCountChange(value);
        }
        
        function onDeploymentCountChange(value) {
            const count = parseInt(value) || 1;
            blueprintEntityCounts.deployment_create_list = count;
            updateCalculatedCounts();
        }
        
        function updateCalculatedCounts() {
            const appProfiles = parseInt(document.getElementById('appProfileCountInput')?.value) || 1;
            const deploymentsPerProfile = parseInt(document.getElementById('deploymentCountInput')?.value) || 1;
            const totalDeployments = appProfiles * deploymentsPerProfile;
            
            // Update UI badges to show calculated values (for display only)
            // NOTE: Do NOT store these in blueprintEntityCounts - let backend calculate them
            const substrateCalc = document.querySelector('#substrateCalc span');
            const packageCalc = document.querySelector('#packageCalc span');
            if (substrateCalc) substrateCalc.textContent = totalDeployments;
            if (packageCalc) packageCalc.textContent = totalDeployments;
        }
        
        // Legacy function for backward compatibility
        function adjustServiceCount(delta) {
            const input = document.getElementById('serviceCountInput');
            if (!input) return;
            let value = parseInt(input.value) || 1;
            value = Math.max(1, Math.min(100, value + delta));
            input.value = value;
            onServiceCountChange(value);
        }
        
        function onServiceCountChange(value) {
            const count = parseInt(value) || 1;
            blueprintEntityCounts.service_definition_list = count;
        }
        
        function updateSubEntityCount(entity, value) {
            blueprintEntityCounts[entity] = parseInt(value) || 0;
        }
        
        function updateRunbookEntityCount(entity, value) {
            runbookEntityCounts[entity] = parseInt(value) || 0;
        }
        
        // App Profile Options handlers (Section 2)
        function updateProfileOption(option, value) {
            blueprintProfileOptions[option] = parseInt(value) || 0;
        }
        
        // App Profile Options handlers (Section 1 - Rules)
        function updateRulesProfileOption(option, value) {
            rulesProfileOptions[option] = parseInt(value) || 0;
        }
        
        async function generateBlueprintPayload() {
            if (!selectedBlueprintEntity) {
                showToast('Please select a blueprint entity first', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Read counts from input fields - NEW HIERARCHY
                const appProfileCount = parseInt(document.getElementById('appProfileCountInput')?.value) || 1;
                const deploymentsPerProfile = parseInt(document.getElementById('deploymentCountInput')?.value) || 1;
                const serviceCount = parseInt(document.getElementById('serviceCountInput')?.value) || 1;
                const credentialCount = parseInt(document.querySelector('#blueprintHierarchyBuilder input[data-entity="credential_definition_list"]')?.value) || 1;
                
                // Read profile options
                const profileActionCount = parseInt(document.getElementById('profileActionCount')?.value) || 0;
                const snapshotConfigCount = parseInt(document.getElementById('snapshotConfigCount')?.value) || 0;
                const restoreConfigCount = parseInt(document.getElementById('restoreConfigCount')?.value) || 0;
                const patchListCount = parseInt(document.getElementById('patchListCount')?.value) || 0;
                
                // Read nested entity counts
                const serviceActionCount = parseInt(document.getElementById('serviceActionCount')?.value) || 0;
                const serviceActionTaskCount = parseInt(document.getElementById('serviceActionTaskCount')?.value) || 1;
                const serviceActionVariableCount = parseInt(document.getElementById('serviceActionVariableCount')?.value) || 0;
                
                const substrateActionCount = parseInt(document.getElementById('substrateActionCount')?.value) || 0;
                const substrateActionTaskCount = parseInt(document.getElementById('substrateActionTaskCount')?.value) || 1;
                const substrateActionVariableCount = parseInt(document.getElementById('substrateActionVariableCount')?.value) || 0;
                
                const packageInstallTaskCount = parseInt(document.getElementById('packageInstallTaskCount')?.value) || 1;
                const packageInstallVariableCount = parseInt(document.getElementById('packageInstallVariableCount')?.value) || 0;
                const packageUninstallTaskCount = parseInt(document.getElementById('packageUninstallTaskCount')?.value) || 1;
                const packageUninstallVariableCount = parseInt(document.getElementById('packageUninstallVariableCount')?.value) || 0;
                
                // Read guest customization toggle
                const includeGuestCustomization = document.getElementById('guestCustomizationToggle')?.checked || false;
                
                // Calculate total deployments (substrates & packages)
                const totalDeployments = appProfileCount * deploymentsPerProfile;
                
                // Build entity counts for the API
                // NOTE: substrate_definition_list and package_definition_list are calculated by backend hardcoded rules
                // Do NOT send them in the payload to allow proper backend calculation
                const entityCounts = {
                    'spec.resources.app_profile_list': appProfileCount,
                    'spec.resources.app_profile_list.deployment_create_list': deploymentsPerProfile,
                    'spec.resources.service_definition_list': serviceCount,
                    'spec.resources.credential_definition_list': credentialCount
                };
                
                // Add nested entity counts if they are > 0
                if (serviceActionCount > 0) {
                    entityCounts['spec.resources.service_definition_list.action_list'] = serviceActionCount;
                    entityCounts['spec.resources.service_definition_list.action_list.runbook.task_definition_list'] = serviceActionTaskCount;
                    if (serviceActionVariableCount > 0) {
                        entityCounts['spec.resources.service_definition_list.action_list.runbook.variable_list'] = serviceActionVariableCount;
                    }
                }
                
                if (substrateActionCount > 0) {
                    entityCounts['spec.resources.substrate_definition_list.action_list'] = substrateActionCount;
                    entityCounts['spec.resources.substrate_definition_list.action_list.runbook.task_definition_list'] = substrateActionTaskCount;
                    if (substrateActionVariableCount > 0) {
                        entityCounts['spec.resources.substrate_definition_list.action_list.runbook.variable_list'] = substrateActionVariableCount;
                    }
                }
                
                // Package runbook counts - use relative paths that will be matched when scaling within each package
                entityCounts['options.install_runbook.task_definition_list'] = packageInstallTaskCount;
                if (packageInstallVariableCount > 0) {
                    entityCounts['options.install_runbook.variable_list'] = packageInstallVariableCount;
                }
                entityCounts['options.uninstall_runbook.task_definition_list'] = packageUninstallTaskCount;
                if (packageUninstallVariableCount > 0) {
                    entityCounts['options.uninstall_runbook.variable_list'] = packageUninstallVariableCount;
                }
                
                // Build profile options
                const profileOptions = {
                    action_list: profileActionCount,
                    snapshot_config_list: snapshotConfigCount,
                    restore_config_list: restoreConfigCount,
                    patch_list: patchListCount
                };
                
                // Get live UUIDs if available
                const liveUUIDs = getSelectedLiveUUIDs();
                const hasLiveData = liveUUIDs.project.uuid || liveUUIDs.account.uuid || liveUUIDs.cluster.uuid;
                
                console.log('Generating blueprint with counts:', entityCounts);
                console.log('Profile options:', profileOptions);
                console.log('Live UUIDs:', liveUUIDs);
                console.log(`App Profiles: ${appProfileCount}, Deployments/Profile: ${deploymentsPerProfile}, Total Substrates/Packages: ${totalDeployments}`);
                
                // Get blueprint name from input field
                const blueprintNameInput = document.getElementById('blueprintNameInput');
                const blueprintName = blueprintNameInput ? blueprintNameInput.value.trim() : '';
                
                const requestBody = {
                    api_url: selectedBlueprintEntity,
                    entity_counts: entityCounts,
                    blueprint_type: blueprintType,
                    profile_options: profileOptions,
                    include_guest_customization: includeGuestCustomization
                };
                
                // Add blueprint name if provided
                if (blueprintName) {
                    requestBody.blueprint_name = blueprintName;
                }
                
                // Add live UUIDs if available
                if (hasLiveData) {
                    requestBody.live_uuids = liveUUIDs;
                }
                
                const response = await fetch('/api/payload/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                console.log('Generate response:', data);
                
                if (!response.ok) throw new Error(data.error || 'Failed to generate payload');
                
                // Show result - backend returns scaled_payload
                const payload = data.scaled_payload || data.payload;
                const payloadText = JSON.stringify(payload, null, 2);
                document.getElementById('entityGeneratedPayload').textContent = payloadText;
                document.getElementById('entityResult').classList.remove('section-hidden');
                entityGeneratedData = payload;
                
                // Scroll to result
                document.getElementById('entityResult').scrollIntoView({ behavior: 'smooth' });
                
                showLoading(false);
                showToast('Blueprint payload generated!');
            } catch (e) {
                showLoading(false);
                console.error('Generate error:', e);
                showToast(e.message, 'error');
            }
        }

        async function generateRunbookPayload() {
            if (!selectedRunbookEntity) {
                showToast('Please select a runbook entity first', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Read counts from input fields
                const taskCount = parseInt(document.querySelector('#runbookHierarchyBuilder input[data-entity="task_definition_list"]')?.value) || 1;
                const endpointCount = parseInt(document.querySelector('#runbookHierarchyBuilder input[data-entity="endpoint_definition_list"]')?.value) || 1;
                const credentialCount = parseInt(document.querySelector('#runbookHierarchyBuilder input[data-entity="credential_definition_list"]')?.value) || 1;
                
                const entityCounts = {
                    'spec.resources.runbook.task_definition_list': taskCount,
                    'spec.resources.endpoint_definition_list': endpointCount,
                    'spec.resources.credential_definition_list': credentialCount
                };
                
                // Get live UUIDs if available
                const liveUUIDs = getSelectedRunbookLiveUUIDs();
                const hasLiveData = liveUUIDs.project.uuid || liveUUIDs.account.uuid || liveUUIDs.cluster.uuid;
                
                console.log('Generating runbook with counts:', entityCounts);
                console.log('Live UUIDs:', liveUUIDs);
                
                const requestBody = {
                    api_url: selectedRunbookEntity,
                    entity_counts: entityCounts,
                    task_execution: taskExecution
                };
                
                // Add live UUIDs if available
                if (hasLiveData) {
                    requestBody.live_uuids = liveUUIDs;
                }
                
                const response = await fetch('/api/payload/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                console.log('Generate response:', data);
                
                if (!response.ok) throw new Error(data.error || 'Failed to generate payload');
                
                // Show result - backend returns scaled_payload
                const payload = data.scaled_payload || data.payload;
                const payloadText = JSON.stringify(payload, null, 2);
                document.getElementById('entityGeneratedPayload').textContent = payloadText;
                document.getElementById('entityResult').classList.remove('section-hidden');
                entityGeneratedData = payload;
                
                // Scroll to result
                document.getElementById('entityResult').scrollIntoView({ behavior: 'smooth' });
                
                showLoading(false);
                showToast('Runbook payload generated!');
            } catch (e) {
                showLoading(false);
                console.error('Generate error:', e);
                showToast(e.message, 'error');
            }
        }
        
        // ============================================================================
        // LEGACY ENTITY API LIST (kept for compatibility)
        // ============================================================================
        
        function loadEntityApiList() {
            const container = document.getElementById('entityApiList');
            
            if (allApis.length === 0) {
                container.innerHTML = `
                    <div class="no-apis">
                        <i class="bi bi-inbox"></i>
                        <div>No saved entities</div>
                        <small>Go to "Generate New Payload Rules" to create rules first</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allApis.map(api => `
                <div class="api-item" onclick="selectApiForEntities('${encodeURIComponent(api.api_url)}')">
                    <div class="api-name">${api.api_url}</div>
                    <div class="api-meta">
                        <span><i class="bi bi-tag"></i> ${api.api_type}</span>
                        ${api.api_type === 'runbook' ? `<span><i class="bi bi-diagram-3"></i> ${api.task_execution || 'parallel'}</span>` : ''}
                        <span><i class="bi bi-sliders"></i> ${api.rules_count} rules</span>
                        <span><i class="bi bi-diagram-2"></i> ${api.scalable_entities_count} entities</span>
                    </div>
                </div>
            `).join('');
            
            // Reset view
            document.getElementById('entityApiSelection').classList.remove('section-hidden');
            document.getElementById('entityConfiguration').classList.add('section-hidden');
            document.getElementById('entityResult').classList.add('section-hidden');
        }
        
        let entitySelectedApiType = 'blueprint';
        let entityTaskExecution = 'parallel';
        let entityBlueprintType = 'multi_vm';  // 'single_vm' or 'multi_vm'
        
        async function selectApiForEntities(encodedUrl) {
            const apiUrl = decodeURIComponent(encodedUrl);
            
            // First, switch to the Create Entities section
            switchSection('createEntities');
            
            // Determine entity type by checking allApis
            const entityInfo = allApis.find(api => api.api_url === apiUrl);
            const entityType = entityInfo?.api_type || 'blueprint';
            
            // Switch to the correct app type tab
            switchAppType(entityType);
            
            // Wait a tick for DOM to update, then select the entity
            setTimeout(() => {
                if (entityType === 'blueprint') {
                    selectedBlueprintEntity = apiUrl;
                    document.getElementById('blueprintHierarchyBuilder').classList.remove('section-hidden');
                    document.getElementById('selectedBlueprintName').textContent = apiUrl;
                    
                    // Mark card as selected in the list
                    document.querySelectorAll('#blueprintEntityList .entity-select-card').forEach(card => {
                        card.classList.toggle('selected', card.textContent.includes(apiUrl));
                    });
                    
                    // Reset counts to defaults
                    if (document.getElementById('serviceCountInput')) {
                        document.getElementById('serviceCountInput').value = 1;
                    }
                } else {
                    selectedRunbookEntity = apiUrl;
                    document.getElementById('runbookHierarchyBuilder').classList.remove('section-hidden');
                    document.getElementById('selectedRunbookName').textContent = apiUrl;
                    
                    // Mark card as selected in the list
                    document.querySelectorAll('#runbookEntityList .entity-select-card').forEach(card => {
                        card.classList.toggle('selected', card.textContent.includes(apiUrl));
                    });
                }
                
                // Scroll to the hierarchy builder
                const builder = document.getElementById(entityType === 'blueprint' ? 'blueprintHierarchyBuilder' : 'runbookHierarchyBuilder');
                if (builder) {
                    builder.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }
        
        function backToApiSelection() {
            document.getElementById('entityApiSelection').classList.remove('section-hidden');
            document.getElementById('entityConfiguration').classList.add('section-hidden');
            document.getElementById('entityResult').classList.add('section-hidden');
            entitySelectedApi = null;
        }
        
        function updateEntityTaskExecution() {
            const select = document.getElementById('entityTaskExecutionSelect');
            if (select) {
                entityTaskExecution = select.value;
            }
        }
        
        function updateEntityBlueprintType() {
            const select = document.getElementById('entityBlueprintTypeSelect');
            if (select) {
                entityBlueprintType = select.value;
                
                // For single_vm, force service count to 1
                const servicePath = 'spec.resources.service_definition_list';
                if (entityBlueprintType === 'single_vm') {
                    entityCounts[servicePath] = 1;
                }
                
                // Re-render the entity tree to reflect the new state (disabled/enabled inputs)
                renderEntityEntities();
            }
        }
        
        function renderEntityEntities() {
            const activeEntities = entityEntities.filter(e => entityCounts[e.path] > 0);
            const tree = buildEntityTree(activeEntities);
            const container = document.getElementById('entityEntitiesTree');
            
            let html = '';
            Object.values(tree.children).forEach(node => {
                html += renderTreeNode(node, 0, 'entity');
            });
            container.innerHTML = html || '<p style="color: var(--text-secondary)">No active entities</p>';
            
            // Update entity count badge
            document.getElementById('entityEntitiesBadge').textContent = activeEntities.length;
            
            renderEntityExcluded();
        }
        
        function renderEntityExcluded() {
            const excluded = entityEntities.filter(e => entityCounts[e.path] === 0);
            const section = document.getElementById('entityExcludedSection');
            const list = document.getElementById('entityExcludedList');
            const badge = document.getElementById('entityExcludedBadge');
            
            if (excluded.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            badge.textContent = excluded.length;
            
            list.innerHTML = excluded.map(e => `
                <div class="excluded-item">
                    <span class="excluded-path">${e.path}</span>
                    <button class="restore-btn" onclick="restoreEntityEntity('${e.path}')">
                        <i class="bi bi-plus-circle me-1"></i> Restore
                    </button>
                </div>
            `).join('');
        }
        
        function updateEntityCount(path, value) {
            entityCounts[path] = parseInt(value) || 0;
            if (entityCounts[path] === 0) {
                updateEntityVisibility(path, false);
            }
            // Update the badge count display
            const nodeId = `entity_${path.replace(/\./g, '_')}`;
            const badge = document.querySelector(`#toggle_${nodeId}`)?.closest('.tree-node-header')?.querySelector('.entity-count-badge');
            if (badge) {
                badge.textContent = `${entityCounts[path]} items`;
            }
        }
        
        function updateEntityVisibility(path, visible) {
            const nodeId = `entity_${path.replace(/\./g, '_')}`;
            const node = document.getElementById(`toggle_${nodeId}`)?.closest('.tree-node');
            
            if (!visible && node) {
                node.style.display = 'none';
            } else if (visible && node) {
                node.style.display = 'block';
            }
            
            renderEntityExcluded();
        }
        
        function excludeEntityEntity(path) {
            entityCounts[path] = 0;
            updateEntityVisibility(path, false);
        }
        
        function restoreEntityEntity(path) {
            entityCounts[path] = 1;
            const nodeId = `entity_${path.replace(/\./g, '_')}`;
            const node = document.getElementById(`toggle_${nodeId}`)?.closest('.tree-node');
            
            if (node) {
                node.style.display = 'block';
                renderEntityExcluded();
            } else {
                renderEntityEntities();
            }
        }
        
        async function generateEntityPayload() {
            if (!entitySelectedApi) {
                showToast('No API selected', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const response = await fetch('/api/payload/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: entitySelectedApi,
                        entity_counts: entityCounts,
                        task_execution: entityTaskExecution,  // For runbooks
                        blueprint_type: entityBlueprintType   // For blueprints: 'single_vm' or 'multi_vm'
                    })
                });
                
                const data = await response.json();
                if (!response.ok) throw new Error(data.error);
                
                entityGeneratedData = data.scaled_payload;
                document.getElementById('entityGeneratedPayload').textContent = data.formatted_payload;
                document.getElementById('entityResult').classList.remove('section-hidden');
                
                showLoading(false);
            } catch (e) {
                showLoading(false);
                showToast(e.message, 'error');
            }
        }
        
        function copyEntityPayload() {
            navigator.clipboard.writeText(document.getElementById('entityGeneratedPayload').textContent)
                .then(() => showToast('Copied!'))
                .catch(() => showToast('Failed to copy', 'error'));
        }
        
        function downloadEntityPayload() {
            if (!entityGeneratedData) return;
            const blob = new Blob([JSON.stringify(entityGeneratedData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'generated_payload.json';
            link.click();
        }
        
        // ============================================================================
        // SHARED UI COMPONENTS
        // ============================================================================
        
        function buildEntityTree(entitiesList) {
            const tree = { children: {} };
            entitiesList.sort((a, b) => a.path.split('.').length - b.path.split('.').length);
            
            entitiesList.forEach(entity => {
                const parts = entity.path.split('.');
                let current = tree;
                let currentPath = '';
                
                parts.forEach((part, idx) => {
                    currentPath = currentPath ? `${currentPath}.${part}` : part;
                    if (!current.children[part]) {
                        current.children[part] = { name: part, path: currentPath, children: {}, entity: null };
                    }
                    if (idx === parts.length - 1) {
                        current.children[part].entity = entity;
                    }
                    current = current.children[part];
                });
            });
            return tree;
        }
        
        // Auto-linked entities that scale with service count (hidden from main UI)
        const AUTO_LINKED_ENTITY_NAMES = [
            'substrate_definition_list',
            'package_definition_list',
            'deployment_create_list',
            'credential_definition_list',
            'app_profile_list'
        ];
        
        // Check if entity is auto-linked to service count (scales automatically)
        function isAutoLinkedToService(path) {
            // Auto-linked entities that scale with service_definition_list
            const autoLinkedPaths = [
                'spec.resources.substrate_definition_list',
                'spec.resources.package_definition_list',
                'spec.resources.app_profile_list.deployment_create_list'
            ];
            
            return autoLinkedPaths.includes(path);
        }
        
        // For backward compatibility
        function shouldHideEntity(path) {
            return isAutoLinkedToService(path);
        }
        
        function renderTreeNode(node, level, prefix) {
            const hasChildren = Object.keys(node.children).length > 0;
            const entity = node.entity;
            const nodeId = `${prefix}_${node.path.replace(/\./g, '_')}`;
            
            // Check if this entity is auto-linked (scales with service count)
            const isAutoLinkedEntity = entity && shouldHideEntity(entity.path);
            
            // Get count based on which section we're in
            let count = 0;
            if (prefix === 'rules' && entity) {
                count = rulesTempCounts[entity.path] || 0;
                // For auto-linked entities, use service count
                if (isAutoLinkedEntity) {
                    count = rulesTempCounts['spec.resources.service_definition_list'] || 1;
                }
            } else if (prefix === 'entity' && entity) {
                count = entityCounts[entity.path] || 0;
                // For auto-linked entities, use service count
                if (isAutoLinkedEntity) {
                    count = entityCounts['spec.resources.service_definition_list'] || 1;
                }
            }
            
            let html = `<div class="tree-node" data-level="${level}">`;
            html += `<div class="tree-node-header" onclick="toggleTreeNode('${nodeId}')">`;
            html += `<span class="tree-toggle" id="toggle_${nodeId}"><i class="bi bi-chevron-right"></i></span>`;
            html += `<span class="entity-name">${node.name}</span>`;
            if (entity) {
                html += `<span class="entity-count-badge">${count} items</span>`;
                const excludeFn = prefix === 'rules' ? 'excludeRulesEntity' : 'excludeEntityEntity';
                html += `<button class="btn btn-outline-danger btn-sm exclude-btn" onclick="event.stopPropagation(); ${excludeFn}('${entity.path}')" title="Exclude this entity">
                    <i class="bi bi-eye-slash"></i>
                </button>`;
            }
            html += `</div>`;
            
            if (entity) {
                const updateFn = prefix === 'rules' ? 'updateRulesTempCount' : 'updateEntityCount';
                
                html += `<div class="entity-details" id="details_${nodeId}" style="display:none;">`;
                
                if (isAutoLinkedEntity) {
                    // Show linked badge instead of input for auto-linked entities
                    html += `<div class="d-flex align-items-center gap-3">
                        <span class="badge bg-info" style="font-size: 12px;">
                            <i class="bi bi-link-45deg"></i> Linked to service_definition_list count
                        </span>
                        <span style="color: var(--text-secondary); font-size: 13px;">
                            (Will scale to ${count} automatically)
                        </span>
                    </div>`;
                } else {
                    // Check if this is service_definition_list in single_vm mode (should be disabled)
                    const isServiceEntity = entity.path === 'spec.resources.service_definition_list';
                    const isSingleVmMode = prefix === 'entity' && entityBlueprintType === 'single_vm';
                    const isDisabled = isServiceEntity && isSingleVmMode;
                    
                    // Normal editable input (disabled for service count in single_vm mode)
                    html += `<div class="d-flex align-items-center gap-3">
                        <label class="mb-0" style="color: var(--text-secondary); font-size: 13px;">Count:</label>
                        <input type="number" class="form-control" style="width:100px" value="${isDisabled ? 1 : count}" min="0" 
                               ${isDisabled ? 'disabled title="Single VM mode allows only 1 service"' : ''}
                               onchange="${updateFn}('${entity.path}', this.value)">
                        ${isDisabled ? '<span class="badge bg-secondary ms-2">Single VM</span>' : ''}
                    </div>`;
                }
                html += `</div>`;
            }
            
            if (hasChildren) {
                html += `<div class="tree-children" id="children_${nodeId}">`;
                Object.values(node.children).forEach(child => {
                    html += renderTreeNode(child, level + 1, prefix);
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            return html;
        }
        
        function toggleTreeNode(nodeId) {
            const toggle = document.getElementById(`toggle_${nodeId}`);
            const details = document.getElementById(`details_${nodeId}`);
            const children = document.getElementById(`children_${nodeId}`);
            const header = toggle.closest('.tree-node-header');
            
            const isExpanded = toggle.classList.contains('expanded');
            
            if (isExpanded) {
                toggle.classList.remove('expanded');
                header.classList.remove('expanded');
                if (details) details.style.display = 'none';
                if (children) children.classList.remove('show');
            } else {
                toggle.classList.add('expanded');
                header.classList.add('expanded');
                if (details) details.style.display = 'block';
                if (children) children.classList.add('show');
            }
        }
        
        function getRuleColor(type) {
            const colors = {
                'use_single': '#0ea5e9', 'reference_mapping': '#8b5cf6', 'filter': '#10b981',
                'clone': '#f59e0b', 'keep_first': '#14b8a6', 'set_value': '#ec4899', 'remove_field': '#ef4444'
            };
            return colors[type] || '#6b7280';
        }
        
        function getRuleDescription(rule) {
            switch (rule.type) {
                case 'use_single': return `Use only first item from: <code>${rule.source_entity}</code>`;
                case 'reference_mapping': return `<code>${rule.source_path}</code>  <code>${rule.target_path}</code>`;
                case 'filter': return `Filter <code>${rule.target_path}</code> by <code>${rule.filter_field}</code>`;
                case 'clone': return `Clone <code>${rule.source_value}</code> in <code>${rule.target_path}</code>`;
                case 'keep_first': return `Keep first ${rule.keep_count} in <code>${rule.target_path}</code>`;
                case 'set_value': return `Set <code>${rule.target_path}</code> = "${rule.new_value}"`;
                case 'remove_field': return `Remove <code>${rule.field_to_remove}</code> from <code>${rule.target_path}</code>`;
                default: return JSON.stringify(rule);
            }
        }
        
        // ============================================================================
        // RULE FORM
        // ============================================================================
        
        function showAddRuleForm(prefix) {
            const form = document.getElementById(`${prefix}AddRuleForm`);
            form.style.display = 'block';
            form.innerHTML = `
                <div class="card-dark" style="margin: 0; background: rgba(0,0,0,0.2);">
                    <h6 style="color: var(--text-primary); margin-bottom: 16px;"><i class="bi bi-plus-circle me-2"></i>Add New Rule</h6>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Rule Type</label>
                            <select class="form-select" id="${prefix}RuleTypeSelect" onchange="updateRuleFormFields('${prefix}')">
                                <option value="filter">Filter</option>
                                <option value="clone">Clone</option>
                                <option value="use_single">Use Single</option>
                                <option value="reference_mapping">Reference Mapping</option>
                                <option value="keep_first">Keep First N</option>
                                <option value="set_value">Set Value</option>
                                <option value="remove_field">Remove Field</option>
                            </select>
                        </div>
                        <div class="col-md-9" id="${prefix}RuleFormFields"></div>
                    </div>
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-success btn-sm" onclick="addRule('${prefix}')">
                            <i class="bi bi-check me-1"></i> Add Rule
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="hideAddRuleForm('${prefix}')">Cancel</button>
                    </div>
                </div>
            `;
            updateRuleFormFields(prefix);
        }
        
        function hideAddRuleForm(prefix) {
            document.getElementById(`${prefix}AddRuleForm`).style.display = 'none';
        }
        
        function updateRuleFormFields(prefix) {
            const type = document.getElementById(`${prefix}RuleTypeSelect`).value;
            const container = document.getElementById(`${prefix}RuleFormFields`);
            
            const fields = {
                filter: `
                    <label class="form-label">Target Path</label>
                    <input class="form-control mb-2" id="${prefix}_rf_target" placeholder="e.g., spec.resources.service_definition_list.action_list">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Filter Field</label>
                            <input class="form-control" id="${prefix}_rf_field" placeholder="name" value="name">
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Allowed Values (comma-separated)</label>
                            <input class="form-control" id="${prefix}_rf_values" placeholder="action_create, action_delete">
                        </div>
                    </div>`,
                clone: `
                    <label class="form-label">Target Path</label>
                    <input class="form-control mb-2" id="${prefix}_rf_target" placeholder="e.g., spec.resources.service_definition_list.action_list">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Source Field</label>
                            <input class="form-control" id="${prefix}_rf_srcfield" placeholder="name" value="name">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Source Value</label>
                            <input class="form-control" id="${prefix}_rf_srcvalue" placeholder="Value to clone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Clone Values (comma-separated)</label>
                            <input class="form-control" id="${prefix}_rf_clonevalues" placeholder="new_action1, new_action2">
                        </div>
                    </div>`,
                use_single: `
                    <label class="form-label">Source Entity Path</label>
                    <input class="form-control" id="${prefix}_rf_source" placeholder="e.g., spec.resources.app_profile_list">`,
                reference_mapping: `
                    <div class="row">
                        <div class="col-md-5">
                            <label class="form-label">Source Path</label>
                            <input class="form-control" id="${prefix}_rf_srcpath" placeholder="e.g., substrate_definition_list.uuid">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Target Path</label>
                            <input class="form-control" id="${prefix}_rf_tgtpath" placeholder="e.g., deployment_create_list.substrate_local_reference.uuid">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="${prefix}_rf_maptype">
                                <option value="first_only">First Only</option>
                                <option value="one_to_one">One to One</option>
                                <option value="round_robin">Round Robin</option>
                            </select>
                        </div>
                    </div>`,
                keep_first: `
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">Target Path</label>
                            <input class="form-control" id="${prefix}_rf_target" placeholder="e.g., spec.resources.service_definition_list">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Keep Count</label>
                            <input class="form-control" id="${prefix}_rf_count" type="number" value="1" min="1">
                        </div>
                    </div>`,
                set_value: `
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Target Path</label>
                            <input class="form-control" id="${prefix}_rf_target" placeholder="e.g., spec.name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">New Value</label>
                            <input class="form-control" id="${prefix}_rf_newvalue" placeholder="New value to set">
                        </div>
                    </div>`,
                remove_field: `
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Target Path</label>
                            <input class="form-control" id="${prefix}_rf_target" placeholder="e.g., spec.resources.service_definition_list">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Field to Remove</label>
                            <input class="form-control" id="${prefix}_rf_fieldname" placeholder="Field name to remove">
                        </div>
                    </div>`
            };
            
            container.innerHTML = fields[type] || '';
        }
        
        function addRule(prefix) {
            const type = document.getElementById(`${prefix}RuleTypeSelect`).value;
            let rule = { type };
            
            try {
                switch (type) {
                    case 'filter':
                        rule.target_path = document.getElementById(`${prefix}_rf_target`).value;
                        rule.filter_field = document.getElementById(`${prefix}_rf_field`).value || 'name';
                        rule.allowed_values = document.getElementById(`${prefix}_rf_values`).value.split(',').map(v => v.trim()).filter(v => v);
                        break;
                    case 'clone':
                        rule.target_path = document.getElementById(`${prefix}_rf_target`).value;
                        rule.source_field = document.getElementById(`${prefix}_rf_srcfield`).value || 'name';
                        rule.source_value = document.getElementById(`${prefix}_rf_srcvalue`).value;
                        rule.clone_values = document.getElementById(`${prefix}_rf_clonevalues`).value.split(',').map(v => v.trim()).filter(v => v);
                        break;
                    case 'use_single':
                        rule.source_entity = document.getElementById(`${prefix}_rf_source`).value;
                        break;
                    case 'reference_mapping':
                        rule.source_path = document.getElementById(`${prefix}_rf_srcpath`).value;
                        rule.target_path = document.getElementById(`${prefix}_rf_tgtpath`).value;
                        rule.mapping_type = document.getElementById(`${prefix}_rf_maptype`).value;
                        break;
                    case 'keep_first':
                        rule.target_path = document.getElementById(`${prefix}_rf_target`).value;
                        rule.keep_count = parseInt(document.getElementById(`${prefix}_rf_count`).value) || 1;
                        break;
                    case 'set_value':
                        rule.target_path = document.getElementById(`${prefix}_rf_target`).value;
                        rule.new_value = document.getElementById(`${prefix}_rf_newvalue`).value;
                        break;
                    case 'remove_field':
                        rule.target_path = document.getElementById(`${prefix}_rf_target`).value;
                        rule.field_to_remove = document.getElementById(`${prefix}_rf_fieldname`).value;
                        break;
                }
                
                if (prefix === 'rules') {
                    rulesCustomRules.push(rule);
                    renderRulesRulesList();
                }
                
                hideAddRuleForm(prefix);
                showToast('Rule added');
            } catch (e) {
                showToast('Error adding rule: ' + e.message, 'error');
            }
        }
        
        // ============================================================================
        // PERFORMANCE TESTER - BroadcastChannel Based
        // ============================================================================
        
        // BroadcastChannel for cross-tab communication
        const perfChannel = new BroadcastChannel('perf-tester-sync');
        
        // Performance Tester State
        let perfState = {
            isRunning: false,
            isParent: true,  // This is the parent controller
            targetUrl: '',
            childTabs: [],   // References to opened tabs
            connectedTabs: {},  // Tab ID -> last ping time
            metrics: {
                latencies: [],
                pageLoads: [],
                fcpTimes: [],
                lcpTimes: [],
                errors: 0,
                messagesSent: 0
            },
            eventLog: []
        };
        
        // Initialize performance tester when section is shown
        function initPerfTester() {
            setupBroadcastListener();
            logPerfEvent('INIT', 'BroadcastChannel tester ready. Channel: perf-tester-sync');
        }
        
        // Setup listener for messages from child tabs
        function setupBroadcastListener() {
            perfChannel.onmessage = (event) => {
                const msg = event.data;
                
                switch (msg.type) {
                    case 'child-connected':
                        handleChildConnected(msg);
                        break;
                    case 'child-disconnected':
                        handleChildDisconnected(msg);
                        break;
                    case 'pong':
                        handlePong(msg);
                        break;
                    case 'metrics-report':
                        handleMetricsReport(msg);
                        break;
                    case 'action-ack':
                        handleActionAck(msg);
                        break;
                    case 'error':
                        handleChildError(msg);
                        break;
                }
            };
        }
        
        function handleChildConnected(msg) {
            perfState.connectedTabs[msg.tabId] = {
                id: msg.tabId,
                connectedAt: Date.now(),
                lastPing: Date.now(),
                url: msg.url || 'unknown',
                metrics: {}
            };
            updateTabsUI();
            updateConnectedCount();
            logPerfEvent('CONNECT', `Tab ${msg.tabId} connected from ${msg.url || 'unknown'}`);
        }
        
        function handleChildDisconnected(msg) {
            delete perfState.connectedTabs[msg.tabId];
            updateTabsUI();
            updateConnectedCount();
            logPerfEvent('DISCONNECT', `Tab ${msg.tabId} disconnected`);
        }
        
        function handlePong(msg) {
            if (perfState.connectedTabs[msg.tabId]) {
                const latency = Date.now() - msg.pingTime;
                perfState.connectedTabs[msg.tabId].lastPing = Date.now();
                perfState.connectedTabs[msg.tabId].latency = latency;
                perfState.metrics.latencies.push(latency);
                updateTabsUI();
                updateMetricsUI();
            }
        }
        
        function handleMetricsReport(msg) {
            if (perfState.connectedTabs[msg.tabId]) {
                perfState.connectedTabs[msg.tabId].metrics = msg.metrics;
                
                if (msg.metrics.pageLoad) perfState.metrics.pageLoads.push(msg.metrics.pageLoad);
                if (msg.metrics.fcp) perfState.metrics.fcpTimes.push(msg.metrics.fcp);
                if (msg.metrics.lcp) perfState.metrics.lcpTimes.push(msg.metrics.lcp);
                
                updateTabsUI();
                updateMetricsUI();
                logPerfEvent('METRICS', `Tab ${msg.tabId}: Load=${msg.metrics.pageLoad}ms, FCP=${msg.metrics.fcp}ms`);
            }
        }
        
        function handleActionAck(msg) {
            const latency = Date.now() - msg.sentTime;
            perfState.metrics.latencies.push(latency);
            if (perfState.connectedTabs[msg.tabId]) {
                perfState.connectedTabs[msg.tabId].latency = latency;
            }
            updateMetricsUI();
        }
        
        function handleChildError(msg) {
            perfState.metrics.errors++;
            updateMetricsUI();
            logPerfEvent('ERROR', `Tab ${msg.tabId}: ${msg.error}`);
        }
        
        // ============================================================================
        // Tab Management Functions
        // ============================================================================
        
        function openChildTabs() {
            const count = parseInt(document.getElementById('perfTabCount').value);
            const targetUrl = document.getElementById('perfTargetUrl').value.trim();
            
            if (!targetUrl) {
                showToast('Please enter a target URL first', 'error');
                return;
            }
            
            // Add protocol if missing
            let url = targetUrl;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
                document.getElementById('perfTargetUrl').value = url;
            }
            
            perfState.targetUrl = url;
            
            // Open child tabs with the child script
            for (let i = 0; i < count; i++) {
                const childUrl = `/perf-child?url=${encodeURIComponent(url)}&tabId=${i + 1}`;
                const tab = window.open(childUrl, `perf_child_${i + 1}`);
                if (tab) {
                    perfState.childTabs.push(tab);
                }
            }
            
            logPerfEvent('TABS', `Opened ${count} child tabs for ${url}`);
            showToast(`Opening ${count} child tabs...`, 'info');
            
            // Ping tabs after a delay to check connection
            setTimeout(() => pingAllTabs(), 2000);
        }
        
        function closeChildTabs() {
            perfState.childTabs.forEach(tab => {
                try {
                    if (tab && !tab.closed) {
                        tab.close();
                    }
                } catch (e) {}
            });
            
            perfState.childTabs = [];
            perfState.connectedTabs = {};
            updateTabsUI();
            updateConnectedCount();
            logPerfEvent('TABS', 'All child tabs closed');
            showToast('Child tabs closed', 'info');
        }
        
        function pingAllTabs() {
            const pingTime = Date.now();
            perfChannel.postMessage({
                type: 'ping',
                pingTime: pingTime
            });
            perfState.metrics.messagesSent++;
            updateMetricsUI();
            logPerfEvent('PING', 'Ping sent to all tabs');
        }
        
        function broadcastNavigate() {
            const url = document.getElementById('perfTargetUrl').value.trim();
            if (!url) {
                showToast('Please enter a target URL', 'error');
                return;
            }
            
            perfChannel.postMessage({
                type: 'navigate',
                url: url,
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
            updateMetricsUI();
            logPerfEvent('NAV', `Navigate command sent: ${url}`);
        }
        
        function broadcastClick(selector) {
            perfChannel.postMessage({
                type: 'click',
                selector: selector,
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
            updateMetricsUI();
        }
        
        function broadcastScroll(deltaY) {
            perfChannel.postMessage({
                type: 'scroll',
                deltaY: deltaY,
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
        }
        
        function broadcastType(selector, text) {
            perfChannel.postMessage({
                type: 'type',
                selector: selector,
                text: text,
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
            updateMetricsUI();
        }
        
        // ============================================================================
        // UI Update Functions
        // ============================================================================
        
        function updateTabsUI() {
            const grid = document.getElementById('perfTabsGrid');
            const tabs = Object.values(perfState.connectedTabs);
            
            if (tabs.length === 0) {
                grid.innerHTML = `
                    <div class="text-secondary text-center py-4">
                        <i class="bi bi-window-plus" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No child tabs connected. Click "Open Child Tabs" to start.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            tabs.forEach(tab => {
                const isOnline = (Date.now() - tab.lastPing) < 10000;
                const statusClass = isOnline ? 'connected' : 'disconnected';
                const statusBadge = isOnline ? 'online' : 'offline';
                
                html += `
                    <div class="perf-tab-card ${statusClass}">
                        <div class="perf-tab-header">
                            <span class="perf-tab-id"><i class="bi bi-window"></i> Tab ${tab.id}</span>
                            <span class="perf-tab-status ${statusBadge}">${isOnline ? 'Online' : 'Offline'}</span>
                        </div>
                        <div class="perf-tab-metrics">
                            <div class="perf-tab-metric">
                                <div class="perf-tab-metric-value">${tab.latency || 0}ms</div>
                                <div class="perf-tab-metric-label">Latency</div>
                            </div>
                            <div class="perf-tab-metric">
                                <div class="perf-tab-metric-value">${tab.metrics?.pageLoad || 0}ms</div>
                                <div class="perf-tab-metric-label">Load</div>
                            </div>
                            <div class="perf-tab-metric">
                                <div class="perf-tab-metric-value">${tab.metrics?.fcp || 0}ms</div>
                                <div class="perf-tab-metric-label">FCP</div>
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${tab.url || 'unknown'}
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function updateConnectedCount() {
            const count = Object.keys(perfState.connectedTabs).length;
            document.getElementById('perfConnectedCount').textContent = `${count} connected`;
            document.getElementById('metricConnectedTabs').querySelector('.perf-metric-value').textContent = count;
            
            const indicator = document.getElementById('perfSyncIndicator');
            const status = document.getElementById('perfSyncStatus');
            
            if (count > 0) {
                indicator.classList.add('syncing');
                status.textContent = 'Connected';
            } else {
                indicator.classList.remove('syncing');
                status.textContent = 'Ready';
            }
        }
        
        function updateMetricsUI() {
            const m = perfState.metrics;
            
            document.getElementById('metricAvgLatency').querySelector('.perf-metric-value').textContent = 
                calculateAvg(m.latencies) + 'ms';
            document.getElementById('metricP95Latency').querySelector('.perf-metric-value').textContent = 
                calculateP95(m.latencies) + 'ms';
            document.getElementById('metricPageLoad').querySelector('.perf-metric-value').textContent = 
                calculateAvg(m.pageLoads) + 'ms';
            document.getElementById('metricFCP').querySelector('.perf-metric-value').textContent = 
                calculateAvg(m.fcpTimes) + 'ms';
            document.getElementById('metricLCP').querySelector('.perf-metric-value').textContent = 
                calculateAvg(m.lcpTimes) + 'ms';
            document.getElementById('metricMessagesSent').querySelector('.perf-metric-value').textContent = 
                m.messagesSent;
            document.getElementById('metricErrors').querySelector('.perf-metric-value').textContent = 
                m.errors;
        }
        
        // ============================================================================
        // Test Control Functions
        // ============================================================================
        
        function startBroadcastTest() {
            const connectedCount = Object.keys(perfState.connectedTabs).length;
            if (connectedCount === 0) {
                showToast('No child tabs connected. Open child tabs first.', 'error');
                return;
            }
            
            perfState.isRunning = true;
            
            // Update UI
            document.getElementById('perfStartBtn').disabled = true;
            document.getElementById('perfStopBtn').disabled = false;
            
            // Reset metrics but keep connected tabs
            perfState.metrics = {
                latencies: [],
                pageLoads: [],
                fcpTimes: [],
                lcpTimes: [],
                errors: 0,
                messagesSent: 0
            };
            
            // Tell children to start recording
            perfChannel.postMessage({
                type: 'start-recording',
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
            
            logPerfEvent('START', 'Recording started');
            showToast('Recording started - metrics collection active', 'success');
            updateMetricsUI();
        }
        
        function stopBroadcastTest() {
            perfState.isRunning = false;
            
            // Update UI
            document.getElementById('perfStartBtn').disabled = false;
            document.getElementById('perfStopBtn').disabled = true;
            
            // Tell children to stop recording
            perfChannel.postMessage({
                type: 'stop-recording',
                sentTime: Date.now()
            });
            perfState.metrics.messagesSent++;
            
            logPerfEvent('STOP', 'Recording stopped');
            showToast('Recording stopped', 'info');
            updateMetricsUI();
        }
        
        function resetPerfTest() {
            stopBroadcastTest();
            
            // Reset metrics
            perfState.metrics = {
                latencies: [],
                pageLoads: [],
                fcpTimes: [],
                lcpTimes: [],
                errors: 0,
                messagesSent: 0
            };
            
            // Clear tabs UI but keep connections
            updateMetricsUI();
            updateTabsUI();
            
            document.getElementById('perfSyncStatus').textContent = 'Ready';
            logPerfEvent('RESET', 'Metrics reset');
        }
        
        // ============================================================================
        // Logging Functions
        // ============================================================================
        
        function logPerfEvent(type, detail) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            
            const event = { time, type, detail };
            perfState.eventLog.unshift(event);
            
            // Keep only last 100 events
            if (perfState.eventLog.length > 100) {
                perfState.eventLog.pop();
            }
            
            // Update UI
            const logContainer = document.getElementById('perfEventLog');
            const eventHtml = `
                <div class="perf-event-item">
                    <span class="perf-event-time">${time}</span>
                    <span class="perf-event-type">${type}</span>
                    <span class="perf-event-detail">${detail}</span>
                </div>
            `;
            
            logContainer.insertAdjacentHTML('afterbegin', eventHtml);
            
            // Limit displayed events
            const items = logContainer.querySelectorAll('.perf-event-item');
            if (items.length > 50) {
                items[items.length - 1].remove();
            }
        }
        
        function clearPerfEventLog() {
            perfState.eventLog = [];
            document.getElementById('perfEventLog').innerHTML = '';
            logPerfEvent('CLEAR', 'Event log cleared');
        }
        
        function exportPerfResults() {
            const results = {
                timestamp: new Date().toISOString(),
                config: {
                    targetUrl: perfState.targetUrl,
                    tabCount: Object.keys(perfState.connectedTabs).length
                },
                metrics: {
                    avgLatency: calculateAvg(perfState.metrics.latencies),
                    p95Latency: calculateP95(perfState.metrics.latencies),
                    avgPageLoad: calculateAvg(perfState.metrics.pageLoads),
                    avgFCP: calculateAvg(perfState.metrics.fcpTimes),
                    avgLCP: calculateAvg(perfState.metrics.lcpTimes),
                    messagesSent: perfState.metrics.messagesSent,
                    totalErrors: perfState.metrics.errors
                },
                tabs: Object.values(perfState.connectedTabs).map(tab => ({
                    id: tab.id,
                    latency: tab.latency,
                    metrics: tab.metrics,
                    url: tab.url
                })),
                eventLog: perfState.eventLog.slice(0, 50)
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `perf-results-${Date.now()}.json`;
            link.click();
            
            showToast('Results exported!');
            logPerfEvent('EXPORT', 'Results exported to JSON');
        }
        
        function calculateAvg(arr) {
            if (arr.length === 0) return 0;
            return Math.round(arr.reduce((a, b) => a + b, 0) / arr.length);
        }
        
        function calculateP95(arr) {
            if (arr.length === 0) return 0;
            const sorted = [...arr].sort((a, b) => a - b);
            const p95Index = Math.floor(sorted.length * 0.95);
            return sorted[p95Index] || 0;
        }
        
        // ============================================================================
        // MIRROR MODE - Main browser + mirrored child browsers
        // ============================================================================
        
        let mirrorState = {
            isRunning: false,
            pollInterval: null
        };
        
        function startMirrorMode() {
            const url = document.getElementById('mirrorTargetUrl').value.trim();
            if (!url) {
                showToast('Please enter a target URL', 'error');
                return;
            }
            
            const config = {
                url: url,
                num_children: parseInt(document.getElementById('mirrorChildCount').value),
                headless_children: document.getElementById('mirrorHeadlessChildren').checked,
                ignore_ssl: document.getElementById('mirrorIgnoreSSL').checked
            };
            
            // Update UI
            document.getElementById('mirrorStartBtn').disabled = true;
            document.getElementById('mirrorStopBtn').disabled = false;
            document.getElementById('mirrorStatusBar').style.display = 'block';
            document.getElementById('mirrorStatusText').textContent = `Starting 1 main + ${config.num_children} child browsers...`;
            
            mirrorState.isRunning = true;
            
            // Clear previous log
            document.getElementById('mirrorEventLog').innerHTML = '';
            logMirrorEvent('START', `Starting mirror mode with ${config.num_children} child browsers`);
            
            // Start mirror mode
            fetch('/api/mirror/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    showToast(data.error, 'error');
                    resetMirrorUI();
                    return;
                }
                
                showToast('Mirror mode starting - a browser window will open', 'success');
                
                // Start polling for status
                mirrorState.pollInterval = setInterval(pollMirrorStatus, 1000);
            })
            .catch(err => {
                showToast('Error starting mirror mode: ' + err.message, 'error');
                resetMirrorUI();
            });
        }
        
        function stopMirrorMode() {
            fetch('/api/mirror/stop', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('mirrorStatusText').textContent = 'Stopping...';
                logMirrorEvent('STOP', 'Stop requested');
            });
        }
        
        function pollMirrorStatus() {
            fetch('/api/mirror/status')
            .then(r => r.json())
            .then(data => {
                // Update metrics
                document.getElementById('mirrorMetricChildren').querySelector('.perf-metric-value').textContent = 
                    data.num_children;
                document.getElementById('mirrorMetricActions').querySelector('.perf-metric-value').textContent = 
                    data.metrics.actions_mirrored;
                document.getElementById('mirrorMetricLatency').querySelector('.perf-metric-value').textContent = 
                    data.metrics.avg_latency + 'ms';
                document.getElementById('mirrorMetricErrors').querySelector('.perf-metric-value').textContent = 
                    data.metrics.errors;
                
                // Update status text
                if (data.is_running) {
                    document.getElementById('mirrorStatusText').textContent = 
                        `Running: ${data.num_children} children mirroring, ${data.metrics.actions_mirrored} actions`;
                } else {
                    document.getElementById('mirrorStatusText').textContent = 'Stopped';
                }
                
                // Update log
                updateMirrorLog(data.log);
                
                // If stopped, update UI
                if (!data.is_running && mirrorState.isRunning) {
                    mirrorState.isRunning = false;
                    clearInterval(mirrorState.pollInterval);
                    resetMirrorUI();
                    logMirrorEvent('STOPPED', 'Mirror mode ended');
                }
            })
            .catch(err => {
                console.log('Poll error:', err);
            });
        }
        
        function updateMirrorLog(log) {
            const container = document.getElementById('mirrorEventLog');
            
            // Get existing event count
            const existingEvents = container.querySelectorAll('.perf-event-item').length;
            
            // Add new events (log is already in reverse chronological order)
            const newEvents = log.slice(0, Math.max(0, log.length - existingEvents));
            
            newEvents.reverse().forEach(event => {
                const eventHtml = `
                    <div class="perf-event-item">
                        <span class="perf-event-time">${event.time}</span>
                        <span class="perf-event-type">${event.type}</span>
                        <span class="perf-event-detail">${event.message}${event.session_id ? ` [C${event.session_id}]` : ''}</span>
                    </div>
                `;
                container.insertAdjacentHTML('afterbegin', eventHtml);
            });
            
            // Limit displayed events
            const items = container.querySelectorAll('.perf-event-item');
            if (items.length > 100) {
                for (let i = 100; i < items.length; i++) {
                    items[i].remove();
                }
            }
        }
        
        function resetMirrorUI() {
            document.getElementById('mirrorStartBtn').disabled = false;
            document.getElementById('mirrorStopBtn').disabled = true;
            document.getElementById('mirrorStatusBar').style.display = 'none';
            
            if (mirrorState.pollInterval) {
                clearInterval(mirrorState.pollInterval);
                mirrorState.pollInterval = null;
            }
        }
        
        function logMirrorEvent(type, detail) {
            const now = new Date();
            const time = now.toTimeString().split(' ')[0];
            
            const logContainer = document.getElementById('mirrorEventLog');
            const eventHtml = `
                <div class="perf-event-item">
                    <span class="perf-event-time">${time}</span>
                    <span class="perf-event-type">${type}</span>
                    <span class="perf-event-detail">${detail}</span>
                </div>
            `;
            
            logContainer.insertAdjacentHTML('afterbegin', eventHtml);
        }
        
        function clearMirrorLog() {
            document.getElementById('mirrorEventLog').innerHTML = '';
            logMirrorEvent('CLEAR', 'Log cleared');
        }
        
        // Initialize the page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing Create Entities section...');
            
            // Since Create Entities is now the default section, we need to initialize it
            // Show the blueprint hierarchy builder by default
            try {
                const hierarchyBuilder = document.getElementById('blueprintHierarchyBuilder');
                if (hierarchyBuilder) {
                    hierarchyBuilder.classList.remove('section-hidden');
                    console.log('Blueprint hierarchy builder shown');
                }
                
                // Load default blueprint rules
                fetch('/api/default-rules/blueprint')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Default blueprint rules loaded:', data);
                    })
                    .catch(error => {
                        console.error('Error loading default blueprint rules:', error);
                    });
                
                // Load saved rules
                fetch('/api/rules')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Saved rules loaded:', data);
                    })
                    .catch(error => {
                        console.error('Error loading saved rules:', error);
                    });
                    
            } catch (error) {
                console.error('Error during initialization:', error);
            }
        });

        // Service count adjustment functions
        function adjustServiceCount(delta) {
            const input = document.getElementById('serviceCountInput');
            if (input) {
                const currentValue = parseInt(input.value) || 1;
                const newValue = Math.max(1, Math.min(50, currentValue + delta));
                input.value = newValue;
                onServiceCountChange(newValue);
            }
        }

        function onServiceCountChange(value) {
            const serviceCount = parseInt(value) || 1;
            console.log('Service count changed to:', serviceCount);
            
            // Update any related calculations or UI elements
            // This function can be expanded to handle service count changes
        }

        function adjustRulesServiceCount(delta) {
            const input = document.getElementById('rulesServiceCountInput');
            if (input) {
                const currentValue = parseInt(input.value) || 1;
                const newValue = Math.max(1, Math.min(50, currentValue + delta));
                input.value = newValue;
                onRulesServiceCountChange(newValue);
            }
        }

        function onRulesServiceCountChange(value) {
            const serviceCount = parseInt(value) || 1;
            console.log('Rules service count changed to:', serviceCount);
            
            // Update any related calculations or UI elements
            // This function can be expanded to handle rules service count changes
        }
    </script>
</body>
</html>
