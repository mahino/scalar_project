<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Payload Scaler</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status"></div>
            <p>Processing...</p>
        </div>
            </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4><i class="bi bi-diagram-3"></i> Payload Scaler</h4>
                </div>
        
        <div class="main-nav">
            <div class="nav-section">
                <button class="nav-btn nav-btn-primary" onclick="showSection('generateRules')">
                    <i class="bi bi-plus-circle"></i>
                    <span>Generate New Payload Rules</span>
                </button>
            </div>
            <div class="nav-section">
                <button class="nav-btn nav-btn-secondary" id="createEntitiesBtn" onclick="showSection('createEntities')">
                    <i class="bi bi-layers"></i>
                    <span>Create Entities</span>
                </button>
            </div>
            <div class="nav-section" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                <button class="nav-btn nav-btn-secondary" id="analyzerBtn" onclick="showSection('analyzer')" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(34, 197, 94, 0.2)); border-color: var(--accent-green); margin-bottom: 8px;">
                    <i class="bi bi-diagram-2-fill" style="color: var(--accent-green);"></i>
                    <span>Analyzer</span>
                </button>
                <button class="nav-btn nav-btn-secondary" id="dashboardBtn" onclick="showSection('dashboard')" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(99, 102, 241, 0.2)); border-color: var(--accent-blue); margin-bottom: 8px;">
                    <i class="bi bi-speedometer2" style="color: var(--accent-blue);"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-btn nav-btn-secondary" id="perfTesterBtn" onclick="showSection('perfTester')" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(239, 68, 68, 0.2)); border-color: var(--accent-orange);">
                    <i class="bi bi-speedometer2" style="color: var(--accent-orange);"></i>
                    <span>Performance Tester</span>
                </button>
                <button class="nav-btn nav-btn-secondary" id="playwrightBtn" onclick="showSection('playwright')" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(6, 182, 212, 0.2)); border-color: var(--accent-purple); margin-top: 8px;">
                    <i class="bi bi-robot" style="color: var(--accent-purple);"></i>
                    <span>Browser Automation</span>
                </button>
            </div>
        </div>

        <div class="api-list-section">
            <h6>Saved Entities</h6>
            <div id="apiList">
                <div class="no-apis">
                    <i class="bi bi-inbox"></i>
                    <div>No saved entities yet</div>
                    <small>Create rules to get started</small>
                </div>
            </div>
        </div>
            </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- Welcome Screen -->
        <div id="welcomeSection" class="section section-hidden">
            <div class="card-dark">
                <div class="welcome-screen">
                    <div class="welcome-icon">
                        <i class="bi bi-lightning-charge"></i>
                </div>
                    <h3>Welcome to API Payload Scaler</h3>
                    <p>Create reusable transformation rules for your API payloads, then generate scaled payloads with custom entity counts. Rules are saved separately from entity counts for maximum flexibility.</p>
                    <div class="welcome-actions">
                        <button class="btn btn-primary" onclick="showSection('generateRules')">
                            <i class="bi bi-plus-circle me-2"></i> Generate New Rules
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showSection('createEntities')">
                            <i class="bi bi-layers me-2"></i> Create Entities
                </button>
                    </div>
                </div>
            </div>
            </div>

        <!-- Section 1: Generate New Payload Rules -->
        <div id="generateRulesSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-gear-wide-connected"></i>
                    Generate New Payload Rules
                    <span class="badge bg-primary">Section 1</span>
                </h2>
                <p>Define transformation rules for an API. Entity counts are temporary and won't be saved.</p>
            </div>
            
            <!-- App Type Switcher for Rules -->
            <div class="card-dark">
                <div class="app-switcher">
                    <div class="app-switcher-tabs">
                        <button class="app-switcher-tab active" data-type="blueprint" onclick="switchRulesAppType('blueprint')">
                            <i class="bi bi-diagram-3"></i>
                            <span>Blueprint</span>
                        </button>
                        <button class="app-switcher-tab" data-type="runbook" onclick="switchRulesAppType('runbook')">
                            <i class="bi bi-play-circle"></i>
                            <span>Runbook</span>
                        </button>
                    </div>
                </div>
                <!-- Hidden select for compatibility -->
                <select class="form-select" id="apiTypeSelect" style="display: none;">
                    <option value="blueprint">Blueprint</option>
                    <option value="app">App</option>
                    <option value="runbook">Runbook</option>
                </select>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <span class="step-number">1</span>
                    <span>Input Payload</span>
                </div>
                <div class="step" id="step2">
                    <span class="step-number">2</span>
                    <span>Configure Entities</span>
                </div>
                <div class="step" id="step3">
                    <span class="step-number">3</span>
                    <span>Preview & Save</span>
                </div>
            </div>
            
            <!-- Step 1: Input Payload -->
            <div id="rulesStep1">
                <!-- Blueprint Payload Input -->
                <div id="rulesBlueprintInput" class="card-dark">
                    <h5><i class="bi bi-diagram-3"></i> Blueprint Payload</h5>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        Paste a sample blueprint JSON payload to analyze its structure and create scaling rules.
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Sample Blueprint JSON</label>
                        <textarea class="form-control" id="rulesPayloadInput" rows="12" 
                                  placeholder='Paste your blueprint JSON payload here...
Example structure:
{
  "spec": {
    "name": "MyBlueprint",
    "resources": {
      "service_definition_list": [...],
      "substrate_definition_list": [...],
      "app_profile_list": [...]
    }
  }
}'></textarea>
                        </div>
                    
                    <button class="btn btn-primary btn-lg" onclick="analyzePayloadForRules()">
                        <i class="bi bi-search me-2"></i> Analyze Blueprint
                    </button>
                        </div>
                
                <!-- Runbook Payload Input -->
                <div id="rulesRunbookInput" class="card-dark section-hidden">
                    <h5><i class="bi bi-play-circle"></i> Runbook Payload</h5>
                    <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                        Paste a sample runbook JSON payload to analyze its structure and create scaling rules.
                    </p>
                    
                    <div class="mb-3">
                        <label class="form-label">Sample Runbook JSON</label>
                        <textarea class="form-control" id="rulesRunbookPayloadInput" rows="12" 
                                  placeholder='Paste your runbook JSON payload here...
Example structure:
{
  "spec": {
    "name": "MyRunbook",
    "resources": {
      "runbook": {
        "task_definition_list": [...]
      },
      "endpoint_definition_list": [...],
      "credential_definition_list": [...]
    }
  }
}'></textarea>
                    </div>
                    
                    <button class="btn btn-success btn-lg" onclick="analyzeRunbookPayload()">
                        <i class="bi bi-search me-2"></i> Analyze Runbook
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Configure Entities -->
            <div id="rulesStep2" class="section-hidden">
                <div class="info-box">
                    <i class="bi bi-info-circle"></i>
                    <div>
                        <strong>Temporary Entity Counts:</strong> Set counts below for preview only. 
                        These values are NOT saved with the rules. When using these rules later, 
                        you'll specify counts at generation time.
                    </div>
                </div>
                
                <!-- Blueprint Entity Hierarchy (shown for blueprints) -->
                <div id="rulesBlueprintHierarchy" class="card-dark">
                    <h5><i class="bi bi-diagram-2"></i> Blueprint Entity Hierarchy</h5>
                    
                    <!-- Blueprint Type Toggle -->
                    <div class="blueprint-type-toggle mb-4">
                        <button class="bp-type-btn active" data-bptype="multi_vm" onclick="setRulesBlueprintType('multi_vm')">
                            <i class="bi bi-hdd-stack"></i> Multi VM
                        </button>
                        <button class="bp-type-btn" data-bptype="single_vm" onclick="setRulesBlueprintType('single_vm')">
                            <i class="bi bi-hdd"></i> Single VM
                        </button>
                    </div>
                    
                    <!-- Blueprint Entity Hierarchy -->
                    <div class="hierarchy-container">
                        <!-- App Profiles (Primary) -->
                        <div class="hierarchy-main-entity">
                            <div class="hierarchy-entity-header">
                                <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                                    <i class="bi bi-person-badge"></i>
                                </div>
                                <div class="hierarchy-entity-info">
                                    <span class="hierarchy-entity-name">App Profiles</span>
                                    <span class="hierarchy-entity-path">spec.resources.app_profile_list</span>
                                </div>
                                <div class="hierarchy-entity-input">
                                    <button class="count-btn" onclick="adjustRulesAppProfileCount(-1)">-</button>
                                    <input type="number" id="rulesAppProfileCountInput" value="1" min="1" max="10" 
                                           onchange="onRulesAppProfileCountChange(this.value)">
                                    <button class="count-btn" onclick="adjustRulesAppProfileCount(1)">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deployments per Profile -->
                        <div class="hierarchy-main-entity" style="margin-top: 16px;">
                            <div class="hierarchy-entity-header">
                                <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                    <i class="bi bi-rocket-takeoff"></i>
                                </div>
                                <div class="hierarchy-entity-info">
                                    <span class="hierarchy-entity-name">Services</span>
                                    <span class="hierarchy-entity-path">service_definition_list</span>
                                </div>
                                <div class="hierarchy-entity-input">
                                    <button class="count-btn" onclick="adjustRulesServiceCount(-1)">-</button>
                                    <input type="number" id="rulesServiceCountInput" value="1" min="1" max="50" 
                                           onchange="onRulesServiceCountChange(this.value)">
                                    <button class="count-btn" onclick="adjustRulesServiceCount(1)">+</button>
                                </div>
                            </div>
                            
                            <!-- Linked Info -->
                            <div class="linked-entities-info">
                                <i class="bi bi-link-45deg"></i>
                                <span>Auto-calculated: Substrates & Packages = App Profiles Ã— Services</span>
                            </div>
                        </div>
                        
                        <!-- Sub-entities -->
                        <div id="rulesServiceSubEntities" class="hierarchy-sub-entities">
                            <div class="sub-entity-connector"></div>
                            
                            <div class="sub-entity-grid">
                                <div class="sub-entity-header">
                                    <span class="header-name">Entity Name</span>
                                    <span class="header-count">Count</span>
                                </div>
                                <!-- Credentials -->
                                <div class="sub-entity-card" data-entity="credential_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                        <i class="bi bi-key"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Credentials</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="1" max="10" id="rulesCredentialCount"
                                               onchange="updateRulesSubEntityCount('credential_definition_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <!-- Entity Relationship Diagram -->
                    <div class="entity-relationship-box">
                        <h6><i class="bi bi-diagram-3"></i> Entity Relationships</h6>
                        <div class="relationship-diagram">
                            <div class="rel-node rel-profile">App Profile</div>
                            <div class="rel-arrow">â†’</div>
                            <div class="rel-node rel-deployment">Deployment</div>
                            <div class="rel-arrow">â†’</div>
                            <div class="rel-node rel-substrate">Substrate/Package</div>
                        </div>
                        <div class="relationship-notes">
                            <small><i class="bi bi-info-circle"></i> Total Substrates/Packages = App Profiles Ã— Deployments per Profile</small>
                        </div>
                    </div>
                    
                    <!-- App Profile Options -->
                    <div class="app-profile-options mt-4">
                        <h6><i class="bi bi-sliders"></i> App Profile Options <span class="badge bg-secondary">Optional</span></h6>
                        <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                            Configure optional features for each app profile. Set to 0 to exclude from generated payload.
                        </p>
                        
                        <div class="profile-options-grid">
                            <!-- Profile Actions -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-lightning-charge" style="color: #f59e0b;"></i>
                                    <span>Profile Actions</span>
                                </div>
                                <div class="profile-option-desc">Custom actions (scale in/out, restart, etc.)</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="20" id="rulesProfileActionCount"
                                           onchange="updateRulesProfileOption('action_list', this.value)">
                    </div>
                </div>
                
                            <!-- Snapshot Configs -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-camera" style="color: #8b5cf6;"></i>
                                    <span>Snapshot Configs</span>
                    </div>
                                <div class="profile-option-desc">Snapshot configuration policies</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesSnapshotConfigCount"
                                           onchange="updateRulesProfileOption('snapshot_config_list', this.value)">
                    </div>
                </div>
                
                            <!-- Restore Configs -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-arrow-counterclockwise" style="color: #10b981;"></i>
                                    <span>Restore Configs</span>
                                </div>
                                <div class="profile-option-desc">Restore configuration policies</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesRestoreConfigCount"
                                           onchange="updateRulesProfileOption('restore_config_list', this.value)">
                                </div>
                            </div>
                            
                            <!-- Patch List -->
                            <div class="profile-option-card">
                                <div class="profile-option-header">
                                    <i class="bi bi-bandaid" style="color: #ec4899;"></i>
                                    <span>Patch Configs</span>
                                </div>
                                <div class="profile-option-desc">Configuration patch definitions</div>
                                <div class="profile-option-input">
                                    <input type="number" value="0" min="0" max="10" id="rulesPatchListCount"
                                           onchange="updateRulesProfileOption('patch_list', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Runbook Entity Hierarchy (shown for runbooks) -->
                <div id="rulesRunbookHierarchy" class="card-dark section-hidden">
                    <h5><i class="bi bi-play-circle"></i> Runbook Entity Hierarchy</h5>
                    
                    <!-- Task Execution Toggle -->
                    <div class="blueprint-type-toggle mb-4">
                        <button class="bp-type-btn active" data-exectype="parallel" onclick="setRulesTaskExecution('parallel')">
                            <i class="bi bi-arrows-expand"></i> Parallel
                    </button>
                        <button class="bp-type-btn" data-exectype="series" onclick="setRulesTaskExecution('series')">
                            <i class="bi bi-arrow-down"></i> Series
                        </button>
                </div>
                    
                    <div class="hierarchy-container">
                        <div class="sub-entity-grid">
                            <div class="sub-entity-header">
                                <span class="header-name">Entity Name</span>
                                <span class="header-count">Count</span>
                    </div>
                            <!-- Tasks -->
                            <div class="sub-entity-card" data-entity="task_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                    <i class="bi bi-list-task"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Tasks</span>
                                </div>
                                <div class="sub-entity-count">
                                    <input type="number" value="1" min="1" max="50" id="rulesTaskCount"
                                           onchange="updateRulesRunbookEntityCount('task_definition_list', this.value)">
                                </div>
                            </div>
                            <!-- Endpoints -->
                            <div class="sub-entity-card" data-entity="endpoint_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                    <i class="bi bi-broadcast-pin"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Endpoints</span>
                                </div>
                                <div class="sub-entity-count">
                                    <input type="number" value="1" min="0" max="20" id="rulesEndpointCount"
                                           onchange="updateRulesRunbookEntityCount('endpoint_definition_list', this.value)">
                                </div>
                            </div>
                            <!-- Credentials -->
                            <div class="sub-entity-card" data-entity="credential_definition_list">
                                <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                    <i class="bi bi-key"></i>
                                </div>
                                <div class="sub-entity-details">
                                    <span class="sub-entity-name">Credentials</span>
                                </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="10" id="rulesRunbookCredentialCount"
                                           onchange="updateRulesRunbookEntityCount('credential_definition_list', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transformation Rules (always visible) -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-sliders text-warning"></i> Transformation Rules 
                            <span class="badge bg-warning text-dark" id="rulesRulesBadge">0</span>
                        </h5>
                        <button class="btn btn-sm btn-warning" onclick="showAddRuleForm('rules')">
                            <i class="bi bi-plus me-1"></i> Add Rule
                        </button>
                    </div>
                        <div id="rulesAddRuleForm" style="display: none;"></div>
                        <div id="rulesRulesList"></div>
                    </div>
                
                <!-- Hidden containers for legacy compatibility -->
                <div style="display: none;">
                    <div id="rulesEntitiesBadge">0</div>
                    <div id="rulesEntitiesTree"></div>
                    <div id="rulesExcludedSection"><div id="rulesExcludedBadge">0</div><div id="rulesExcludedList"></div></div>
            </div>

                <!-- Actions -->
                <div class="card-dark">
                    <div class="d-flex gap-3">
                        <button class="btn btn-primary" onclick="previewRulesPayload()">
                            <i class="bi bi-eye me-2"></i> Preview Payload
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToRulesStep(1)">
                            <i class="bi bi-arrow-left me-2"></i> Back
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Preview & Save -->
            <div id="rulesStep3" class="section-hidden">
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-code-square"></i> Payload Preview</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="copyPreviewPayload()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadPreviewPayload()">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div class="json-preview" id="rulesPreviewPayload"></div>
                </div>
                
                <div class="card-dark">
                    <div class="info-box" style="margin-bottom: 20px;">
                        <i class="bi bi-check-circle"></i>
                        <div>
                            <strong>Ready to save!</strong> Only the transformation rules will be saved. 
                            Entity counts are temporary and will need to be specified each time you generate a payload.
                        </div>
                    </div>
                    
                    <!-- Auto-save to Blueprint Entity -->
                    <div class="mb-4">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Auto-save to Blueprint:</strong> Rules will be automatically saved to the "blueprint" entity configuration for immediate use in payload generation.
                        </div>
                    </div>
                    
                    <!-- Task Execution option for Runbooks -->
                    <div id="rulesTaskExecutionContainer" style="display:none; margin-bottom: 20px;">
                        <label class="form-label"><i class="bi bi-diagram-3"></i> Task Execution Mode</label>
                        <select class="form-select" id="rulesTaskExecutionSelect" style="max-width: 300px;">
                            <option value="parallel">Parallel (all tasks run simultaneously)</option>
                            <option value="series">Series (tasks run sequentially)</option>
                        </select>
                        <small class="text-muted">Choose how tasks will be executed in this runbook</small>
                    </div>
                    
                    <div class="d-flex gap-3">
                        <button class="btn btn-success btn-lg" onclick="acceptAndSaveRules()">
                            <i class="bi bi-check-lg me-2"></i> Accept & Save Rules
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToRulesStep(2)">
                            <i class="bi bi-arrow-left me-2"></i> Back to Edit
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 2: Create Entities (default) -->
        <div id="createEntitiesSection" class="section">
            <div class="content-header">
                <h2>
                    <i class="bi bi-layers"></i>
                    Create Entities
                    <span class="badge bg-success">Section 2</span>
                </h2>
                <p>Use saved rules to generate payloads with custom entity counts.</p>
            </div>
            
            <!-- App Type Switcher -->
                <div class="card-dark">
                <div class="app-switcher">
                    <div class="app-switcher-tabs">
                        <button class="app-switcher-tab active" data-type="blueprint" onclick="switchAppType('blueprint')">
                            <i class="bi bi-diagram-3"></i>
                            <span>Blueprint</span>
                        </button>
                        <button class="app-switcher-tab" data-type="runbook" onclick="switchAppType('runbook')">
                            <i class="bi bi-play-circle"></i>
                            <span>Runbook</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Blueprint Configuration Panel -->
            <div id="blueprintConfigPanel" class="config-panel">
                <!-- Blueprint Rules & Entities Info -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-diagram-3"></i> Blueprint Configuration</h5>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                Ready to generate payloads with the blueprint configuration.
                            </p>
                        </div>
                        <button class="btn btn-outline-info btn-sm" onclick="showBlueprintRulesModal()">
                            <i class="bi bi-list-ul"></i> View Rules & Entities
                        </button>
                    </div>
                    
                    <!-- Auto-select blueprint -->
                    <div class="alert alert-success" style="margin: 0;">
                        <i class="bi bi-check-circle"></i>
                        <strong>Blueprint configuration loaded:</strong> 23 scalable entities ready for payload generation.
                    </div>
                </div>
                
                <!-- Blueprint Hierarchy Builder -->
                <div id="blueprintHierarchyBuilder" class="section-hidden">
                    <div class="card-dark">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-diagram-2"></i> Blueprint Entity Hierarchy</h5>
                            <span id="selectedBlueprintName" class="badge bg-primary"></span>
                        </div>
                        
                        <!-- Blueprint Type Toggle -->
                        <div class="blueprint-type-toggle mb-4">
                            <button class="bp-type-btn active" data-bptype="multi_vm" onclick="setBlueprintType('multi_vm')">
                                <i class="bi bi-hdd-stack"></i> Multi VM
                            </button>
                            <button class="bp-type-btn" data-bptype="single_vm" onclick="setBlueprintType('single_vm')">
                                <i class="bi bi-hdd"></i> Single VM
                            </button>
                        </div>
                        
                        <!-- Blueprint Name Input -->
                        <div class="mb-4">
                            <label class="form-label" for="blueprintNameInput">
                                <i class="bi bi-tag"></i> Blueprint Name <span class="badge bg-secondary">Optional</span>
                            </label>
                            <input type="text" class="form-control" id="blueprintNameInput" 
                                   placeholder="Leave empty for default: st_bp_gen_timestamp"
                                   style="background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
                            <div class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 6px;">
                                Custom name for the generated blueprint. If empty, defaults to "st_bp_gen_YYYYMMDD_HHMMSS"
                            </div>
                        </div>
                        
                        <!-- Blueprint Entity Hierarchy -->
                        <div class="hierarchy-container">
                            <!-- App Profiles (Primary) -->
                            <div class="hierarchy-main-entity">
                                <div class="hierarchy-entity-header">
                                    <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #ec4899, #be185d);">
                                        <i class="bi bi-person-badge"></i>
                                    </div>
                                    <div class="hierarchy-entity-info">
                                        <span class="hierarchy-entity-name">App Profiles</span>
                                        <span class="hierarchy-entity-path">app_profile_list</span>
                                    </div>
                                    <div class="hierarchy-entity-input">
                                        <button class="count-btn" onclick="adjustAppProfileCount(-1)">-</button>
                                        <input type="number" id="appProfileCountInput" value="1" min="1" max="10" 
                                               onchange="onAppProfileCountChange(this.value)">
                                        <button class="count-btn" onclick="adjustAppProfileCount(1)">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Deployments per Profile -->
                            <div class="hierarchy-main-entity" style="margin-top: 16px;">
                                <div class="hierarchy-entity-header">
                                    <div class="hierarchy-entity-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                        <i class="bi bi-rocket-takeoff"></i>
                                    </div>
                                    <div class="hierarchy-entity-info">
                                        <span class="hierarchy-entity-name">Services</span>
                                        <span class="hierarchy-entity-path">service_definition_list</span>
                                    </div>
                                    <div class="hierarchy-entity-input">
                                        <button class="count-btn" onclick="adjustServiceCount(-1)">-</button>
                                        <input type="number" id="serviceCountInput" value="1" min="1" max="50" 
                                               onchange="onServiceCountChange(this.value)">
                                        <button class="count-btn" onclick="adjustServiceCount(1)">+</button>
                                    </div>
                                </div>
                                
                                <!-- Linked Info -->
                                <div class="linked-entities-info">
                                    <i class="bi bi-link-45deg"></i>
                                    <span>Auto-calculated: Substrates & Packages = App Profiles Ã— Services</span>
                                </div>
                            </div>
                            
                            <!-- Sub-entities -->
                            <div id="serviceSubEntities" class="hierarchy-sub-entities">
                                <div class="sub-entity-connector"></div>
                                
                                <div class="sub-entity-grid">
                                    <div class="sub-entity-header">
                                        <span class="header-name">Entity Name</span>
                                        <span class="header-count">Count</span>
                                    </div>
                                    <!-- Credentials -->
                                    <div class="sub-entity-card" data-entity="credential_definition_list">
                                        <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                            <i class="bi bi-key"></i>
                                        </div>
                                        <div class="sub-entity-details">
                                            <span class="sub-entity-name">Credentials</span>
                                        </div>
                                        <div class="sub-entity-count">
                                            <input type="number" value="1" min="1" max="10" data-entity="credential_definition_list"
                                                   onchange="updateSubEntityCount('credential_definition_list', this.value)">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Entity Relationship Diagram -->
                        <div class="entity-relationship-box">
                            <h6><i class="bi bi-diagram-3"></i> Entity Relationships</h6>
                            <div class="relationship-diagram">
                                <div class="rel-node rel-profile">App Profile</div>
                                <div class="rel-arrow">â†’</div>
                                <div class="rel-node rel-deployment">Service</div>
                                <div class="rel-arrow">â†’</div>
                                <div class="rel-node rel-substrate">Substrate/Package</div>
                            </div>
                            <div class="relationship-notes">
                                <small><i class="bi bi-info-circle"></i> Total Substrates/Packages = App Profiles Ã— Services</small>
                            </div>
                        </div>
                        
                        <!-- Nested Entity Configuration -->
                        <div class="nested-entities-config mt-4">
                            <h6><i class="bi bi-diagram-3"></i> Nested Entity Configuration <span class="badge bg-info">Multi-Level</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure tasks, variables, and actions at each level where they exist.
                            </p>
                            
                            <!-- Service Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('service')">
                                    <i class="bi bi-chevron-down" id="serviceChevron"></i>
                                    <span><i class="bi bi-server"></i> Service Level</span>
                                </div>
                                <div id="serviceNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Actions per Service</label>
                                        <input type="number" value="0" min="0" max="20" id="serviceActionCount"
                                               placeholder="Actions">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Service Action Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="serviceActionTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Service Action Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="serviceActionVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Substrate Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('substrate')">
                                    <i class="bi bi-chevron-down" id="substrateChevron"></i>
                                    <span><i class="bi bi-hdd-network"></i> Substrate Level</span>
                                </div>
                                <div id="substrateNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Actions per Substrate</label>
                                        <input type="number" value="0" min="0" max="20" id="substrateActionCount"
                                               placeholder="Actions">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Substrate Action Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="substrateActionTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Substrate Action Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="substrateActionVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Package Level -->
                            <div class="nested-level-section mb-3">
                                <div class="nested-level-header" onclick="toggleNestedSection('package')">
                                    <i class="bi bi-chevron-down" id="packageChevron"></i>
                                    <span><i class="bi bi-box"></i> Package Level</span>
                                </div>
                                <div id="packageNestedConfig" class="nested-level-content">
                                    <div class="nested-entity-group">
                                        <label>Tasks per Install Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="packageInstallTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Install Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="packageInstallVariableCount"
                                               placeholder="Variables">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Tasks per Uninstall Runbook</label>
                                        <input type="number" value="1" min="1" max="50" id="packageUninstallTaskCount"
                                               placeholder="Tasks">
                                    </div>
                                    <div class="nested-entity-group">
                                        <label>Variables per Uninstall Runbook</label>
                                        <input type="number" value="0" min="0" max="20" id="packageUninstallVariableCount"
                                               placeholder="Variables">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Substrate Options -->
                        <div class="substrate-options mt-4">
                            <h6><i class="bi bi-sliders"></i> Substrate Options <span class="badge bg-secondary">Optional</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure optional features for substrates.
                            </p>
                            
                            <div class="profile-options-grid">
                                <!-- Guest Customization Toggle -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-gear" style="color: #3b82f6;"></i>
                                        <span>Guest Customization</span>
                                    </div>
                                    <div class="profile-option-desc">Include guest customization in VM resources</div>
                                    <div class="profile-option-input">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="guestCustomizationToggle">
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- App Profile Options -->
                        <div class="app-profile-options mt-4">
                            <h6><i class="bi bi-sliders"></i> App Profile Options <span class="badge bg-secondary">Optional</span></h6>
                            <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 12px;">
                                Configure optional features for each app profile. Set to 0 to exclude from generated payload.
                            </p>
                            
                            <div class="profile-options-grid">
                                <!-- Profile Actions -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-lightning-charge" style="color: #f59e0b;"></i>
                                        <span>Profile Actions</span>
                                    </div>
                                    <div class="profile-option-desc">Custom actions (scale in/out, restart, etc.)</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="20" id="profileActionCount"
                                               onchange="updateProfileOption('action_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Snapshot Configs -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-camera" style="color: #8b5cf6;"></i>
                                        <span>Snapshot Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Snapshot configuration policies</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="snapshotConfigCount"
                                               onchange="updateProfileOption('snapshot_config_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Restore Configs -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-arrow-counterclockwise" style="color: #10b981;"></i>
                                        <span>Restore Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Restore configuration policies</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="restoreConfigCount"
                                               onchange="updateProfileOption('restore_config_list', this.value)">
                                    </div>
                                </div>
                                
                                <!-- Patch List -->
                                <div class="profile-option-card">
                                    <div class="profile-option-header">
                                        <i class="bi bi-bandaid" style="color: #ec4899;"></i>
                                        <span>Patch Configs</span>
                                    </div>
                                    <div class="profile-option-desc">Configuration patch definitions</div>
                                    <div class="profile-option-input">
                                        <input type="number" value="0" min="0" max="10" id="patchListCount"
                                               onchange="updateProfileOption('patch_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live UUID Configuration -->
                    <div class="card-dark">
                        <h5><i class="bi bi-cloud-arrow-down"></i> Live UUID Configuration</h5>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                            Connect to a live Prism Central to fetch real UUIDs for projects, images, and other resources.
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-globe"></i> PC URL</label>
                                <input type="text" class="form-control" id="pcUrlInput" 
                                       placeholder="https://iam.nconprem-10-53-58-35.ccpnx.com/ or https://10.56.78.90:9440/"
                                       style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-person"></i> Username</label>
                                <input type="text" class="form-control" id="pcUsernameInput" 
                                       value="admin" placeholder="admin">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-key"></i> Password</label>
                                <input type="password" class="form-control" id="pcPasswordInput" 
                                       value="Nutanix.123" placeholder="Nutanix.123">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="testPCConnection()" id="testConnectionBtn">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-primary" onclick="fetchProjects()" id="fetchProjectsBtn" disabled>
                                        <i class="bi bi-folder"></i> Fetch Projects
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Status -->
                        <div id="connectionStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-success" id="connectionSuccess" style="display: none;">
                                <i class="bi bi-check-circle"></i> Connection successful! You can now fetch live data.
                            </div>
                            <div class="alert alert-danger" id="connectionError" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> <span id="connectionErrorText">Connection failed</span>
                            </div>
                        </div>
                        
                        <!-- Projects List -->
                        <div id="projectsSection" class="mt-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-search"></i> Search Projects</label>
                                    <input type="text" class="form-control" id="projectSearchInput" 
                                           placeholder="Search project names..." onkeyup="debouncedSearchProjects()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-folder2"></i> Select Project</label>
                                    <div id="projectSelectContainer"></div>
                                </div>
                            </div>
                            
                            <!-- Project Resources - NEW SIMPLIFIED VERSION -->
                            <div id="simpleProjectResourcesSection" class="mt-4" style="display: none; border: 2px solid #28a745; padding: 15px; border-radius: 8px;">
                                <h6 style="color: #28a745;"><i class="bi bi-collection"></i> Project Resources (Live Data)</h6>
                                <div class="alert alert-info">
                                    <small>Resources loaded from project: <span id="selectedProjectName">None</span></small>
                                </div>
                                
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <select class="form-select" id="simpleAccountSelect">
                                            <option value="">Select account...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="accountCount">0</span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <select class="form-select" id="simpleClusterSelect">
                                            <option value="">Select cluster...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="clusterCount">0</span></small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="simpleEnvironmentSelect">
                                            <option value="">Select environment...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="environmentCount">0</span></small>
                                    </div>
                                </div>
                                
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <select class="form-select" id="simpleNetworkSelect">
                                            <option value="">Select network...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="networkCount">0</span></small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <select class="form-select" id="simpleSubnetSelect">
                                            <option value="">Select subnet...</option>
                                        </select>
                                        <small class="text-muted">Count: <span id="subnetCount">0</span></small>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-success" onclick="fetchImages()" id="simpleFetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <select class="form-select" id="simpleImageSelect">
                                        <option value="">Select image...</option>
                                    </select>
                                    <small class="text-muted">Count: <span id="imageCount">0</span></small>
                                </div>
                            </div>
                            
                            <!-- Original Project Resources (Hidden for debugging) -->
                            <div id="projectResourcesSection" class="mt-4" style="display: none;">
                                <h6><i class="bi bi-collection"></i> Project Resources</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <div id="accountSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <div id="clusterSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <div id="environmentSelectContainer"></div>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <div id="networkSelectContainer"></div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <div id="subnetSelectContainer"></div>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchImages()" id="fetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <div id="imageSelectContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="card-dark">
                        <button class="btn btn-primary btn-lg" onclick="generateBlueprintPayload()">
                            <i class="bi bi-gear me-2"></i> Generate Blueprint Payload
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="backToBlueprintSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change Entity
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Runbook Configuration Panel -->
            <div id="runbookConfigPanel" class="config-panel section-hidden">
                <!-- Runbook Rules & Entities Info -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-1"><i class="bi bi-play-circle"></i> Runbook Configuration</h5>
                            <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">
                                Ready to generate payloads with the runbook configuration.
                            </p>
                        </div>
                        <button class="btn btn-outline-info btn-sm" onclick="showRunbookRulesModal()">
                            <i class="bi bi-list-ul"></i> View Rules & Entities
                        </button>
                    </div>
                    
                    <!-- Auto-select runbook -->
                    <div class="alert alert-success" style="margin: 0;">
                        <i class="bi bi-check-circle"></i>
                        <strong>Runbook configuration loaded:</strong> Available for payload generation.
                    </div>
                </div>
                
                <!-- Runbook Hierarchy Builder -->
                <div id="runbookHierarchyBuilder" class="section-hidden">
                    <div class="card-dark">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-play-circle"></i> Runbook Entity Hierarchy</h5>
                            <span id="selectedRunbookName" class="badge bg-success"></span>
            </div>
            
                        <!-- Task Execution Toggle -->
                        <div class="blueprint-type-toggle mb-4">
                            <button class="bp-type-btn active" data-exectype="parallel" onclick="setTaskExecution('parallel')">
                                <i class="bi bi-arrows-expand"></i> Parallel
                            </button>
                            <button class="bp-type-btn" data-exectype="series" onclick="setTaskExecution('series')">
                                <i class="bi bi-arrow-down"></i> Series
                            </button>
                        </div>
                        
                        <!-- Runbook Entities -->
                        <div class="hierarchy-container">
                            <div class="sub-entity-grid">
                                <div class="sub-entity-header">
                                    <span class="header-name">Entity Name</span>
                                    <span class="header-count">Count</span>
                                </div>
                                <!-- Tasks -->
                                <div class="sub-entity-card" data-entity="task_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                        <i class="bi bi-list-task"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Tasks</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="1" max="50" data-entity="task_definition_list"
                                               onchange="updateRunbookEntityCount('task_definition_list', this.value)">
                                    </div>
                                </div>
                                <!-- Endpoints -->
                                <div class="sub-entity-card" data-entity="endpoint_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                        <i class="bi bi-broadcast-pin"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Endpoints</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="20" data-entity="endpoint_definition_list"
                                               onchange="updateRunbookEntityCount('endpoint_definition_list', this.value)">
                                    </div>
                                </div>
                                <!-- Credentials -->
                                <div class="sub-entity-card" data-entity="credential_definition_list">
                                    <div class="sub-entity-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                                        <i class="bi bi-key"></i>
                                    </div>
                                    <div class="sub-entity-details">
                                        <span class="sub-entity-name">Credentials</span>
                                    </div>
                                    <div class="sub-entity-count">
                                        <input type="number" value="1" min="0" max="10" data-entity="credential_definition_list"
                                               onchange="updateRunbookEntityCount('credential_definition_list', this.value)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live UUID Configuration for Runbook -->
                    <div class="card-dark">
                        <h5><i class="bi bi-cloud-arrow-down"></i> Live UUID Configuration</h5>
                        <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                            Connect to a live Prism Central to fetch real UUIDs for projects, images, and other resources.
                        </p>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label"><i class="bi bi-globe"></i> PC URL</label>
                                <input type="text" class="form-control" id="runbookPcUrlInput" 
                                       placeholder="https://iam.nconprem-10-53-58-35.ccpnx.com/ or https://10.56.78.90:9440/"
                                       style="font-family: 'JetBrains Mono', monospace;">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-person"></i> Username</label>
                                <input type="text" class="form-control" id="runbookPcUsernameInput" 
                                       value="admin" placeholder="admin">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-key"></i> Password</label>
                                <input type="password" class="form-control" id="runbookPcPasswordInput" 
                                       value="Nutanix.123" placeholder="Nutanix.123">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary" onclick="testRunbookPCConnection()" id="runbookTestConnectionBtn">
                                        <i class="bi bi-wifi"></i> Test Connection
                                    </button>
                                    <button class="btn btn-primary" onclick="fetchRunbookProjects()" id="runbookFetchProjectsBtn" disabled>
                                        <i class="bi bi-folder"></i> Fetch Projects
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection Status -->
                        <div id="runbookConnectionStatus" class="mt-3" style="display: none;">
                            <div class="alert alert-success" id="runbookConnectionSuccess" style="display: none;">
                                <i class="bi bi-check-circle"></i> Connection successful! You can now fetch live data.
                            </div>
                            <div class="alert alert-danger" id="runbookConnectionError" style="display: none;">
                                <i class="bi bi-exclamation-triangle"></i> <span id="runbookConnectionErrorText">Connection failed</span>
                            </div>
                        </div>
                        
                        <!-- Projects List -->
                        <div id="runbookProjectsSection" class="mt-4" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-search"></i> Search Projects</label>
                                    <input type="text" class="form-control" id="runbookProjectSearchInput" 
                                           placeholder="Search project names..." onkeyup="debouncedSearchRunbookProjects()">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><i class="bi bi-folder2"></i> Select Project</label>
                                    <div id="runbookProjectSelectContainer"></div>
                                </div>
                            </div>
                            
                            <!-- Project Resources -->
                            <div id="runbookProjectResourcesSection" class="mt-4" style="display: none;">
                                <h6><i class="bi bi-collection"></i> Project Resources</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Account</label>
                                        <div id="runbookAccountSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Cluster</label>
                                        <div id="runbookClusterSelectContainer"></div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Environment</label>
                                        <select class="form-select" id="runbookEnvironmentSelect">
                                            <option value="">Select environment...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mt-2">
                                    <div class="col-md-6">
                                        <label class="form-label">External Network</label>
                                        <select class="form-select" id="runbookNetworkSelect">
                                            <option value="">Select network...</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Subnet</label>
                                        <select class="form-select" id="runbookSubnetSelect">
                                            <option value="">Select subnet...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Images Section -->
                                <div class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6><i class="bi bi-disc"></i> Images</h6>
                                        <button class="btn btn-sm btn-outline-primary" onclick="fetchRunbookImages()" id="runbookFetchImagesBtn" disabled>
                                            <i class="bi bi-arrow-clockwise"></i> Fetch Images
                                        </button>
                                    </div>
                                    <div id="runbookImageSelectContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generate Button -->
                    <div class="card-dark">
                        <button class="btn btn-success btn-lg" onclick="generateRunbookPayload()">
                            <i class="bi bi-gear me-2"></i> Generate Runbook Payload
                        </button>
                        <button class="btn btn-outline-secondary ms-2" onclick="backToRunbookSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change Entity
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Legacy Entity Configuration (hidden, kept for compatibility) -->
            <div id="entityApiSelection" style="display: none;">
                <div id="entityApiList"></div>
            </div>
            <div id="entityConfiguration" class="section-hidden">
                <div class="card-dark" style="padding: 16px 20px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                API: <strong id="selectedApiName" style="color: var(--text-primary);"></strong>
                            </p>
                        </div>
                        <button class="btn btn-outline-secondary btn-sm" onclick="backToApiSelection()">
                            <i class="bi bi-arrow-left me-2"></i> Change API
                        </button>
                    </div>
                    <!-- Blueprint Type selector for blueprints -->
                    <div id="entityBlueprintTypeContainer" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center gap-3">
                            <label class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                <i class="bi bi-cpu"></i> Blueprint Type:
                            </label>
                            <select class="form-select" id="entityBlueprintTypeSelect" style="width: auto; min-width: 200px;" onchange="updateEntityBlueprintType()">
                                <option value="multi_vm">Multi VM (scalable services)</option>
                                <option value="single_vm">Single VM (1 service, simplified)</option>
                            </select>
                        </div>
                    </div>
                    <!-- Task Execution selector for runbooks -->
                    <div id="entityTaskExecutionContainer" class="mt-3" style="display: none;">
                        <div class="d-flex align-items-center gap-3">
                            <label class="mb-0" style="color: var(--text-secondary); font-size: 13px;">
                                <i class="bi bi-diagram-3"></i> Task Execution:
                            </label>
                            <select class="form-select" id="entityTaskExecutionSelect" style="width: auto; min-width: 200px;" onchange="updateEntityTaskExecution()">
                                <option value="parallel">Parallel (all tasks simultaneously)</option>
                                <option value="series">Series (tasks sequentially)</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Scalable Entities - collapsed by default -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleCollapsible('entityEntitiesContent')">
                        <h6><i class="bi bi-diagram-2 text-primary"></i> Scalable Entities 
                            <span class="badge bg-primary" id="entityEntitiesBadge">0</span>
                        </h6>
                        <i class="bi bi-chevron-right" id="entityEntitiesIcon"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="entityEntitiesContent">
                        <div class="entity-tree" id="entityEntitiesTree"></div>
                    </div>
                </div>
                
                <!-- Excluded Entities - collapsed by default -->
                <div class="collapsible-section" id="entityExcludedSection" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible('entityExcludedContent')">
                        <h6><i class="bi bi-eye-slash text-danger"></i> Excluded Entities 
                            <span class="badge bg-danger" id="entityExcludedBadge">0</span>
                        </h6>
                        <i class="bi bi-chevron-right" id="entityExcludedIcon"></i>
                    </div>
                    <div class="collapsible-content collapsed" id="entityExcludedContent">
                        <div id="entityExcludedList"></div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="card-dark">
                    <button class="btn btn-primary btn-lg" onclick="generateEntityPayload()">
                        <i class="bi bi-gear me-2"></i> Generate Payload
                    </button>
                </div>
            </div>
            
            <!-- Generated Payload -->
            <div id="entityResult" class="section-hidden">
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-code-square"></i> Generated Payload</h5>
                        <div>
                            <button class="btn btn-outline-secondary btn-sm me-2" onclick="copyEntityPayload()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadEntityPayload()">
                                <i class="bi bi-download"></i> Download
                            </button>
                        </div>
                    </div>
                    <div class="json-preview" id="entityGeneratedPayload"></div>
                </div>
            </div>
        </div>
        
        <!-- Section 3: Log Analyzer -->
        <div id="analyzerSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-diagram-2-fill" style="color: var(--accent-green);"></i>
                    Log Analyzer & Flow Visualization
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-green), var(--accent-blue));">Kubernetes</span>
                </h2>
                <p>Analyze microservice logs and visualize application flow diagrams from Kubernetes clusters.</p>
            </div>
            
            <!-- Cluster Type Selection -->
            <div class="card-dark">
                <h5><i class="bi bi-toggles"></i> Cluster Type</h5>
                <div class="row g-3 align-items-center">
                    <div class="col-md-12">
                        <div class="cluster-type-toggle">
                            <input type="radio" class="btn-check" name="clusterType" id="clusterTypePC" value="pc" checked>
                            <label class="btn btn-outline-primary" for="clusterTypePC">
                                <i class="bi bi-hdd-stack"></i> Prism Central (PC)
                            </label>
                            
                            <input type="radio" class="btn-check" name="clusterType" id="clusterTypeNCM" value="ncm">
                            <label class="btn btn-outline-primary" for="clusterTypeNCM">
                                <i class="bi bi-cloud"></i> Nutanix Cloud Manager (NCM)
                            </label>
                        </div>
                        <div class="form-text">
                            <strong>PC Mode:</strong> Uses Docker containers for log collection<br>
                            <strong>NCM Mode:</strong> Uses Kubernetes pods for log collection
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Configuration -->
            <div class="card-dark">
                <h5><i class="bi bi-server"></i> Connection Configuration</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6">
                        <label class="form-label">
                            <i class="bi bi-hdd-network"></i> <span id="ipAddressLabel">PC IP Address</span> <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="analyzerPcIp" 
                               placeholder="192.168.1.100" 
                               pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$"
                               title="Enter a valid IP address">
                        <div class="form-text" id="ipAddressHelp">IP address of the Prism Central cluster</div>
                    </div>
                    <div class="col-md-3" id="namespaceSection">
                        <label class="form-label">
                            <i class="bi bi-diagram-3"></i> Namespace
                        </label>
                        <input type="text" class="form-control" id="analyzerNamespace" 
                               value="ntnx-ncm-selfservice" 
                               placeholder="ntnx-ncm-selfservice">
                        <div class="form-text">Kubernetes namespace</div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-success btn-lg w-100" id="analyzerConnectBtn" onclick="connectToCluster()">
                                <i class="bi bi-play-circle"></i> Connect & Analyze
                            </button>
                            <button class="btn btn-outline-warning btn-sm w-100" id="analyzerRefreshBtn" onclick="connectToCluster(true)" style="display: none;">
                                <i class="bi bi-arrow-clockwise"></i> Fetch Latest Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Existing Logs Notification -->
            <div class="card-dark" id="analyzerExistingLogsSection" style="display: none;">
                <h5><i class="bi bi-database-check text-success"></i> Existing Logs Found</h5>
                <div class="alert alert-success" role="alert" style="border: 2px solid var(--accent-green); background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1));">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="bi bi-clock-history" style="font-size: 2rem; color: var(--accent-green);"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2" style="color: var(--accent-green);">
                                <i class="bi bi-speedometer2"></i> Save Time - Logs Already Available!
                            </h6>
                            <div id="existingLogsInfo" style="color: var(--text-primary);">
                                Collection time and details will appear here
                            </div>
                            <small class="text-muted mt-2 d-block">
                                Choose to use existing logs for instant analysis or fetch the latest logs from the cluster.
                            </small>
                        </div>
                        <div class="ms-3 d-flex flex-column gap-2">
                            <button class="btn btn-success btn-lg" onclick="useExistingLogs()" style="min-width: 140px;">
                                <i class="bi bi-lightning-charge"></i> Use Existing
                                <br><small style="font-size: 0.7em;">~5 seconds</small>
                            </button>
                            <button class="btn btn-outline-warning" onclick="fetchLatestLogs()" style="min-width: 140px;">
                                <i class="bi bi-arrow-clockwise"></i> Fetch Latest
                                <br><small style="font-size: 0.7em;">~5-15 minutes</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="card-dark" id="analyzerProgressSection" style="display: none;">
                <h5><i class="bi bi-activity"></i> Analysis Progress</h5>
                <div class="analyzer-progress">
                    <div class="progress-step" id="sshStep">
                        <div class="progress-icon">
                            <i class="bi bi-terminal"></i>
                        </div>
                        <div class="progress-content">
                            <div class="progress-title">SSH Connection</div>
                            <div class="progress-status">Waiting...</div>
                        </div>
                        <div class="progress-indicator">
                            <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                            <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                            <i class="bi bi-x-circle-fill text-danger" style="display: none;"></i>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="kubeconfigStep">
                        <div class="progress-icon">
                            <i class="bi bi-gear"></i>
                        </div>
                        <div class="progress-content">
                            <div class="progress-title">Kubeconfig Setup</div>
                            <div class="progress-status">Waiting...</div>
                        </div>
                        <div class="progress-indicator">
                            <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                            <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                            <i class="bi bi-x-circle-fill text-danger" style="display: none;"></i>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="podDiscoveryStep">
                        <div class="progress-icon">
                            <i class="bi bi-search"></i>
                        </div>
                        <div class="progress-content">
                            <div class="progress-title">Pod Discovery</div>
                            <div class="progress-status">Waiting...</div>
                        </div>
                        <div class="progress-indicator">
                            <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                            <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                            <i class="bi bi-x-circle-fill text-danger" style="display: none;"></i>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="logCollectionStep">
                        <div class="progress-icon">
                            <i class="bi bi-download"></i>
                        </div>
                        <div class="progress-content">
                            <div class="progress-title">Log Collection</div>
                            <div class="progress-status">Waiting...</div>
                        </div>
                        <div class="progress-indicator">
                            <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                            <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                            <i class="bi bi-x-circle-fill text-danger" style="display: none;"></i>
                        </div>
                    </div>
                    
                    <div class="progress-step" id="logAnalysisStep">
                        <div class="progress-icon">
                            <i class="bi bi-cpu"></i>
                        </div>
                        <div class="progress-content">
                            <div class="progress-title">Log Analysis</div>
                            <div class="progress-status">Waiting...</div>
                        </div>
                        <div class="progress-indicator">
                            <div class="spinner-border spinner-border-sm" style="display: none;"></div>
                            <i class="bi bi-check-circle-fill text-success" style="display: none;"></i>
                            <i class="bi bi-x-circle-fill text-danger" style="display: none;"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Application Selector -->
            <div class="card-dark" id="analyzerAppSelectorSection" style="display: none;">
                <h5><i class="bi bi-list-ul"></i> Application Selection</h5>
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label class="form-label">Select Application UUID</label>
                        <select class="form-select" id="analyzerAppSelector" onchange="loadApplicationFlow()">
                            <option value="">Choose an application...</option>
                        </select>
                        <div class="form-text">Applications discovered from log analysis</div>
                        <button class="btn btn-warning btn-sm mt-2" onclick="testTimelineSection()">
                            <i class="bi bi-bug"></i> Debug Timeline Section
                        </button>
                    </div>
                    <div class="col-md-4">
                        <div class="analyzer-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="totalAppsCount">0</div>
                                <div class="stat-label">Applications</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value" id="totalServicesCount">0</div>
                                <div class="stat-label">Services</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Flow Visualization -->
            <div class="card-dark" id="analyzerFlowSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-diagram-3"></i> Service Flow Diagram</h5>
                    <div class="flow-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="resetFlowZoom()">
                            <i class="bi bi-arrows-fullscreen"></i> Reset Zoom
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportFlowDiagram()">
                            <i class="bi bi-download"></i> Export
                        </button>
                    </div>
                </div>
                <div id="analyzerFlowDiagram" class="flow-diagram">
                    <!-- Flow diagram will be rendered here -->
                </div>
                
                <!-- Flow Legend -->
                <div class="flow-legend mt-3">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--accent-blue);"></div>
                        <span>Service Node</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--accent-green);"></div>
                        <span>Success</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--accent-orange);"></div>
                        <span>Warning</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--accent-red);"></div>
                        <span>Error</span>
                    </div>
                </div>
            </div>
            
            <!-- Timeline Analysis Section -->
            <div class="card-dark" id="timeline-analysis-section" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timeline Analysis</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" id="view-sequence-btn" onclick="openSequenceDiagram()" style="display: none;">
                            <i class="bi bi-box-arrow-up-right"></i> View Sequence Diagram
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="testTimelineSection()" style="margin-left: 5px;">
                            <i class="bi bi-bug"></i> Test Timeline
                        </button>
                        <button class="btn btn-sm btn-success" onclick="exportTimelineData()">
                            <i class="bi bi-download"></i> Export Report
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyTimelineData()">
                            <i class="bi bi-clipboard"></i> Copy Timeline
                        </button>
                    </div>
                </div>
                
                <!-- Summary Statistics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value" id="total-events">0</div>
                            <div class="stat-label">Total Events</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value" id="services-involved">0</div>
                            <div class="stat-label">Services</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value" id="reference-ids">0</div>
                            <div class="stat-label">Reference IDs</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-value" id="total-duration">0ms</div>
                            <div class="stat-label">Duration</div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-value" id="avg-event-interval">0ms</div>
                            <div class="stat-label">Avg Event Interval</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-item">
                            <div class="stat-value" id="peak-activity-service">N/A</div>
                            <div class="stat-label">Peak Activity Service</div>
                        </div>
                    </div>
                </div>
                
                <!-- Service Counts Summary -->
                <div class="mb-4">
                    <h6><i class="bi bi-bar-chart"></i> Service Event Counts</h6>
                    <div id="service-counts-summary" class="mt-2">
                        <!-- Service counts will be populated here -->
                    </div>
                </div>
                
                <!-- Timeline Events Table -->
                <div class="position-relative">
                    <div class="table-responsive" id="timeline-table-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #444;">
                        <table class="table table-dark table-striped mb-0">
                            <thead class="sticky-top" style="background-color: #2d3748; z-index: 10;">
                                <tr>
                                    <th style="width: 60px;">#</th>
                                    <th>Timestamp</th>
                                    <th>Service</th>
                                    <th>Operation</th>
                                    <th>Details</th>
                                    <th>Target Service</th>
                                </tr>
                            </thead>
                            <tbody id="timeline-events-body">
                                <!-- Timeline events will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Scroll Position Indicator -->
                    <div class="position-absolute top-0 end-0 m-2" style="z-index: 20;">
                        <div class="badge bg-secondary" id="scroll-position-indicator" style="display: none;">
                            <i class="bi bi-eye"></i> <span id="visible-rows">1-10</span>
                        </div>
                    </div>
                </div>
                
                <!-- Timeline Table Info -->
                <div class="mt-2 text-muted small text-center">
                    <span id="timeline-table-info">Timeline events will be displayed here</span>
                </div>
            </div>
            
            <!-- Service Details Panel -->
            <div class="card-dark" id="analyzerDetailsSection" style="display: none;">
                <h5><i class="bi bi-info-circle"></i> Service Interaction Details</h5>
                <div id="analyzerServiceDetails">
                    <!-- Service details will be populated here -->
                </div>
            </div>
        </div>
        
        <!-- Section 4: Unified Dashboard -->
        <div id="dashboardSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-speedometer2" style="color: var(--accent-blue);"></i>
                    Unified Dashboard
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));">Jarvis API</span>
                </h2>
                <p>Monitor cluster nodes and infrastructure health through Jarvis API integration.</p>
            </div>
            
            <!-- Dashboard Controls -->
            <div class="card-dark">
                <h5><i class="bi bi-gear"></i> Dashboard Configuration</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label for="poolId" class="form-label">Pool ID</label>
                        <input type="text" class="form-control" id="poolId" value="65e7aebf4dd19254d2bcd4b5" placeholder="Enter Pool ID">
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            Use "demo" for testing with mock data
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="pageLimit" class="form-label">Limit</label>
                        <select class="form-select" id="pageLimit">
                            <option value="25">25 nodes</option>
                            <option value="50">50 nodes</option>
                            <option value="100">100 nodes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadNodeDetails()">
                            <i class="bi bi-arrow-clockwise"></i> Load Nodes
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Stats -->
            <div class="row" id="dashboardStats" style="display: none;">
                <div class="col-md-3">
                    <div class="card-dark text-center">
                        <h3 class="text-success" id="totalNodes">0</h3>
                        <p class="mb-0">Total Nodes</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dark text-center">
                        <h3 class="text-success" id="healthyNodes">0</h3>
                        <p class="mb-0">Healthy Nodes</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dark text-center">
                        <h3 class="text-warning" id="warningNodes">0</h3>
                        <p class="mb-0">Warning Nodes</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card-dark text-center">
                        <h3 class="text-danger" id="criticalNodes">0</h3>
                        <p class="mb-0">Critical Nodes</p>
                    </div>
                </div>
            </div>
            
            <!-- Node Details Grid -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="bi bi-server"></i> Node Details</h5>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-outline-info" onclick="toggleFilters()">
                            <i class="bi bi-funnel"></i> Filters
                        </button>
                        <button class="btn btn-sm btn-outline-warning" onclick="fetchRDMLinks()">
                            <i class="bi bi-link-45deg"></i> Fetch RDM Links
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="addDemoDeploymentMappings()">
                            <i class="bi bi-gear"></i> Test Deployment Links
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="showStorageInfo()">
                            <i class="bi bi-database"></i> Storage Info
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportNodeData()">
                            <i class="bi bi-download"></i> Export
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshNodeDetails()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Filter Panel -->
                <div id="filterPanel" class="card-dark mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> Filter Nodes</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label small">Owner</label>
                            <select class="form-select form-select-sm" id="ownerFilter" onchange="applyFilters()">
                                <option value="">All Owners</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label small">Cluster</label>
                            <select class="form-select form-select-sm" id="clusterFilter" onchange="applyFilters()">
                                <option value="">All Clusters</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label small">Memory</label>
                            <select class="form-select form-select-sm" id="memoryFilter" onchange="applyFilters()">
                                <option value="">All Memory</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-sm btn-outline-warning mt-4" onclick="clearFilters()">
                                <i class="bi bi-arrow-clockwise"></i> Clear All
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="nodeDetailsGrid" class="row">
                    <!-- Node cards will be populated here -->
                </div>
                <div id="nodeDetailsLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading node details...</p>
                </div>
                <div id="nodeDetailsError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i>
                    <span id="nodeDetailsErrorMessage">Failed to load node details</span>
                </div>
            </div>
        </div>
        
        <!-- Section 5: Performance Tester -->
        <div id="perfTesterSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-speedometer2" style="color: var(--accent-orange);"></i>
                    Performance Tester
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));">BroadcastChannel</span>
                </h2>
                <p>Simulate concurrent users with real browser tabs. Uses BroadcastChannel API to sync interactions across tabs.</p>
            </div>
            
            <!-- URL & Tab Controls -->
            <div class="card-dark">
                <div class="perf-controls">
                    <div class="perf-control-group" style="flex: 2;">
                        <label><i class="bi bi-globe"></i> Target URL:</label>
                        <input type="text" class="form-control" id="perfTargetUrl" 
                               placeholder="https://your-site.com" value="">
                    </div>
                    
                    <div class="perf-control-group">
                        <label><i class="bi bi-people"></i> Tabs:</label>
                        <select class="form-select" id="perfTabCount" style="width: auto;">
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4" selected>4</option>
                            <option value="6">6</option>
                            <option value="8">8</option>
                        </select>
                    </div>
                    
                    <div class="perf-sync-indicator" id="perfSyncIndicator">
                        <i class="bi bi-broadcast"></i>
                        <span id="perfSyncStatus">Ready</span>
                        <span class="badge bg-secondary ms-2" id="perfConnectedCount">0 connected</span>
                    </div>
                </div>
                
                <div class="d-flex gap-3 flex-wrap mt-3">
                    <button class="btn btn-primary" onclick="openChildTabs()">
                        <i class="bi bi-window-plus me-2"></i> Open Child Tabs
                    </button>
                    <button class="btn btn-success" id="perfStartBtn" onclick="startBroadcastTest()">
                        <i class="bi bi-play-fill me-2"></i> Start Recording
                    </button>
                    <button class="btn btn-danger" id="perfStopBtn" onclick="stopBroadcastTest()" disabled>
                        <i class="bi bi-stop-fill me-2"></i> Stop
                    </button>
                    <button class="btn btn-outline-warning" onclick="broadcastNavigate()">
                        <i class="bi bi-arrow-right-circle me-2"></i> Navigate All Tabs
                    </button>
                    <button class="btn btn-outline-secondary" onclick="closeChildTabs()">
                        <i class="bi bi-x-circle me-2"></i> Close Child Tabs
                    </button>
                    <button class="btn btn-outline-secondary" onclick="exportPerfResults()">
                        <i class="bi bi-download me-2"></i> Export Results
                    </button>
                </div>
                
                <div class="mt-3 p-3" style="background: rgba(255,165,0,0.1); border-radius: 8px; border: 1px solid rgba(255,165,0,0.3);">
                    <small class="text-warning">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>How it works:</strong> Click "Open Child Tabs" to spawn browser tabs. 
                        Each tab loads a child script that listens for BroadcastChannel messages. 
                        Click "Start Recording" then interact with any tab - actions sync to all tabs.
                    </small>
                </div>
            </div>
            
            <!-- Live Metrics Dashboard -->
            <div class="card-dark">
                <h5><i class="bi bi-graph-up"></i> Live Metrics Dashboard</h5>
                <div class="perf-metrics-grid" id="perfMetricsGrid">
                    <div class="perf-metric-card good" id="metricConnectedTabs">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Connected Tabs</div>
                    </div>
                    <div class="perf-metric-card" id="metricAvgLatency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Sync Latency</div>
                    </div>
                    <div class="perf-metric-card" id="metricP95Latency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">P95 Latency</div>
                    </div>
                    <div class="perf-metric-card" id="metricPageLoad">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Page Load</div>
                    </div>
                    <div class="perf-metric-card" id="metricFCP">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg FCP</div>
                    </div>
                    <div class="perf-metric-card" id="metricLCP">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg LCP</div>
                    </div>
                    <div class="perf-metric-card" id="metricMessagesSent">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Messages Sent</div>
                    </div>
                    <div class="perf-metric-card" id="metricErrors">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Errors</div>
                    </div>
                </div>
            </div>
            
            <!-- Connected Tabs Status -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-window-stack"></i> Connected Tabs</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="pingAllTabs()">
                        <i class="bi bi-arrow-repeat"></i> Ping All
                    </button>
                </div>
                <div class="perf-tabs-grid" id="perfTabsGrid">
                    <div class="text-secondary text-center py-4">
                        <i class="bi bi-window-plus" style="font-size: 2rem;"></i>
                        <p class="mt-2 mb-0">No child tabs connected. Click "Open Child Tabs" to start.</p>
                    </div>
                </div>
            </div>
            
            <!-- Event Log -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Event Log</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearPerfEventLog()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="perf-event-log" id="perfEventLog">
                    <div class="perf-event-item">
                        <span class="perf-event-time">--:--:--</span>
                        <span class="perf-event-type">INIT</span>
                        <span class="perf-event-detail">BroadcastChannel tester ready. Open child tabs and start recording.</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Section 4: Mirror Mode Browser Automation -->
        <div id="playwrightSection" class="section section-hidden">
            <div class="content-header">
                <h2>
                    <i class="bi bi-layers" style="color: var(--accent-purple);"></i>
                    Mirror Mode
                    <span class="badge" style="background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));">Playwright</span>
                </h2>
                <p>Opens a main browser window where you interact, and child browsers that mirror your actions in real-time.</p>
            </div>
            
            <!-- How it Works -->
            <div class="card-dark" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <h5><i class="bi bi-lightbulb"></i> How Mirror Mode Works</h5>
                <div class="row g-4 mt-2">
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;">ðŸ–¥ï¸</div>
                        <h6>1. Main Browser</h6>
                        <p class="small text-secondary mb-0">A visible Chrome window opens with your target site. This is where YOU interact.</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;">ðŸ“¡</div>
                        <h6>2. Actions Captured</h6>
                        <p class="small text-secondary mb-0">Every click, type, and scroll you make is captured and sent to child browsers.</p>
                    </div>
                    <div class="col-md-4 text-center">
                        <div style="font-size: 3rem;">ðŸ‘¥</div>
                        <h6>3. Mirrored</h6>
                        <p class="small text-secondary mb-0">Child browsers (headless) replicate your actions simultaneously.</p>
                    </div>
                </div>
            </div>
            
            <!-- Configuration -->
            <div class="card-dark">
                <h5><i class="bi bi-gear"></i> Configuration</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label"><i class="bi bi-globe"></i> Target URL</label>
                        <input type="text" class="form-control" id="mirrorTargetUrl" 
                               placeholder="https://your-site.com" value="">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"><i class="bi bi-people"></i> Child Browsers</label>
                        <select class="form-select" id="mirrorChildCount">
                            <option value="1">1</option>
                            <option value="2" selected>2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="8">8</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="mirrorHeadlessChildren" checked>
                            <label class="form-check-label" for="mirrorHeadlessChildren">Headless Children</label>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3 mt-2">
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="mirrorIgnoreSSL" checked>
                            <label class="form-check-label" for="mirrorIgnoreSSL">Ignore SSL Errors</label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-3 flex-wrap mt-4">
                    <button class="btn btn-success btn-lg" id="mirrorStartBtn" onclick="startMirrorMode()">
                        <i class="bi bi-play-fill me-2"></i> Start Mirror Mode
                    </button>
                    <button class="btn btn-danger btn-lg" id="mirrorStopBtn" onclick="stopMirrorMode()" disabled>
                        <i class="bi bi-stop-fill me-2"></i> Stop
                    </button>
                </div>
                
                <div id="mirrorStatusBar" class="mt-3 p-3" style="background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3); display: none;">
                    <div class="d-flex align-items-center gap-3">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span id="mirrorStatusText">Initializing...</span>
                    </div>
                </div>
            </div>
            
            <!-- Live Metrics -->
            <div class="card-dark" id="mirrorMetricsCard">
                <h5><i class="bi bi-graph-up"></i> Live Metrics</h5>
                <div class="perf-metrics-grid">
                    <div class="perf-metric-card good" id="mirrorMetricChildren">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Child Browsers</div>
                    </div>
                    <div class="perf-metric-card" id="mirrorMetricActions">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Actions Mirrored</div>
                    </div>
                    <div class="perf-metric-card" id="mirrorMetricLatency">
                        <div class="perf-metric-value">0ms</div>
                        <div class="perf-metric-label">Avg Mirror Latency</div>
                    </div>
                    <div class="perf-metric-card warn" id="mirrorMetricErrors">
                        <div class="perf-metric-value">0</div>
                        <div class="perf-metric-label">Errors</div>
                    </div>
                </div>
            </div>
            
            <!-- Live Event Log -->
            <div class="card-dark">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="bi bi-terminal"></i> Live Log</h5>
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearMirrorLog()">
                        <i class="bi bi-trash"></i> Clear
                    </button>
                </div>
                <div class="perf-event-log" id="mirrorEventLog" style="max-height: 400px;">
                    <div class="perf-event-item">
                        <span class="perf-event-time">--:--:--</span>
                        <span class="perf-event-type">INIT</span>
                        <span class="perf-event-detail">Mirror mode ready. Enter URL and click Start to launch browsers.</span>
            </div>
        </div>
    </div>

            <!-- Flow Diagram Results -->
            <div class="card-dark" id="analyzerFlowDiagram" style="display: none;">
                <h5><i class="bi bi-diagram-3"></i> Application Flow Diagram</h5>
                <div id="flowDiagramContent">
                    <!-- Flow diagram will be displayed here -->
                        </div>
                    </div>
                    </div>
                    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
</body>
</html>
